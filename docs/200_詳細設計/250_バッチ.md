# バッチ設計

## 1. ジョブ管理方針
大量のデータ処理（給与計算、一括インポート、レポート生成等）は非同期バッチとして実行し、`job_runs` および `job_run_events` テーブルで状況を管理します。

## 2. ジョブステータス遷移
- `running`: 実行中
- `success`: 正常終了
- `failed`: 異常終了（スタックトレース等を `result` または `job_run_events` に記録）
- `canceled`: ユーザーによる中断

## 3. 主要ジョブ種別

| ジョブ種別 | 内容 | 冪等性 |
| :--- | :--- | :--- |
| `payroll_calculation` | 勤怠集計と給与計算。`payslips` を生成。 | あり（再実行時は既存の未確定明細を上書き） |
| `payroll_finalize` | 明細を確定し、従業員へ公開。 | あり |
| `export_csv` | 各種データのCSV/Excel出力。 | なし（都度生成） |
| `import_csv` | 社員情報や一括打刻データの投入。 | 実装依存（通常は新規追加または更新） |

## 4. 実行の冪等性とリトライ
- **冪等性の担保**: 同一の `payroll_period_id` に対して複数回計算ジョブが走っても、データが重複しないように設計する（既存データを削除して再作成、またはUPDATE）。
- **再実行**: 失敗時は `job_runs.id` を指定して再実行可能にする。
- **排他制御**: 同一テナントで同一種の重いジョブ（給与計算等）が並列で走らないよう、開始時にステータスチェックを行う。

## 5. ロギング
- ジョブの進捗状況（例：「100/500人完了」）は `job_run_events` に `level=info` で記録する。
- 致命的なエラーは `level=error` で記録し、運用監視のアラート対象とする。
