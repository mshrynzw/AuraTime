# DB設計方針

## 1. マルチテナント（会社分離）
- **物理構造**: 1つのデータベース、1つのスキーマ（共有スキーマ方式）。
- **論理分離**: すべてのテーブルに `company_id uuid` を保持する。
- **セキュリティ**: 行レベルセキュリティ (RLS) の採用を推奨（未決定事項）。

## 2. 監査列とソフト削除
全テーブルで以下のカラムを必須とする。
- `created_at`: レコード作成日時。
- `created_by`: 作成ユーザーID。
- `updated_at`: 最終更新日時（トリガー `trg_set_updated_at` で自動更新）。
- `updated_by`: 更新ユーザーID。
- `deleted_at`: 削除日時。値があれば削除済みとみなす（ソフト削除）。
- `deleted_by`: 削除ユーザーID。

## 3. ID生成方針
- **UUID v7**: すべてのテーブルの主キー（`id`）には **UUID v7** を使用する。
  - **利点**: タイムスタンプベースのため、時系列順にソート可能。勤怠データやログの範囲検索が効率的。
  - **実装**: PostgreSQL関数 `gen_uuid_v7()` を定義し、デフォルト値として使用。
  - **RFC準拠**: RFC 4122に準拠した標準形式。
- **外部露出**: APIで返却するIDもUUID v7とし、推測可能な連番（シークエンス）は避ける。

## 4. テーブル命名規則

すべてのテーブル名には、テーブルの種別を示すプレフィックスを付与する。

| プレフィックス | 意味 | 用途 | 例 |
|:---|:---|:---|:---|
| `m_` | Master（マスタ） | マスタデータ。比較的変更頻度が低く、参照用のデータ | `m_companies`, `m_users`, `m_groups`, `m_employees` |
| `t_` | Transaction（トランザクション） | 業務トランザクションデータ。日々の業務で作成・更新されるデータ | `t_time_records`, `t_leave_requests`, `t_payslips`, `t_job_runs` |
| `h_` | History（履歴） | 履歴データ。時系列で管理される履歴情報 | `h_time_clock_events`, `h_employee_groups`, `h_compensation_plans`, `h_audit_logs`, `h_job_run_events`, `h_approval_steps` |
| `r_` | Relation（リレーション） | 関連テーブル。多対多の関係や明細行を表すテーブル | `r_company_memberships`, `r_shift_assignments`, `r_payslip_lines`, `r_payment_lines` |

### 分類の判断基準

- **マスタ (`m_`)**: 会社、ユーザー、部署、従業員、休暇種別、給与項目など、基本的な参照データ
- **トランザクション (`t_`)**: 勤怠レコード、休暇申請、給与明細、ジョブ実行など、業務で発生するデータ
- **履歴 (`h_`)**: 打刻イベント、所属履歴、報酬履歴、監査ログ、承認ステップなど、時系列で追跡するデータ
- **リレーション (`r_`)**: 多対多の関係や、親テーブルに対する明細行を表すテーブル

### 命名例

```
m_companies          -- 会社マスタ
m_users              -- ユーザーマスタ
m_groups             -- グループマスタ（部署等）
m_employees          -- 従業員マスタ
m_leave_types        -- 休暇種別マスタ
m_shift_templates    -- シフトテンプレートマスタ
m_pay_items          -- 給与項目マスタ
m_payroll_calendars  -- 給与カレンダーマスタ

t_time_records       -- 勤怠レコード
t_leave_requests     -- 休暇申請
t_approval_requests  -- 承認リクエスト
t_payslips           -- 給与明細
t_payments           -- 支払バッチ
t_payroll_periods    -- 給与期間
t_job_runs           -- ジョブ実行（トランザクション）

h_time_clock_events  -- 打刻イベント（生ログ）
h_job_run_events     -- ジョブ実行イベント（履歴）
h_employee_groups    -- 従業員所属履歴
h_compensation_plans -- 報酬条件履歴
h_audit_logs         -- 監査ログ
h_approval_steps     -- 承認ステップ（履歴）

r_company_memberships -- 会社所属（リレーション）
r_shift_assignments   -- シフト割当（リレーション）
r_payslip_lines       -- 給与明細行（リレーション）
r_payment_lines       -- 支払バッチ行（リレーション）
r_shift_break_templates -- シフト休憩テンプレート（リレーション）
```

## 5. 索引（インデックス）方針
- **基本**: `company_id` を第1キーとする複合インデックスを多用する。
- **部分インデックス (Partial Index)**:
    - ソフト削除を考慮し、`WHERE deleted_at IS NULL` を付けたユニーク制約を推奨。
    - 例: `CREATE UNIQUE INDEX uq_m_users_email ON m_users(email) WHERE deleted_at IS NULL;`
- **外部キー**: すべての関係に対して外部キー制約（FOREIGN KEY）を設定し、参照整合性を担保する。

## 6. テーブル用途概要（抜粋）

| テーブル群 | 主要な用途 |
| :--- | :--- |
| **m_companies / m_users** | テナントおよび全システムユーザーのマスタ。 |
| **m_groups** | 部署、チーム、勤務地、コストセンターを統合。 |
| **m_employees / h_employee_groups** | 従業員情報と、どのグループにいつ所属しているかの履歴。 |
| **h_time_clock_events** | 打刻の生データ（ソース、位置情報等）。 |
| **t_time_records** | 日次集計データ。承認、ロック、給与計算の対象。 |
| **t_payslips / r_payslip_lines** | 給与明細。計算結果の静的スナップショット。 |
| **h_audit_logs** | データの変更履歴（Before/After）。 |
| **t_job_runs** | 非同期ジョブの管理。 |

## 7. 制約方針
- **CHECK制約**: ステータス値、金額の非負数チェック等に積極的に利用する。
- **NOT NULL**: 必須項目には必ず付与し、アプリケーション側での null 考慮漏れを防ぐ。
- **DEFERRABLE**: 循環参照（例：UserとCompanyの相互作成）に対応するため、初期データ投入等で制約チェックを遅延可能にする。

## 8. 主要な値の定義

### 打刻イベント (h_time_clock_events)
打刻の証跡として、以下の値を管理する。

| カラム | 値の例（区分） | 内容 |
| :--- | :--- | :--- |
| **type** | `in`, `out`, `break_in`, `break_out` | 打刻の種別（出勤、退勤、休憩入、休憩戻）。 |
| **source** | `web`, `mobile`, `ic_card`, `admin` | 打刻の入力元。不正検知や証跡として利用。注: `ic_card`は将来対応。 |
| **note** | 自由記述、位置情報、IPアドレス等 | 打刻時の補足情報。遅延理由や、システムによる自動記録。 |

### ステータス値の定義
システムフローを制御する主要なステータス値。

| テーブル | カラム | 値（区分） | 意味 |
| :--- | :--- | :--- | :--- |
| **m_users** | status | `active`, `inactive`, `locked` | アカウントの状態。 |
| **t_time_records** | status | `draft`, `submitted`, `approved`, `rejected`, `locked` | 日次勤怠の状態。lockedは月次締め後。 |
| **t_leave_requests**| status | `draft`, `submitted`, `approved`, `rejected`, `canceled` | 休暇申請の状態。 |
| **t_approval_requests** | status | `pending`, `approved`, `rejected`, `canceled` | 承認フロー全体の進捗。 |
| **h_approval_steps** | status | `pending`, `approved`, `rejected`, `skipped` | 個別の承認ステップの状態。 |
| **t_payroll_periods**| status | `open`, `closed`, `calculated`, `finalized` | 給与期間の状態。finalizedで明細公開。 |
| **t_payslips** | status | `draft`, `confirmed`, `paid` | 給与明細の状態。 |
| **t_payments** | status | `scheduled`, `processing`, `done`, `failed` | 支払バッチの状態。 |
| **t_job_runs** | status | `running`, `success`, `failed`, `canceled` | 非同期ジョブの実行状態。 |

### ポリモーフィック関連 (target_type)
承認や監査ログなど、複数のテーブルを横断的に扱うための識別子。

| カラム | 値の例 | 内容 |
| :--- | :--- | :--- |
| **target_type** (承認) | `time_record`, `leave_request` | 何に対する承認申請か（勤怠、休暇等）。 |
| **target_type** (監査) | `m_users`, `m_employees`, `h_compensation_plans`, etc | どのテーブルのデータに対する変更操作か。 |

### 権限と役割 (role)
システム上の操作権限と組織内での役割を分離して管理する。

| カラム | 値の例 | 内容 |
| :--- | :--- | :--- |
| **role** (membership) | `system_admin`, `admin`, `manager`, `employee` | システム上の操作権限（認可）を定義。 |
| **role_in_group** | `leader`, `member` | 部署やチーム内での役割。承認ルートの自動決定等に利用。 |

## 9. 全テーブル定義

以下、すべてのテーブルとその列名を物理名、論理名、備考を含めて記載します。すべてのテーブルには共通して監査列（`id`, `company_id`, `created_at`, `created_by`, `updated_at`, `updated_by`, `deleted_at`, `deleted_by`）が含まれます。

### 9.1. マスタテーブル (m_)

#### m_companies（会社=テナント）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 会社ID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `name` | 会社名 | text NOT NULL |
| `code` | 会社コード | text NOT NULL, UNIQUE (WHERE deleted_at IS NULL) |
| `timezone` | タイムゾーン | text NOT NULL, DEFAULT 'Asia/Tokyo' |
| `currency` | 通貨 | text NOT NULL, DEFAULT 'JPY' |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### m_users（ユーザー）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | ユーザーID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `email` | メールアドレス | text NOT NULL, UNIQUE (WHERE deleted_at IS NULL) |
| `family_name` | 姓 | text NOT NULL |
| `first_name` | 名 | text NOT NULL |
| `family_name_kana` | 姓（カナ） | text |
| `first_name_kana` | 名（カナ） | text |
| `status` | 状態 | text NOT NULL, DEFAULT 'active' (active\|inactive\|locked) |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### m_groups（部署/勤務地/チーム/コストセンター等の統合）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | グループID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `type` | グループ種別 | text NOT NULL (department\|work_location\|team\|cost_center\|custom) |
| `name` | グループ名 | text NOT NULL |
| `code` | グループコード | text, UNIQUE (company_id, type, code WHERE deleted_at IS NULL AND code IS NOT NULL) |
| `parent_group_id` | 親グループID | uuid, FK m_groups(id) |
| `sort_order` | 表示順 | int NOT NULL, DEFAULT 0 |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### m_employees（従業員）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 従業員ID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `user_id` | ユーザーID（ログイン紐付け） | uuid, FK m_users(id) |
| `employee_no` | 社員番号 | text NOT NULL, UNIQUE (company_id, employee_no WHERE deleted_at IS NULL) |
| `employment_type` | 雇用区分 | text NOT NULL (fulltime\|parttime\|contract) |
| `hire_date` | 入社日 | date NOT NULL |
| `termination_date` | 退職日 | date |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### m_shift_templates（シフトテンプレート）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | シフトテンプレートID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `name` | 名称 | text NOT NULL |
| `default_start` | 開始時刻（規定） | time |
| `default_end` | 終了時刻（規定） | time |
| `break_minutes` | 休憩分（規定） | int NOT NULL, DEFAULT 0 |
| `is_night_shift` | 夜勤フラグ | boolean NOT NULL, DEFAULT false |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### m_leave_types（休暇種別）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 休暇種別ID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `name` | 休暇名 | text NOT NULL |
| `code` | 休暇コード | text NOT NULL, UNIQUE (company_id, code WHERE deleted_at IS NULL) |
| `is_paid` | 有給フラグ | boolean NOT NULL, DEFAULT false |
| `requires_approval` | 承認要否 | boolean NOT NULL, DEFAULT true |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### m_payroll_calendars（給与カレンダー）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 給与カレンダーID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `name` | 名称 | text NOT NULL |
| `closing_day` | 締日 | int NOT NULL (1-31 or 0=EOM) |
| `payday_day` | 支払日 | int NOT NULL (1-31 or 0=EOM) |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### m_pay_items（給与項目）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 給与項目ID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `code` | 項目コード | text NOT NULL, UNIQUE (company_id, code WHERE deleted_at IS NULL) |
| `name` | 項目名 | text NOT NULL |
| `type` | 項目種別 | text NOT NULL (earning\|deduction\|employer_cost) |
| `taxable` | 課税対象フラグ | boolean NOT NULL, DEFAULT true |
| `sort_order` | 表示順 | int NOT NULL, DEFAULT 0 |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

### 9.2. トランザクションテーブル (t_)

#### t_time_records（勤怠レコード）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 勤怠レコードID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `employee_id` | 従業員ID | uuid NOT NULL, FK m_employees(id) |
| `work_date` | 勤務日 | date NOT NULL, UNIQUE (company_id, employee_id, work_date WHERE deleted_at IS NULL) |
| `start_at` | 開始日時 | timestamptz |
| `end_at` | 終了日時 | timestamptz |
| `break_minutes` | 休憩分 | int NOT NULL, DEFAULT 0 |
| `work_minutes` | 労働分 | int NOT NULL, DEFAULT 0 |
| `overtime_minutes` | 残業分 | int NOT NULL, DEFAULT 0 |
| `night_minutes` | 深夜分 | int NOT NULL, DEFAULT 0 |
| `status` | 状態 | text NOT NULL, DEFAULT 'draft' (draft\|submitted\|approved\|rejected\|locked) |
| `submitted_by` | 申請者ユーザーID | uuid, FK m_users(id) DEFERRABLE |
| `submitted_at` | 申請日時 | timestamptz |
| `approved_by` | 承認者ユーザーID | uuid, FK m_users(id) DEFERRABLE |
| `approved_at` | 承認日時 | timestamptz |
| `group_id` | コストセンターID | uuid, FK m_groups(id), CHECK制約: type = cost_center のみ許可 |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### t_approval_requests（承認リクエスト）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 承認リクエストID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `target_type` | 対象種別 | text NOT NULL (time_record\|leave_request等) |
| `target_id` | 対象ID | uuid NOT NULL |
| `requester_user_id` | 申請者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `current_approver_user_id` | 現在承認者ユーザーID | uuid, FK m_users(id) DEFERRABLE |
| `status` | 状態 | text NOT NULL, DEFAULT 'pending' (pending\|approved\|rejected\|canceled) |
| `requested_at` | 申請日時 | timestamptz NOT NULL |
| `resolved_at` | 確定日時 | timestamptz |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### t_leave_requests（休暇申請）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 休暇申請ID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `employee_id` | 従業員ID | uuid NOT NULL, FK m_employees(id) |
| `leave_type_id` | 休暇種別ID | uuid NOT NULL, FK m_leave_types(id) |
| `start_date` | 開始日 | date NOT NULL |
| `end_date` | 終了日 | date NOT NULL |
| `days` | 日数 | numeric(6,2) NOT NULL |
| `status` | 状態 | text NOT NULL, DEFAULT 'draft' (draft\|submitted\|approved\|rejected\|canceled) |
| `reason` | 理由 | text |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### t_payroll_periods（給与期間）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 給与期間ID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `payroll_calendar_id` | 給与カレンダーID | uuid NOT NULL, FK m_payroll_calendars(id) |
| `period_start` | 期間開始日 | date NOT NULL |
| `period_end` | 期間終了日 | date NOT NULL |
| `closing_date` | 締日（実日） | date NOT NULL |
| `pay_date` | 支払日（実日） | date NOT NULL |
| `status` | 状態 | text NOT NULL, DEFAULT 'open' (open\|closed\|calculated\|finalized) |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### t_payslips（給与明細）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 給与明細ID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `payroll_period_id` | 給与期間ID | uuid NOT NULL, FK t_payroll_periods(id) |
| `employee_id` | 従業員ID | uuid NOT NULL, FK m_employees(id) |
| `status` | 状態 | text NOT NULL, DEFAULT 'draft' (draft\|confirmed\|paid) |
| `gross` | 総支給 | numeric(12,2) NOT NULL, DEFAULT 0 |
| `total_deduction` | 控除合計 | numeric(12,2) NOT NULL, DEFAULT 0 |
| `net` | 差引支給額 | numeric(12,2) NOT NULL, DEFAULT 0 |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### t_payments（支払バッチ）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 支払バッチID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `payroll_period_id` | 給与期間ID | uuid NOT NULL, FK t_payroll_periods(id) |
| `pay_date` | 支払日 | date NOT NULL |
| `method` | 支払方法 | text NOT NULL (bank_transfer\|cash) |
| `status` | 状態 | text NOT NULL, DEFAULT 'scheduled' (scheduled\|processing\|done\|failed) |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### t_job_runs（ジョブ実行）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | ジョブ実行ID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `job_type` | ジョブ種別 | text NOT NULL (payroll_calculation\|payroll_finalize\|export_csv\|import_csv等) |
| `status` | 状態 | text NOT NULL, DEFAULT 'running' (running\|success\|failed\|canceled) |
| `request_id` | リクエストID | text |
| `started_at` | 開始日時 | timestamptz NOT NULL |
| `finished_at` | 終了日時 | timestamptz |
| `params` | パラメータ | jsonb |
| `result` | 結果 | jsonb |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

### 9.3. 履歴テーブル (h_)

#### h_employee_groups（従業員所属履歴）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 従業員所属履歴ID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `employee_id` | 従業員ID | uuid NOT NULL, FK m_employees(id) |
| `group_id` | グループID | uuid NOT NULL, FK m_groups(id) |
| `role_in_group` | グループ内役割 | text NOT NULL, DEFAULT 'member' (leader\|member) |
| `valid_from` | 有効開始日 | date NOT NULL |
| `valid_to` | 有効終了日 | date |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### h_time_clock_events（打刻イベント）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 打刻イベントID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `employee_id` | 従業員ID | uuid NOT NULL, FK m_employees(id) |
| `happened_at` | 発生日時 | timestamptz NOT NULL |
| `type` | 打刻種別 | text NOT NULL (in\|out\|break_in\|break_out) |
| `source` | 入力元 | text NOT NULL (web\|mobile\|ic_card\|admin), ic_cardは将来対応 |
| `note` | 備考 | text (遅延理由、位置情報等) |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### h_approval_steps（承認ステップ）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 承認ステップID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `approval_request_id` | 承認リクエストID | uuid NOT NULL, FK t_approval_requests(id) |
| `step_no` | ステップ番号 | int NOT NULL, UNIQUE (approval_request_id, step_no WHERE deleted_at IS NULL) |
| `approver_user_id` | 承認者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `status` | 状態 | text NOT NULL, DEFAULT 'pending' (pending\|approved\|rejected\|skipped) |
| `acted_at` | 操作日時 | timestamptz |
| `comment` | コメント | text |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### h_compensation_plans（報酬条件履歴）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 報酬条件履歴ID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `employee_id` | 従業員ID | uuid NOT NULL, FK m_employees(id) |
| `pay_type` | 給与形態 | text NOT NULL (monthly\|hourly) |
| `base_salary` | 基本給（月給） | numeric(12,2) |
| `hourly_rate` | 時給 | numeric(12,2) |
| `overtime_rate` | 残業単価（係数/金額） | numeric(12,2) |
| `night_rate` | 深夜単価（係数/金額） | numeric(12,2) |
| `effective_from` | 適用開始日 | date NOT NULL |
| `effective_to` | 適用終了日 | date |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### h_audit_logs（監査ログ）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 監査ログID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `actor_user_id` | 実行者ユーザーID | uuid, FK m_users(id) DEFERRABLE |
| `action` | 操作 | text NOT NULL |
| `target_type` | 対象テーブル名 | text NOT NULL (m_users\|m_employees等) |
| `target_id` | 対象ID | uuid NOT NULL |
| `before_data` | 変更前データ | jsonb |
| `after_data` | 変更後データ | jsonb |
| `request_id` | リクエストID | text |
| `happened_at` | 発生日時 | timestamptz NOT NULL |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### h_job_run_events（ジョブ実行イベント）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | ジョブ実行イベントID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `job_run_id` | ジョブ実行ID | uuid NOT NULL, FK t_job_runs(id) |
| `level` | レベル | text NOT NULL (info\|warn\|error) |
| `message` | メッセージ | text NOT NULL |
| `metadata` | メタデータ | jsonb |
| `happened_at` | 発生日時 | timestamptz NOT NULL |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

### 9.4. リレーションテーブル (r_)

#### r_company_memberships（会社所属）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 会社所属ID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id), UNIQUE (company_id, user_id WHERE deleted_at IS NULL) |
| `user_id` | ユーザーID | uuid NOT NULL, FK m_users(id) |
| `role` | 権限ロール | text NOT NULL (system_admin\|admin\|manager\|employee) |
| `joined_at` | 参加日時 | timestamptz |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### r_shift_break_templates（シフト休憩テンプレート）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | シフト休憩テンプレートID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `shift_template_id` | シフトテンプレートID | uuid NOT NULL, FK m_shift_templates(id) |
| `break_start` | 休憩開始時刻 | time NOT NULL, CHECK制約: break_start < break_end |
| `break_end` | 休憩終了時刻 | time NOT NULL |
| `break_name` | 休憩名 | text |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### r_shift_assignments（シフト割当）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | シフト割当ID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `employee_id` | 従業員ID | uuid NOT NULL, FK m_employees(id) |
| `work_date` | 勤務日 | date NOT NULL, UNIQUE (company_id, employee_id, work_date WHERE deleted_at IS NULL) |
| `shift_template_id` | シフトテンプレートID | uuid, FK m_shift_templates(id) |
| `group_id` | 勤務グループID | uuid, FK m_groups(id), CHECK制約: type = work_location のみ許可 |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### r_payslip_lines（給与明細行）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 給与明細行ID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `payslip_id` | 給与明細ID | uuid NOT NULL, FK t_payslips(id) |
| `pay_item_id` | 給与項目ID | uuid NOT NULL, FK m_pay_items(id) |
| `quantity` | 数量 | numeric(12,4) NOT NULL, DEFAULT 0 |
| `unit_amount` | 単価 | numeric(12,2) NOT NULL, DEFAULT 0 |
| `amount` | 金額 | numeric(12,2) NOT NULL, DEFAULT 0 |
| `note` | 備考 | text |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |

#### r_payment_lines（支払バッチ行）

| 物理名 | 論理名 | 備考 |
|:---|:---|:---|
| `id` | 支払バッチ行ID | uuid PRIMARY KEY, DEFAULT gen_uuid_v7() |
| `company_id` | 会社ID | uuid NOT NULL, FK m_companies(id) |
| `payment_id` | 支払バッチID | uuid NOT NULL, FK t_payments(id) |
| `payslip_id` | 給与明細ID | uuid NOT NULL, FK t_payslips(id) |
| `amount` | 支払金額 | numeric(12,2) NOT NULL |
| `created_at` | 作成日時 | timestamptz NOT NULL, DEFAULT now() |
| `created_by` | 作成者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `updated_at` | 更新日時 | timestamptz NOT NULL, DEFAULT now(), トリガーで自動更新 |
| `updated_by` | 更新者ユーザーID | uuid NOT NULL, FK m_users(id) DEFERRABLE |
| `deleted_at` | 削除日時（ソフト削除） | timestamptz |
| `deleted_by` | 削除者ユーザーID | uuid, FK m_users(id) DEFERRABLE |
