# フロントエンド設計（PWA）

## 1. PWA（Progressive Web App）の採用

### 採用理由
本システムは **PWA（Progressive Web App）** を採用し、Webアプリケーションとしてモバイルアプリと同等の体験を提供します。

- **通知機能**: プッシュ通知による勤怠リマインダー、承認待ち通知、給与明細公開通知など
- **モバイルアプリとしての利用**: ホーム画面への追加により、ネイティブアプリと同様の操作感を実現
- **オフライン対応**: 打刻データの一時保存や、キャッシュされた画面の閲覧が可能
- **開発・保守の効率化**: ネイティブアプリ（iOS/Android）の個別開発が不要

### 技術スタック
- **フレームワーク**: Next.js（React）
- **PWA実装**: 
  - **推奨**: Next.js公式のPWAサポート（App Router）を活用
    - Next.js 13+のApp Routerを使用
    - `manifest.json`を`app`ディレクトリに配置
    - Service Workerを手動で実装（`public/sw.js`など）
    - 詳細: [Next.js公式ドキュメント](https://nextjs.org/docs/app/guides/progressive-web-apps)
  - **代替**: `@ducanh2912/next-pwa`（TypeScript対応、積極的にメンテナンスされている）
  - **非推奨**: `next-pwa`は使用しない（2年以上メンテナンスされていない、Next.js 15以降と非互換）
- **通知**: Web Push API
- **ストレージ**: IndexedDB（オフライン時のデータ保存）

## 2. Service Worker の実装方針

### 基本方針
- **キャッシュ戦略**: Network First（ネットワーク優先、フォールバックでキャッシュ）
- **更新頻度**: アプリ起動時にService Workerの更新をチェック
- **スコープ**: `/` 配下のすべてのリソースを対象

### キャッシュ対象
- **静的リソース**: HTML、CSS、JavaScript、画像、フォント
- **APIレスポンス**: 頻繁にアクセスされるマスタデータ（会社情報、ユーザー情報等）
- **除外**: リアルタイム性が重要なデータ（打刻イベント、承認ステータス等）はキャッシュしない

### 実装例（概念）
```javascript
// Service Worker のキャッシュ戦略
- 静的リソース: Cache First（キャッシュ優先）
- API（マスタ）: Network First with Cache Fallback
- API（トランザクション）: Network Only（キャッシュしない）
```

## 3. 通知機能（Push Notification）

### 通知の種類
| 通知種別 | トリガー | 対象ユーザー | 優先度 |
|:---|:---|:---|:---|
| **打刻リマインダー** | 設定時刻（出勤・退勤） | Employee | 低 |
| **承認待ち通知** | 承認リクエストが作成された時 | Manager, Admin | 高 |
| **承認結果通知** | 承認が完了した時 | Employee | 中 |
| **給与明細公開通知** | 給与明細が確定された時 | Employee | 高 |
| **休暇申請結果通知** | 休暇申請が承認/却下された時 | Employee | 中 |
| **システム通知** | 重要なシステムメッセージ | 全ユーザー | 高 |

### 通知の実装
- **バックエンド**: 通知送信API（`POST /api/v1/notifications/push`）
- **フロントエンド**: Service Worker で Push API を受信
- **認証**: 通知送信時は認証トークンを使用し、ユーザーごとの通知を保証

### 通知の許可フロー
1. ユーザーが通知を有効化（設定画面）
2. ブラウザの通知許可ダイアログを表示
3. 許可された場合、Push Subscription をバックエンドに登録
4. バックエンドが通知を送信可能になる

### 通知のセキュリティ
- **認証**: 通知送信時は必ず認証トークンを検証
- **マルチテナント**: `company_id` を検証し、他社への通知送信を防止
- **プライバシー**: 通知内容に機密情報（給与額等）を含めない

## 4. オフライン対応

### オフライン時の動作
- **打刻データの一時保存**: IndexedDB に保存し、オンライン復帰時に自動送信
- **画面の閲覧**: キャッシュされた画面はオフラインでも閲覧可能
- **データの同期**: オンライン復帰時に、未送信データを自動的に送信

### オフライン時の制限
- **新規データの作成**: 一部の機能（打刻等）は一時保存のみ
- **承認操作**: オフライン時は承認操作を実行できない（データ整合性のため）
- **給与明細の閲覧**: キャッシュされた明細のみ閲覧可能

### データ同期の実装
- **キューイング**: オフライン時の操作をキューに保存
- **自動再送**: オンライン復帰時にキューを順次送信
- **エラーハンドリング**: 送信失敗時はユーザーに通知し、手動再送を可能にする

## 5. インストール可能なアプリ

### マニフェストファイル（manifest.json）
```json
{
  "name": "AuraTime",
  "short_name": "AuraTime",
  "description": "勤怠・給与管理システム",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#0066cc",
  "icons": [
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "orientation": "portrait-primary",
  "scope": "/",
  "share_target": {
    "action": "/share",
    "method": "POST",
    "enctype": "multipart/form-data"
  }
}
```

### インストール要件
- **HTTPS必須**: PWAはHTTPS環境でのみ動作（localhostは開発時のみ例外）
- **Service Worker必須**: Service Workerが正常に登録されていること
- **マニフェスト必須**: 有効なmanifest.jsonが存在すること

### インストールプロンプト
- **自動表示**: ブラウザが自動的にインストールプロンプトを表示（条件を満たした場合）
- **手動インストール**: ブラウザメニューから「ホーム画面に追加」を選択可能

## 6. セキュリティ考慮事項

### Content Security Policy (CSP)
- **厳格なCSP**: XSS攻撃を防ぐため、厳格なContent Security Policyを設定
- **Service Worker**: Service Worker内でのスクリプト実行もCSPの対象

### 通知のセキュリティ
- **認証トークン**: 通知送信時は必ず認証トークンを検証
- **マルチテナント**: `company_id` を検証し、他社への通知送信を防止
- **通知内容**: 機密情報を含めない（給与額等は通知に含めず、アプリ内で確認を促す）

### オフライン時のデータ保護
- **暗号化**: IndexedDBに保存する機密データは暗号化を検討
- **有効期限**: オフライン時の一時保存データには有効期限を設定

## 7. パフォーマンス最適化

### リソースの最適化
- **コード分割**: Next.jsの動的インポートを活用し、必要なコードのみ読み込む
- **画像最適化**: Next.js Image コンポーネントを使用し、適切なサイズの画像を配信
- **フォント最適化**: フォントのプリロードとサブセット化

### キャッシュ戦略の最適化
- **静的リソース**: 長期キャッシュ（1年）を設定
- **APIレスポンス**: マスタデータは短期キャッシュ（1時間）、トランザクションデータはキャッシュしない

## 8. ブラウザ対応

### 対応ブラウザ
- **モバイル**: Chrome（Android）、Safari（iOS 16.4+）、Edge（Android）
- **デスクトップ**: Chrome、Edge、Firefox、Safari

### 機能の段階的対応
- **基本機能**: すべての対応ブラウザで動作
- **通知機能**: Chrome、Edge、Firefox（Safariは将来対応）
- **オフライン機能**: すべての対応ブラウザで動作

## 9. 開発・運用

### 実装方法

#### Next.js公式のPWAサポートを使用する場合（推奨）

**セットアップ手順:**

1. **マニフェストファイルの配置**
   - `app/manifest.ts` または `app/manifest.json` を作成
   - または `public/manifest.json` に配置し、`app/layout.tsx` でリンク

2. **Service Workerの実装**
   - `public/sw.js` にService Workerを実装
   - `app/layout.tsx` またはクライアントコンポーネントでService Workerを登録

3. **実装例（app/layout.tsx）**
   ```typescript
   import { useEffect } from 'react';
   
   export default function RootLayout({ children }) {
     useEffect(() => {
       if ('serviceWorker' in navigator) {
         navigator.serviceWorker.register('/sw.js');
       }
     }, []);
     
     return (
       <html>
         <head>
           <link rel="manifest" href="/manifest.json" />
         </head>
         <body>{children}</body>
       </html>
     );
   }
   ```

4. **詳細**: [Next.js公式ドキュメント - Progressive Web Apps](https://nextjs.org/docs/app/guides/progressive-web-apps)

#### `@ducanh2912/next-pwa`を使用する場合（代替案）

**セットアップ手順:**

1. **パッケージのインストール**
   ```bash
   npm install @ducanh2912/next-pwa
   ```

2. **next.config.jsの設定**
   ```javascript
   const withPWA = require('@ducanh2912/next-pwa').default({
     dest: 'public',
     disable: process.env.NODE_ENV === 'development', // 開発時は無効化
     register: true,
     skipWaiting: true,
   });

   module.exports = withPWA({
     // Next.jsの設定
   });
   ```

3. **詳細**: [@ducanh2912/next-pwa ドキュメント](https://ducanh-next-pwa.vercel.app/)

### 開発環境
- **Service Worker**: 開発時はService Workerのキャッシュを無効化可能にする
- **デバッグ**: Chrome DevToolsのApplicationタブでService Workerとキャッシュを確認
- **開発モード**: 開発時はPWA機能を無効化することを推奨（キャッシュによる影響を避けるため）

### 運用時の注意事項
- **Service Worker更新**: 新しいバージョンがデプロイされた際、ユーザーは次回アクセス時に自動更新
- **キャッシュクリア**: 重大な問題が発生した場合、Service Workerのキャッシュをクリアする機能を用意
- **バージョン管理**: Service Workerのバージョンを管理し、強制更新が必要な場合はバージョン番号を変更

## 10. 今後の拡張

### 将来対応予定
- **バックグラウンド同期**: バックグラウンドでのデータ同期
- **共有機能**: Web Share APIを活用したデータ共有
- **位置情報**: 打刻時の位置情報取得（ユーザー許可時）
- **ICカード連携**: ICカードリーダーとの連携（将来対応）
