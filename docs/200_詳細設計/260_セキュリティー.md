# セキュリティ設計

## 1. 認証と認可
- **認証**: 多要素認証 (MFA) の導入を推奨（特に管理者権限）。
- **認可 (RBAC)**: ロール（System Admin/Admin/Manager/Employee）に基づく厳密なアクセス制御。
- **マルチテナント隔離**: SQL実行層での `company_id` 指定漏れを防止するライブラリやフレームワーク（RLS等）の利用。

## 2. データ保護
- **通信暗号化**: 全経路において TLS 1.2 以上を必須とする。
- **保存データ暗号化**: RDS のディスク暗号化 (AES-256) を有効化。
- **パスワード**: 強力なハッシュアルゴリズム（Argon2, bcrypt等）を使用し、平文での保存は厳禁。
- **個人情報 (PII)**: 住所や銀行口座番号等の重要項目については、アプリケーション層での暗号化も検討する。

## 3. 防御策

### SQLインジェクション対策
- **バックエンド（Spring Boot）**: 
  - Spring Data JPAを使用（デフォルトでプリペアドステートメントが適用される）
  - 生SQLを使用する場合は、必ずプリペアドステートメントを使用
  - ユーザー入力を直接SQLクエリに埋め込まない
  - **注意**: SQLインジェクションはフロントエンド（Next.js）の問題ではなく、バックエンドの責任
- **フロントエンド（Next.js）**: 
  - 関係なし（SQLクエリはバックエンドで実行される）

### XSS（Cross-Site Scripting）対策
- **フロントエンド（Next.js）**: 
  - Reactの標準機能により、通常のレンダリングでは自動的にエスケープされる
  - `dangerouslySetInnerHTML`を使用する場合は、手動でサニタイズが必要
  - ユーザー入力データを表示する際は、適切なエスケープ処理を確認
- **バックエンド（Spring Boot）**: 
  - APIレスポンスに含まれるデータのサニタイズ（必要に応じて）
  - Content Security Policy (CSP) ヘッダーの設定を推奨

### CSRF（Cross-Site Request Forgery）対策
- **バックエンド（Spring Boot）**: 
  - Spring SecurityのCSRF保護を有効化（デフォルトで有効）
  - CSRFトークンの生成と検証
  - Cookieの`SameSite`属性を設定
- **フロントエンド（Next.js）**: 
  - APIリクエスト時にCSRFトークンを送信
  - Cookieの`SameSite`属性に応じた適切な設定
  - Next.js 13+のApp Routerでは、適切なCookie設定が必要

### レート制限
- **バックエンド（Spring Boot）**: 
  - ブルートフォース攻撃防止のため、ログイン試行やAPIリクエストへのレートリミットを適用
  - Spring SecurityのRate Limiting機能または専用ライブラリ（Bucket4j等）を使用
- **フロントエンド（Next.js）**: 
  - クライアント側でのレート制限は補助的なもの（改ざん可能なため、バックエンドでの検証が必須）

## 4. 監査・監視
- 特権ユーザーによるデータ変更はすべて `audit_logs` に記録し、定期的にレビューする。
- 異常なログイン試行や大量のデータダウンロードを検知・通知する。
