# DDL運用

## 1. マイグレーション管理

### 基本方針
- **ツール**: Flyway（Spring Boot標準）を用いたバージョン管理を必須とする。
- **本番環境**: 手動SQL実行は原則禁止。すべてマイグレーションツール経由で実行する。
- **開発環境**: 初期セットアップ時のみ手動実行を許可（後述）。

### Flywayの設定

#### 1. 依存関係の追加（build.gradle.kts）

```kotlin
dependencies {
    // Flyway
    implementation("org.flywaydb:flyway-core")
    implementation("org.flywaydb:flyway-database-postgresql")
}
```

#### 2. application.ymlの設定

```yaml
spring:
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
    validate-on-migrate: true
    baseline-version: 1
```

#### 3. マイグレーションファイルの配置

```
src/main/resources/db/migration/
  ├── V1__Initial_schema.sql
  ├── V2__Add_audit_logs.sql
  └── V3__Add_indexes.sql
```

**命名規則**: `V{バージョン番号}__{説明}.sql`
- バージョン番号は連番（1, 2, 3...）
- アンダースコア2つ（`__`）で区切る
- 説明は英数字とアンダースコアのみ

#### 4. 自動実行

Spring Bootアプリケーション起動時に、未適用のマイグレーションが自動的に実行されます。

### 運用フロー

#### 開発環境
1. 新しいマイグレーションファイルを作成（例: `V2__Add_new_table.sql`）
2. ローカルでテスト実行
3. Gitにコミット・プッシュ

#### 本番環境
1. アプリケーションをデプロイ
2. 起動時にFlywayが自動的に未適用のマイグレーションを検出・実行
3. **手動SQL実行は不要**

### 手動SQL実行が必要な場合（例外）

緊急時や特殊なケースのみ、以下の手順を踏む：

1. **事前承認**: 複数人でのレビューと承認
2. **バックアップ**: 実行前のRDSスナップショット取得
3. **記録**: 実行内容と理由をドキュメント化
4. **ロールバック計画**: 失敗時の復旧手順を準備
5. **実行**: 承認後、最小権限で実行
6. **検証**: 実行結果の確認
7. **マイグレーションファイル化**: 後からマイグレーションファイルとして記録（次回のデプロイで適用済みとして認識される）

## 2. 初期データ投入
- **Systemユーザー**: `created_by` / `updated_by` の NOT NULL 制約を満たすため、最初に `id` が固定されたシステム管理用ユーザー（例：system-bot）を作成する。
- **マスタ投入**: `leave_types` や `pay_items` のデフォルトセットをマイグレーション内で投入する。

## 3. ロールバック方針
- 原則、破壊的な変更（カラム削除等）は避け、追加・リネームによる前方互換性を維持する。
- どうしても必要な場合は、リリース前にバックアップを取得し、リストア手順を確立した上で実行する。

## 4. バックアップ・リストア
- AWS RDS の自動バックアップ（Point-in-Time Recovery）を有効化。
- 重要な変更（大規模データ移行等）の前には手動スナップショットを取得する。

## 5. RDS 固有設定
- タイムゾーンは `UTC` を基本とし、表示時に `companies.timezone` に合わせて変換する。
- 全文検索や地理情報が必要な場合は、適切な拡張（pg_bigm, PostGIS）の導入を検討する。
