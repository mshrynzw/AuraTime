# AuraTime 設計レビュー結果（Antigravity）

**レビュー実施日**: 2025年1月  
**レビューツール**: Antigravity  
**評価スコア**: 9 / 10  
**レビュー対象**: `docs/` ディレクトリ配下の全ファイル、`database/migrations/20260101_init.sql`

---

## 1. 総合評価

**評価スコア**: 9 / 10

**総合所見**: 
極めて高品質な設計です。PostgreSQLの高度な機能（UUID v7, 部分インデックス, JSONB, 配列, DEFERRABLE制約）を適切に活用しており、マルチテナントSaaSとしてスケーラビリティとデータ整合性を両立させています。特に「ソフト削除とユニーク制約の共存」や「循環参照の解決」といった、実務で躓きやすいポイントが完璧にカバーされています。唯一の懸念点は、ドキュメントで推奨されている「行レベルセキュリティ(RLS)」がSQLファイルには実装されていない点ですが、これは導入フェーズの判断として許容範囲です。

---

## 2. カテゴリ別評価

| カテゴリ | 評価 | コメント |
|:---|:---|:---|
| **設計の一貫性** | 良好 | DB設計書とDDLがプロパティレベルで完全に一致しています。プレフィックス規則（m_, t_, h_, r_）も徹底されています。 |
| **スキーマ妥当性** | 良好 | check_group_type関数を用いた参照整合性チェックなど、アプリケーションロジックに頼りすぎない堅牢な設計です。 |
| **セキュリティ** | 良好 | 全テーブルへのcompany_id付与、UUID v7による推測防止など、基本は完璧です。RLS未実装のみ「要検討」です。 |
| **業務ロジック** | 良好 | 勤怠の予実管理、給与の履歴管理（h_compensation_plans）、汎用承認フローなど、要件を柔軟に満たせる構造です。 |
| **拡張性** | 良好 | m_groupsによる組織構造の統合や、jsonbを用いた監査ログ・ジョブ履歴など、将来の変化に強い設計です。 |
| **ドキュメント** | 良好 | 意図（なぜこの型か、なぜこの制約か）が明確に記述されており、実装者の迷いを排除できています。 |

---

## 3. 重大な問題 (Critical Issues)

**現在、致命的な問題（実装不可能、セキュリティホール）は見当たりません。**

---

## 4. 改善提案 (Improvements)

### [優先度: 高] 行レベルセキュリティ (RLS) の実装検討

**現状**: 
アプリケーション層での `WHERE company_id = ?` フィルタリングに依存しています。

**リスク**: 
実装ミスによる他社データ漏洩のリスクがゼロではありません。

**提案**: 
PostgreSQLの ROW LEVEL SECURITY ポリシーを定義し、DB層でもアクセス制御を行うことを強く推奨します。Spring Boot側でDB接続時に `SET app.current_company_id = '...'` のようにコンテキストを渡す実装が必要になります。

**対応方針**:
- Phase 0（基盤構築）完了後、Phase 1の実装前にRLSの実装を検討
- ドキュメント `docs/000_要件定義/010_決定事項_未決定事項.md` に記載済み
- 実装時の参考: [PostgreSQL RLS ドキュメント](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)

**関連ドキュメント**:
- [`../200_詳細設計/221_DB設計.md`](../200_詳細設計/221_DB設計.md) - マルチテナント分離の方針
- [`../200_詳細設計/260_セキュリティー.md`](../200_詳細設計/260_セキュリティー.md) - セキュリティ設計

---

### [優先度: 中] 監査ログのトリガー化

**現状**: 
`h_audit_logs` への書き込みタイミングが明示されていません（アプリ側でのINSERT想定と見受けられます）。

**提案**: 
データの変更を確実に捕捉するため、`m_` および `t_` テーブルに対して `AFTER INSERT/UPDATE/DELETE` トリガーを設定し、DBレベルで自動的に監査ログを作成する設計も検討に値します。ただし、`before_data/after_data` のJSON生成コストとのトレードオフになります。

**対応方針**:
- 初期実装ではSpring AOPによる監査ログ記録を採用（`docs/200_詳細設計/270_ログ.md`参照）
- 将来的にDBトリガー化を検討する場合は、パフォーマンステストを実施してから判断
- 実装時の参考: [PostgreSQL トリガー ドキュメント](https://www.postgresql.org/docs/current/triggers.html)

**関連ドキュメント**:
- [`../200_詳細設計/270_ログ.md`](../200_詳細設計/270_ログ.md) - ログ・監査設計

---

### [優先度: 低] m_groups の階層構造検証

**現状**: 
`parent_group_id` による自己参照ですが、循環参照（A->B->A）を防ぐ制約はありません。

**提案**: 
アプリケーション側でのチェックで十分ですが、厳密さを求めるなら RECURSIVE CTE を用いたチェック制約関数を追加可能です（ただし重いため推奨はしません）。

**対応方針**:
- アプリケーション層（Spring Boot）で循環参照チェックを実装
- グループ作成・更新時に、RECURSIVE CTEを使用して循環参照を検出
- パフォーマンスへの影響を考慮し、DB制約は追加しない

**関連ドキュメント**:
- [`../200_詳細設計/221_DB設計.md`](../200_詳細設計/221_DB設計.md) - m_groupsテーブル定義

---

## 5. 詳細レビュー

### 5.1 データベーススキーマ

#### 良い点 (Good)

1. **UUID v7の全面採用**
   - `pgcrypto` による生成関数もRFC準拠で実装されており、インデックス性能とソート可能性が担保されています。

2. **グループ統合 (m_groups)**
   - 部署、勤務地、コストセンターを１テーブルにまとめ、`type` で区別しつつ、利用側（`t_time_records` 等）で `check_group_type` 関数を使って型安全性を確保している点は非常に洗練されています。

3. **DEFERRABLE制約の活用**
   - `created_by` が `m_users` を参照する際の「卵が先か鶏が先か」問題を、`DEFERRABLE INITIALLY DEFERRED` でスマートに解決しています。

4. **部分インデックス**
   - `WHERE deleted_at IS NULL` を付与したユニーク制約により、論理削除されたレコードがユニーク制約の邪魔をしないようになっています。

#### 確認事項 (Check)

1. **t_payroll_periods の期間重複チェック**
   - `uq_t_payroll_periods_company_calendar_range` インデックスですが、期間の重なり（Overlay）まではチェックできていません（開始日と終了日が完全に一致する場合のみユニーク）。
   - 期間重複を防ぐには `EXCLUDE USING GIST (daterange(period_start, period_end, '[]') WITH &&)` の利用を検討してください。
   - 現状のB-Treeインデックスでは、部分的な期間重複（例: 4/1-4/30 と 4/15-5/15）を許容してしまいます。

   **対応方針**:
   - アプリケーション層で期間重複チェックを実装
   - または、GISTインデックスとEXCLUDE制約を追加（`btree_gist`拡張が必要）
   - 実装時の参考: [PostgreSQL EXCLUDE制約 ドキュメント](https://www.postgresql.org/docs/current/sql-createtable.html#SQL-CREATETABLE-EXCLUDE)

   **関連ドキュメント**:
   - [`../200_詳細設計/221_DB設計.md`](../200_詳細設計/221_DB設計.md) - t_payroll_periodsテーブル定義

### 5.2 その他

1. **API設計**
   - PUT/PATCHの使い分け定義が明確でRESTfulの原則に則っています。

2. **セキュリティ**
   - `company_id` をPayloadではなくTokenから取得する方針が徹底されており安全です。

---

## 6. 対応アクションアイテム

### 即座に対応不要（設計として問題なし）

- ✅ 全テーブルに`company_id`が必須で定義されている
- ✅ 全テーブルに監査列が定義されている
- ✅ 全テーブルの主キーにUUID v7が使用されている
- ✅ 外部キー制約が適切に設定されている
- ✅ ユニーク制約がソフト削除を考慮している
- ✅ インデックスが適切に設定されている
- ✅ マルチテナント分離の方針が明確に記載されている
- ✅ セキュリティ要件が明確に記載されている
- ✅ 未決定事項が明確に記載されている

### Phase 0（基盤構築）で検討

- [ ] **RLS実装の検討**（優先度: 高）
  - ドキュメント: `docs/000_要件定義/010_決定事項_未決定事項.md` に記載済み
  - 実装前にパフォーマンステストを実施

### Phase 1以降で実装

- [ ] **監査ログのトリガー化検討**（優先度: 中）
  - 初期はSpring AOPで実装
  - パフォーマンステスト後にDBトリガー化を検討

- [ ] **m_groupsの循環参照チェック**（優先度: 低）
  - アプリケーション層で実装（Spring Boot）
  - グループ作成・更新APIでチェック

- [ ] **t_payroll_periodsの期間重複チェック**（確認事項）
  - アプリケーション層で実装
  - または、GISTインデックスとEXCLUDE制約を追加

---

## 7. レビュー結果のまとめ

### 強み

1. **設計の一貫性**: DB設計書とDDLが完全に一致
2. **堅牢なスキーマ**: アプリケーションロジックに頼らないDB層の制約
3. **拡張性**: 将来の要件変更に対応できる柔軟な設計
4. **ドキュメント品質**: 実装者が迷わない明確な記載

### 改善点

1. **RLS実装**: DB層でのマルチテナント分離強化（優先度: 高）
2. **監査ログ**: DBトリガー化の検討（優先度: 中）
3. **階層構造**: 循環参照チェックの実装（優先度: 低）

### 総評

設計品質は非常に高く、実装に進む準備が整っています。改善提案は全て「より堅牢にするための追加検討事項」であり、現状の設計でも実装可能です。優先度の高いRLS実装については、Phase 0完了後に検討を開始することを推奨します。

---

## 8. レビュープロンプト

本レビューに使用したプロンプトは以下を参照してください：

- [`002_レビュープロンプト_Antigravity.md`](./002_レビュープロンプト_Antigravity.md)

---

**レビュー実施者**: Antigravity  
**レビュー日**: 2025年1月  
**次回レビュー推奨時期**: Phase 0（基盤構築）完了後
