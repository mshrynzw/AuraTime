# DB設計方針

## 1. マルチテナント（会社分離）
- **物理構造**: 1つのデータベース、1つのスキーマ（共有スキーマ方式）。
- **論理分離**: すべてのテーブルに `company_id uuid` を保持する。
- **セキュリティ**: 行レベルセキュリティ (RLS) の採用を推奨（未決定事項）。

## 2. 監査列とソフト削除
全テーブルで以下のカラムを必須とする。
- `created_at`: レコード作成日時。
- `created_by`: 作成ユーザーID。
- `updated_at`: 最終更新日時（トリガー `trg_set_updated_at` で自動更新）。
- `updated_by`: 更新ユーザーID。
- `deleted_at`: 削除日時。値があれば削除済みとみなす（ソフト削除）。
- `deleted_by`: 削除ユーザーID。

## 3. ID生成方針
- **UUID v7**: すべてのテーブルの主キー（`id`）には **UUID v7** を使用する。
  - **利点**: タイムスタンプベースのため、時系列順にソート可能。勤怠データやログの範囲検索が効率的。
  - **実装**: PostgreSQL関数 `gen_uuid_v7()` を定義し、デフォルト値として使用。
  - **RFC準拠**: RFC 4122に準拠した標準形式。
- **外部露出**: APIで返却するIDもUUID v7とし、推測可能な連番（シークエンス）は避ける。

## 4. 索引（インデックス）方針
- **基本**: `company_id` を第1キーとする複合インデックスを多用する。
- **部分インデックス (Partial Index)**:
    - ソフト削除を考慮し、`WHERE deleted_at IS NULL` を付けたユニーク制約を推奨。
    - 例: `CREATE UNIQUE INDEX uq_users_email ON users(email) WHERE deleted_at IS NULL;`
- **外部キー**: すべての関係に対して外部キー制約（FOREIGN KEY）を設定し、参照整合性を担保する。

## 5. テーブル用途概要（抜粋）

| テーブル群 | 主要な用途 |
| :--- | :--- |
| **companies / users** | テナントおよび全システムユーザーのマスタ。 |
| **groups** | 部署、チーム、勤務地、コストセンターを統合。 |
| **employees / employee_groups** | 従業員情報と、どのグループにいつ所属しているかの履歴。 |
| **time_clock_events** | 打刻の生データ（ソース、位置情報等）。 |
| **time_records** | 日次集計データ。承認、ロック、給与計算の対象。 |
| **payslips / payslip_lines** | 給与明細。計算結果の静的スナップショット。 |
| **audit_logs** | データの変更履歴（Before/After）。 |
| **job_runs** | 非同期ジョブの管理。 |

## 6. 制約方針
- **CHECK制約**: ステータス値、金額の非負数チェック等に積極的に利用する。
- **NOT NULL**: 必須項目には必ず付与し、アプリケーション側での null 考慮漏れを防ぐ。
- **DEFERRABLE**: 循環参照（例：UserとCompanyの相互作成）に対応するため、初期データ投入等で制約チェックを遅延可能にする。

## 7. 主要な値の定義

### 打刻イベント (time_clock_events)
打刻の証跡として、以下の値を管理する。

| カラム | 値の例（区分） | 内容 |
| :--- | :--- | :--- |
| **type** | `in`, `out`, `break_in`, `break_out` | 打刻の種別（出勤、退勤、休憩入、休憩戻）。 |
| **source** | `web`, `mobile`, `ic_card`, `admin` | 打刻の入力元。不正検知や証跡として利用。 |
| **note** | 自由記述、位置情報、IPアドレス等 | 打刻時の補足情報。遅延理由や、システムによる自動記録。 |

### ステータス値の定義
システムフローを制御する主要なステータス値。

| テーブル | カラム | 値（区分） | 意味 |
| :--- | :--- | :--- | :--- |
| **users** | status | `active`, `inactive`, `locked` | アカウントの状態。 |
| **time_records** | status | `draft`, `submitted`, `approved`, `rejected`, `locked` | 日次勤怠の状態。lockedは月次締め後。 |
| **leave_requests**| status | `draft`, `submitted`, `approved`, `rejected`, `canceled` | 休暇申請の状態。 |
| **approval_requests** | status | `pending`, `approved`, `rejected`, `canceled` | 承認フロー全体の進捗。 |
| **approval_steps** | status | `pending`, `approved`, `rejected`, `skipped` | 個別の承認ステップの状態。 |
| **payroll_periods**| status | `open`, `closed`, `calculated`, `finalized` | 給与期間の状態。finalizedで明細公開。 |
| **payslips** | status | `draft`, `confirmed`, `paid` | 給与明細の状態。 |
| **payments** | status | `scheduled`, `processing`, `done`, `failed` | 支払バッチの状態。 |
| **job_runs** | status | `running`, `success`, `failed`, `canceled` | 非同期ジョブの実行状態。 |

### ポリモーフィック関連 (target_type)
承認や監査ログなど、複数のテーブルを横断的に扱うための識別子。

| カラム | 値の例 | 内容 |
| :--- | :--- | :--- |
| **target_type** (承認) | `time_record`, `leave_request` | 何に対する承認申請か（勤怠、休暇等）。 |
| **target_type** (監査) | `users`, `employees`, `compensation_plans`, etc | どのテーブルのデータに対する変更操作か。 |

### 権限と役割 (role)
システム上の操作権限と組織内での役割を分離して管理する。

| カラム | 値の例 | 内容 |
| :--- | :--- | :--- |
| **role** (membership) | `system_admin`, `admin`, `manager`, `employee` | システム上の操作権限（認可）を定義。 |
| **role_in_group** | `leader`, `member` | 部署やチーム内での役割。承認ルートの自動決定等に利用。 |

