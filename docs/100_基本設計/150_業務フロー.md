# 業務フロー

## 1. 全体プロセスフロー

システム全体の標準的なサイクルは以下の通りです。

1.  **日次（発生）**:
    - 従業員が打刻を行う（`TIME_CLOCK_EVENTS` 生成）
    - システムが日次勤怠（`TIME_RECORDS`）を自動作成/更新
2.  **月次（確認・申請）**:
    - 従業員が1ヶ月分の勤怠を確認し、修正があれば申請・承認
    - 最終的に「日次勤怠の確定」を行う
3.  **締め（Admin）**:
    - Adminが給与期間（`PAYROLL_PERIODS`）を「締め（Closed）」にする
    - **[ロック]** 該当期間の `TIME_RECORDS` は一切の変更が不可となる
4.  **計算（Admin）**:
    - Adminが給与計算ジョブを実行（`job_runs` で非同期処理）
    - `compensation_plans`（単価）と勤怠集計を元に `payslips` を生成
5.  **確定・公開（Admin）**:
    - Adminが明細の内容を確認し「確定（Finalized）」にする
    - 従業員が給与明細を閲覧可能になる
6.  **支払（Admin）**:
    - 支払バッチ（`payments`）を作成し、振込データ等を出力
    - 振込完了後、ステータスを「完了」にする

## 2. 「生ログ」と「日次集計」の使い分け

| 特徴 | 打刻イベント (TIME_CLOCK_EVENTS) | 勤怠レコード (TIME_RECORDS) |
| :--- | :--- | :--- |
| **役割** | 事実の記録（証跡） | 計算の基礎（集計） |
| **データ量** | 1日複数（出・退・休憩など） | 1日1レコード |
| **変更可能性** | 原則不可（追記のみ） | 承認フローを経て修正可能 |
| **属性** | 位置情報、入力デバイス等 | 労働時間、残業時間、コストセンター |

## 3. 締めとデータのロック範囲

不整合を防ぐため、ステータスに応じて以下のロックが発生します。

| 状態 | ロックされる範囲 | 許可される操作 |
| :--- | :--- | :--- |
| **勤怠承認済み** | 該当日の `TIME_RECORDS` | 承認の取り消し（マネージャー以上） |
| **給与期間：締め(Closed)** | 期間内の全 `TIME_RECORDS`, `LEAVE_REQUESTS` | 給与計算の実行 |
| **給与明細：確定(Finalized)** | `compensation_plans` (過去分) | 明細の閲覧 |
| **支払：完了(Done)** | 該当する `payslips` | 特になし |

## 4. 差分再計算と修正フロー

給与確定後に過去の勤怠修正が必要になった場合：
1.  AdminまたはSystem Adminが対象期間の「締め」を一時解除（特権）
2.  勤怠を修正・再承認
3.  再計算を実行。前回の確定額との差分を「調整項目」として翌月以降に計上、または当月分を再発行（運用による選択）。
