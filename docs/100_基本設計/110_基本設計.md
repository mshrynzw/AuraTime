# 基本設計

## 1. 機能一覧

### 勤怠・シフト
- **打刻管理**: 出退勤、休憩入り/戻り（Web/モバイル、ICカードは将来対応）
- **日次集計**: 生ログからの労働時間（法定内、残業、深夜、休憩）自動算出
- **シフト管理**: シフトテンプレートの作成、個人別/日別シフト割当
- **コストセンター割当**: 勤務日ごとの費用計上先グループの指定

### 休暇・承認
- **休暇管理**: 有給、慶弔、欠勤等の申請・残数管理
- **汎用承認フロー**: 勤怠申請、休暇申請等の多段承認（ステップ管理）

### 給与・支払
- **給与計算**: 勤怠集計結果と単価設定に基づく自動計算
- **明細管理**: 給与明細の作成、確定、従業員公開
- **支払管理**: 振込バッチ作成、支払完了ステータス管理

### 監査・管理
- **監査ログ参照**: Adminによるデータ変更履歴の確認
- **ジョブ管理**: 重い処理（給与計算等）の進行状況確認、再実行

## 2. 画面一覧（主要）

| メニューカテゴリ | 画面名 | 主な対象ロール |
| :--- | :--- | :--- |
| **マイページ** | 打刻・ダッシュボード | Employee |
| | 日次勤怠一覧・修正申請 | Employee |
| | 給与明細確認 | Employee |
| **マネージャー** | チーム勤怠承認 | Manager |
| | シフト作成・割当 | Manager |
| **管理者** | 給与期間管理（締め） | Admin |
| | 給与計算・明細確定 | Admin |
| | 支払処理（FBデータ出力） | Admin |
| | 社員・グループ・単価マスタ | Admin |
| **システム管理** | 会社設定管理 | System Admin |
| | 契約・プラン管理 | System Admin |
| | 全ユーザー・権限管理 | System Admin |
| | 監査ログ・ジョブ履歴 | System Admin |

詳細な設計図については以下を参照してください。
- [画面遷移図 (Mermaid)](../200_詳細設計/230_UI_遷移図.mmd)
- [画面レイアウト案 (Mermaid)](../200_詳細設計/231_UI_レイアウト.mmd)

## 3. 権限モデルとアクセス範囲

権限（Role）は `company_memberships.role` で定義されます。

| ロール | アクセス範囲 |
| :--- | :--- |
| **System Admin** | 自社の全データ、全社の設定、全社の契約管理 |
| **Admin** | 自社の全データ、マスタ設定、給与計算、全社員の監査ログ |
| **Manager** | 所属グループおよび下位グループの部下の勤怠・承認 |
| **Employee** | 自身のデータ（打刻、申請、明細）のみ |

## 4. マルチテナント方針

### `company_id` による分離
- **全テーブル共通**: `company_id` カラムを必須とし、インデックスを付与する。
- **データアクセス**: アプリケーション層で、ログインユーザーの `company_id` 以外のデータにアクセスできないよう強制フィルタリングを行う。
- **改ざん防止**: APIリクエストのパラメータで `company_id` を受け取るのではなく、認証済みトークン（JWT等）から取得する。

### 組織・グループ統合（m_groups）
- 部署、勤務地、チーム、コストセンターはすべて `m_groups.type` で識別。
- 階層構造は `parent_group_id` による自己参照で実現。
- 従業員の所属は `h_employee_groups` で履歴管理（兼務対応）。

## 5. 技術スタック

### フロントエンド
- **フレームワーク**: Next.js（React）
- **PWA**: Progressive Web App を採用し、モバイルアプリと同等の体験を提供
  - 通知機能（プッシュ通知）
  - オフライン対応
  - ホーム画面への追加
- **詳細**: [フロントエンド設計](../200_詳細設計/232_フロントエンド設計.md) を参照

### バックエンド
- **フレームワーク**: Spring Boot（Java）
- **データベース**: PostgreSQL
- **認証**: JWT またはセッションベース認証
