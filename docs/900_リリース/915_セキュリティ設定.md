# セキュリティ設定手順

本ドキュメントでは、AuraTimeシステムのセキュリティ設定の手順を説明します。SSL証明書、WAF、セキュリティグループの詳細設定、IAMポリシーの最適化を行います。

## 前提条件

- [`910_AWS環境構築.md`](./910_AWS環境構築.md)の手順が完了していること
- [`912_アプリケーションデプロイ.md`](./912_アプリケーションデプロイ.md)の手順が完了していること
- 独自ドメインが設定済みであること（SSL証明書の取得に必要）
- 以下の環境変数が設定されていること：
  - `ALB_ARN`
  - `ALB_DNS`
  - `HOSTED_ZONE_ID`（Route53を使用する場合）

## 1. SSL/TLS証明書の設定（AWS Certificate Manager）

### 1.1 SSL証明書のリクエスト

```bash
# SSL証明書のリクエスト（DNS検証を使用）
CERT_ARN=$(aws acm request-certificate \
  --domain-name auratime.example.com \
  --subject-alternative-names "*.auratime.example.com" \
  --validation-method DNS \
  --region ap-northeast-1 \
  --tags Key=Name,Value=auratime-ssl-cert Key=Project,Value=AuraTime \
  --query 'CertificateArn' \
  --output text)

echo "Certificate ARN: $CERT_ARN"
```

### 1.2 DNS検証レコードの追加

```bash
# 検証用のCNAMEレコードを取得
VALIDATION_RECORDS=$(aws acm describe-certificate \
  --certificate-arn $CERT_ARN \
  --region ap-northeast-1 \
  --query 'Certificate.DomainValidationOptions[*].ResourceRecord' \
  --output json)

# Route53に検証レコードを追加
echo $VALIDATION_RECORDS | jq -r '.[] | "\(.Name) \(.Type) \(.Value)"' | while read name type value; do
  aws route53 change-resource-record-sets \
    --hosted-zone-id $HOSTED_ZONE_ID \
    --change-batch "{
      \"Changes\": [{
        \"Action\": \"CREATE\",
        \"ResourceRecordSet\": {
          \"Name\": \"$name\",
          \"Type\": \"$type\",
          \"TTL\": 300,
          \"ResourceRecords\": [{\"Value\": \"$value\"}]
        }
      }]
    }"
done
```

### 1.3 証明書の検証待機

```bash
# 証明書が検証されるまで待機（通常5-30分）
aws acm wait certificate-validated \
  --certificate-arn $CERT_ARN \
  --region ap-northeast-1
```

### 1.4 ALBへのHTTPSリスナーの追加

```bash
# HTTPSリスナーの作成
HTTPS_LISTENER=$(aws elbv2 create-listener \
  --load-balancer-arn $ALB_ARN \
  --protocol HTTPS \
  --port 443 \
  --certificates CertificateArn=$CERT_ARN \
  --default-actions Type=forward,TargetGroupArn=$TARGET_GROUP \
  --ssl-policy ELBSecurityPolicy-TLS13-1-2-2021-06 \
  --query 'Listeners[0].ListenerArn' \
  --output text)

# HTTPリスナーをHTTPSにリダイレクト（オプション）
# 既存のHTTPリスナーを削除してから、リダイレクトリスナーを作成
aws elbv2 delete-listener --listener-arn $HTTP_LISTENER

aws elbv2 create-listener \
  --load-balancer-arn $ALB_ARN \
  --protocol HTTP \
  --port 80 \
  --default-actions Type=redirect,RedirectConfig='{Protocol=HTTPS,Port=443,StatusCode=HTTP_301}'
```

## 2. AWS WAFの設定

### 2.1 WAF Web ACLの作成

```bash
# WAF Web ACLの作成
WAF_ACL_ID=$(aws wafv2 create-web-acl \
  --scope REGIONAL \
  --default-action Allow={} \
  --name auratime-waf-acl \
  --description "WAF ACL for AuraTime" \
  --rules '[
    {
      "Name": "AWSManagedRulesCommonRuleSet",
      "Priority": 1,
      "Statement": {
        "ManagedRuleGroupStatement": {
          "VendorName": "AWS",
          "Name": "AWSManagedRulesCommonRuleSet"
        }
      },
      "OverrideAction": {
        "None": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "CommonRuleSet"
      }
    },
    {
      "Name": "AWSManagedRulesKnownBadInputsRuleSet",
      "Priority": 2,
      "Statement": {
        "ManagedRuleGroupStatement": {
          "VendorName": "AWS",
          "Name": "AWSManagedRulesKnownBadInputsRuleSet"
        }
      },
      "OverrideAction": {
        "None": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "KnownBadInputsRuleSet"
      }
    },
    {
      "Name": "AWSManagedRulesSQLiRuleSet",
      "Priority": 3,
      "Statement": {
        "ManagedRuleGroupStatement": {
          "VendorName": "AWS",
          "Name": "AWSManagedRulesSQLiRuleSet"
        }
      },
      "OverrideAction": {
        "None": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "SQLiRuleSet"
      }
    },
    {
      "Name": "RateLimitRule",
      "Priority": 4,
      "Statement": {
        "RateBasedStatement": {
          "Limit": 2000,
          "AggregateKeyType": "IP"
        }
      },
      "Action": {
        "Block": {}
      },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "RateLimitRule"
      }
    }
  ]' \
  --visibility-config SampledRequestsEnabled=true,CloudWatchMetricsEnabled=true,MetricName=auratime-waf-acl \
  --tags Key=Name,Value=auratime-waf-acl Key=Project,Value=AuraTime \
  --query 'Summary.Id' \
  --output text)

echo "WAF ACL ID: $WAF_ACL_ID"
```

### 2.2 ALBへのWAFアソシエーション

```bash
# WAF Web ACLをALBに関連付け
aws wafv2 associate-web-acl \
  --web-acl-id $WAF_ACL_ID \
  --resource-arn $ALB_ARN \
  --scope REGIONAL
```

## 3. セキュリティグループの詳細設定

### 3.1 セキュリティグループルールの見直し

```bash
# ALBセキュリティグループの詳細設定
# 既存のルールを確認
aws ec2 describe-security-groups \
  --group-ids $ALB_SG

# 必要に応じて、特定のIPアドレスからのみアクセスを許可（オプション）
# 例：管理用IPアドレスからのみアクセスを許可
# aws ec2 authorize-security-group-ingress \
#   --group-id $ALB_SG \
#   --protocol tcp \
#   --port 443 \
#   --cidr YOUR_IP_ADDRESS/32
```

### 3.2 バックエンドセキュリティグループの強化

```bash
# バックエンドセキュリティグループは、ALBからのみアクセス可能であることを確認
# （既に設定済みの場合はスキップ）

# 不要なアウトバウンドルールの削除（必要に応じて）
# aws ec2 revoke-security-group-egress \
#   --group-id $BACKEND_SG \
#   --protocol tcp \
#   --port 80 \
#   --cidr 0.0.0.0/0
```

## 4. IAMポリシーの最適化

### 4.1 最小権限の原則に基づくポリシーの見直し

既存のIAMロールとポリシーを確認し、不要な権限を削除します。

```bash
# ECSタスクロールのポリシーを確認
aws iam list-role-policies --role-name auratime-ecs-task-role
aws iam get-role-policy --role-name auratime-ecs-task-role --policy-name S3AndCloudWatchAccess

# 必要に応じて、より細かい権限に制限
# 例：S3バケットの特定のプレフィックスのみアクセス可能にする
cat > task-role-policy-restricted.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject"
      ],
      "Resource": [
        "arn:aws:s3:::$BUCKET_NAME/payslips/*",
        "arn:aws:s3:::$BUCKET_NAME/uploads/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:ListBucket"
      ],
      "Resource": "arn:aws:s3:::$BUCKET_NAME",
      "Condition": {
        "StringLike": {
          "s3:prefix": [
            "payslips/*",
            "uploads/*"
          ]
        }
      }
    }
  ]
}
EOF
```

### 4.2 IAMアクセスキーのローテーション

```bash
# CI/CD用IAMユーザーのアクセスキーを定期的にローテーションする手順

# 1. 新しいアクセスキーの作成
aws iam create-access-key --user-name auratime-cicd

# 2. GitHub Secretsを更新

# 3. 古いアクセスキーの削除（新しいキーで動作確認後）
# aws iam delete-access-key --user-name auratime-cicd --access-key-id OLD_ACCESS_KEY_ID
```

## 5. データ暗号化の確認

### 5.1 RDS暗号化の確認

```bash
# RDSインスタンスの暗号化設定を確認
aws rds describe-db-instances \
  --db-instance-identifier $RDS_INSTANCE_ID \
  --query 'DBInstances[0].StorageEncrypted'

# 暗号化されていない場合は、スナップショットから暗号化されたインスタンスを作成
# （ダウンタイムが発生するため、メンテナンスウィンドウで実行）
```

### 5.2 S3バケットの暗号化確認

```bash
# S3バケットの暗号化設定を確認
aws s3api get-bucket-encryption --bucket $BUCKET_NAME

# 暗号化されていない場合は有効化（既に設定済みの場合はスキップ）
aws s3api put-bucket-encryption \
  --bucket $BUCKET_NAME \
  --server-side-encryption-configuration '{
    "Rules": [{
      "ApplyServerSideEncryptionByDefault": {
        "SSEAlgorithm": "AES256"
      }
    }]
  }'
```

### 5.3 EBSボリュームの暗号化（ECS Fargateでは不要）

ECS Fargateを使用しているため、EBSボリュームの暗号化設定は不要です。

## 6. セキュリティ監査の設定

### 6.1 AWS Configの有効化（オプション）

```bash
# AWS Configの有効化（コンプライアンス監査用）
aws configservice put-configuration-recorder \
  --configuration-recorder name=default,roleARN=arn:aws:iam::ACCOUNT_ID:role/aws-config-role

# 設定ルールの追加（例：暗号化されたボリュームのみ許可）
aws configservice put-config-rule \
  --config-rule '{
    "ConfigRuleName": "encrypted-volumes",
    "Source": {
      "Owner": "AWS",
      "SourceIdentifier": "ENCRYPTED_VOLUMES"
    }
  }'
```

### 6.2 CloudTrailの有効化

```bash
# CloudTrailの有効化（API呼び出しの監査ログ）
aws cloudtrail create-trail \
  --name auratime-cloudtrail \
  --s3-bucket-name $BUCKET_NAME \
  --s3-key-prefix cloudtrail/ \
  --is-multi-region-trail \
  --enable-log-file-validation \
  --tags Key=Name,Value=auratime-cloudtrail Key=Project,Value=AuraTime

# トレイルの開始
aws cloudtrail start-logging --name auratime-cloudtrail
```

## 7. セキュリティヘッダーの設定

### 7.1 ALBでのセキュリティヘッダー追加（Lambda@Edgeを使用）

ALBでは直接セキュリティヘッダーを追加できないため、Lambda@Edgeまたはアプリケーション側で設定します。

アプリケーション側（Spring Boot）での設定例：

```yaml
# application.yml
server:
  servlet:
    session:
      cookie:
        secure: true
        http-only: true
        same-site: strict
```

### 7.2 Content Security Policy (CSP) の設定

Next.js（フロントエンド）での設定例：

```javascript
// next.config.js
const securityHeaders = [
  {
    key: 'Content-Security-Policy',
    value: "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
  },
  {
    key: 'X-Frame-Options',
    value: 'DENY'
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'Referrer-Policy',
    value: 'strict-origin-when-cross-origin'
  }
]

module.exports = {
  async headers() {
    return [
      {
        source: '/:path*',
        headers: securityHeaders,
      },
    ]
  },
}
```

## 8. レート制限の設定

### 8.1 WAFでのレート制限（既に設定済み）

WAFのRateLimitRuleで既に設定済みです（2000リクエスト/5分/IP）。

### 8.2 アプリケーション側でのレート制限

Spring Bootアプリケーション側でもレート制限を実装することを推奨します（Bucket4j等を使用）。

## 9. セキュリティパッチの自動適用

### 9.1 ECSタスクの自動更新

ECSタスク定義を更新して、最新のセキュリティパッチが適用されたイメージを使用します。

```bash
# 最新のベースイメージを使用してDockerイメージを再ビルド
# （CI/CDパイプラインで自動化）
```

### 9.2 RDSの自動パッチ適用

RDSインスタンス作成時に`--auto-minor-version-upgrade`が有効になっているため、自動的にマイナーバージョンアップが適用されます。

## 10. セキュリティ監視の設定

### 10.1 GuardDutyの有効化（オプション）

```bash
# GuardDutyの有効化（脅威検知）
aws guardduty create-detector \
  --enable \
  --finding-publishing-frequency FIFTEEN_MINUTES \
  --tags Key=Project,Value=AuraTime
```

### 10.2 Security Hubの有効化（オプション）

```bash
# Security Hubの有効化（セキュリティベストプラクティスの監視）
aws securityhub enable-security-hub \
  --tags Key=Project,Value=AuraTime
```

## 11. 環境変数の記録

```bash
# 環境変数ファイルに追加
cat >> aws-env-vars.sh << EOF
export CERT_ARN=$CERT_ARN
export WAF_ACL_ID=$WAF_ACL_ID
EOF

# 環境変数を読み込む
source aws-env-vars.sh
```

## 次のステップ

- [`900_運用設計.md`](./900_運用設計.md): 運用設計の確認
- [`914_監視・ログ設定.md`](./914_監視・ログ設定.md): 監視とログ設定の確認

## セキュリティチェックリスト

以下の項目を定期的に確認してください：

- [ ] SSL証明書の有効期限（自動更新の設定）
- [ ] IAMポリシーの最小権限の原則への準拠
- [ ] セキュリティグループの不要なルールの削除
- [ ] WAFルールの効果的な動作確認
- [ ] CloudTrailログの確認
- [ ] アクセスキーのローテーション
- [ ] セキュリティパッチの適用状況
- [ ] データ暗号化の有効化確認

## トラブルシューティング

### SSL証明書の検証が失敗する

- **原因**: DNS検証レコードが正しく設定されていない
- **解決策**: Route53のレコードを確認し、CNAMEレコードが正しく設定されているか確認

### WAFが過度にブロックする

- **原因**: レート制限の閾値が低すぎる、またはマネージドルールが厳しすぎる
- **解決策**: WAFルールの優先度を調整し、必要に応じて例外を追加

### セキュリティグループで接続できない

- **原因**: セキュリティグループルールが正しく設定されていない
- **解決策**: セキュリティグループルールを確認し、必要なポートとソースを確認

## 参考資料

- [AWS Certificate Manager ユーザーガイド](https://docs.aws.amazon.com/ja_jp/acm/)
- [AWS WAF ユーザーガイド](https://docs.aws.amazon.com/ja_jp/waf/)
- [AWS IAM ベストプラクティス](https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/best-practices.html)
- [AWS Security Hub ユーザーガイド](https://docs.aws.amazon.com/ja_jp/securityhub/)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
