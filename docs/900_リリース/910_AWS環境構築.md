# AWS環境構築手順

本ドキュメントでは、AuraTimeシステムをAWS上に構築するためのインフラストラクチャのセットアップ手順を説明します。

## 前提条件

- AWSアカウントが作成済みであること
- AWS CLIがインストール・設定済みであること
- 適切なIAM権限を持っていること（VPC、EC2、RDS、ElastiCache、S3、CloudWatch、Amplify、ECS、ALB、Route53、ACM、IAM、Secrets Managerの作成・管理権限）

## 1. VPC（Virtual Private Cloud）の構築

### 1.1 VPCの作成

```bash
# VPCの作成（CIDR: 10.0.0.0/16）
aws ec2 create-vpc \
  --cidr-block 10.0.0.0/16 \
  --tag-specifications 'ResourceType=vpc,Tags=[{Key=Name,Value=auratime-vpc},{Key=Project,Value=AuraTime}]' \
  --query 'Vpc.VpcId' \
  --output text
```

VPC IDをメモしておきます（例: `vpc-xxxxxxxxxxxxxxxxx`）。

### 1.2 インターネットゲートウェイの作成とアタッチ

```bash
# インターネットゲートウェイの作成
IGW_ID=$(aws ec2 create-internet-gateway \
  --tag-specifications 'ResourceType=internet-gateway,Tags=[{Key=Name,Value=auratime-igw},{Key=Project,Value=AuraTime}]' \
  --query 'InternetGateway.InternetGatewayId' \
  --output text)

# VPCにアタッチ
aws ec2 attach-internet-gateway \
  --internet-gateway-id $IGW_ID \
  --vpc-id <VPC_ID>
```

### 1.3 パブリックサブネットの作成（2つのAZ）

```bash
# 東京リージョン（ap-northeast-1）の場合
# パブリックサブネット1（ap-northeast-1a）
PUBLIC_SUBNET_1A=$(aws ec2 create-subnet \
  --vpc-id <VPC_ID> \
  --cidr-block 10.0.1.0/24 \
  --availability-zone ap-northeast-1a \
  --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value=auratime-public-subnet-1a},{Key=Project,Value=AuraTime}]' \
  --query 'Subnet.SubnetId' \
  --output text)

# パブリックサブネット2（ap-northeast-1c）
PUBLIC_SUBNET_1C=$(aws ec2 create-subnet \
  --vpc-id <VPC_ID> \
  --cidr-block 10.0.2.0/24 \
  --availability-zone ap-northeast-1c \
  --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value=auratime-public-subnet-1c},{Key=Project,Value=AuraTime}]' \
  --query 'Subnet.SubnetId' \
  --output text)
```

### 1.4 プライベートサブネットの作成（2つのAZ）

```bash
# プライベートサブネット1（ap-northeast-1a）
PRIVATE_SUBNET_1A=$(aws ec2 create-subnet \
  --vpc-id <VPC_ID> \
  --cidr-block 10.0.11.0/24 \
  --availability-zone ap-northeast-1a \
  --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value=auratime-private-subnet-1a},{Key=Project,Value=AuraTime}]' \
  --query 'Subnet.SubnetId' \
  --output text)

# プライベートサブネット2（ap-northeast-1c）
PRIVATE_SUBNET_1C=$(aws ec2 create-subnet \
  --vpc-id <VPC_ID> \
  --cidr-block 10.0.12.0/24 \
  --availability-zone ap-northeast-1c \
  --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value=auratime-private-subnet-1c},{Key=Project,Value=AuraTime}]' \
  --query 'Subnet.SubnetId' \
  --output text)
```

### 1.5 ルートテーブルの作成と設定

```bash
# パブリックルートテーブルの作成
PUBLIC_RT=$(aws ec2 create-route-table \
  --vpc-id <VPC_ID> \
  --tag-specifications 'ResourceType=route-table,Tags=[{Key=Name,Value=auratime-public-rt},{Key=Project,Value=AuraTime}]' \
  --query 'RouteTable.RouteTableId' \
  --output text)

# インターネットゲートウェイへのルート追加
aws ec2 create-route \
  --route-table-id $PUBLIC_RT \
  --destination-cidr-block 0.0.0.0/0 \
  --gateway-id $IGW_ID

# パブリックサブネットにルートテーブルを関連付け
aws ec2 associate-route-table \
  --subnet-id $PUBLIC_SUBNET_1A \
  --route-table-id $PUBLIC_RT

aws ec2 associate-route-table \
  --subnet-id $PUBLIC_SUBNET_1C \
  --route-table-id $PUBLIC_RT

# プライベートルートテーブルの作成（NATゲートウェイ経由でインターネットアクセス可能）
PRIVATE_RT=$(aws ec2 create-route-table \
  --vpc-id <VPC_ID> \
  --tag-specifications 'ResourceType=route-table,Tags=[{Key=Name,Value=auratime-private-rt},{Key=Project,Value=AuraTime}]' \
  --query 'RouteTable.RouteTableId' \
  --output text)

# プライベートサブネットにルートテーブルを関連付け
aws ec2 associate-route-table \
  --subnet-id $PRIVATE_SUBNET_1A \
  --route-table-id $PRIVATE_RT

aws ec2 associate-route-table \
  --subnet-id $PRIVATE_SUBNET_1C \
  --route-table-id $PRIVATE_RT
```

### 1.6 NATゲートウェイの作成（オプション：プライベートサブネットからインターネットアクセスが必要な場合）

```bash
# Elastic IPの割り当て
EIP=$(aws ec2 allocate-address \
  --domain vpc \
  --tag-specifications 'ResourceType=elastic-ip,Tags=[{Key=Name,Value=auratime-nat-eip},{Key=Project,Value=AuraTime}]' \
  --query 'AllocationId' \
  --output text)

# NATゲートウェイの作成（パブリックサブネット1aに配置）
NAT_GW=$(aws ec2 create-nat-gateway \
  --subnet-id $PUBLIC_SUBNET_1A \
  --allocation-id $EIP \
  --tag-specifications 'ResourceType=nat-gateway,Tags=[{Key=Name,Value=auratime-nat-gw},{Key=Project,Value=AuraTime}]' \
  --query 'NatGateway.NatGatewayId' \
  --output text)

# NATゲートウェイが利用可能になるまで待機（約2-5分）
aws ec2 wait nat-gateway-available --nat-gateway-ids $NAT_GW

# プライベートルートテーブルにNATゲートウェイへのルートを追加
aws ec2 create-route \
  --route-table-id $PRIVATE_RT \
  --destination-cidr-block 0.0.0.0/0 \
  --nat-gateway-id $NAT_GW
```

## 2. セキュリティグループの作成

### 2.1 ALB用セキュリティグループ

```bash
# ALB用セキュリティグループ（HTTP/HTTPSを許可）
ALB_SG=$(aws ec2 create-security-group \
  --group-name auratime-alb-sg \
  --description "Security group for AuraTime ALB" \
  --vpc-id <VPC_ID> \
  --tag-specifications 'ResourceType=security-group,Tags=[{Key=Name,Value=auratime-alb-sg},{Key=Project,Value=AuraTime}]' \
  --query 'GroupId' \
  --output text)

# HTTP（ポート80）を許可（全世界）
aws ec2 authorize-security-group-ingress \
  --group-id $ALB_SG \
  --protocol tcp \
  --port 80 \
  --cidr 0.0.0.0/0

# HTTPS（ポート443）を許可（全世界）
aws ec2 authorize-security-group-ingress \
  --group-id $ALB_SG \
  --protocol tcp \
  --port 443 \
  --cidr 0.0.0.0/0
```

### 2.2 バックエンド（ECS/EC2）用セキュリティグループ

```bash
# バックエンド用セキュリティグループ（ALBからのみアクセス可能）
BACKEND_SG=$(aws ec2 create-security-group \
  --group-name auratime-backend-sg \
  --description "Security group for AuraTime backend" \
  --vpc-id <VPC_ID> \
  --tag-specifications 'ResourceType=security-group,Tags=[{Key=Name,Value=auratime-backend-sg},{Key=Project,Value=AuraTime}]' \
  --query 'GroupId' \
  --output text)

# ALBからのHTTP/HTTPSアクセスを許可
aws ec2 authorize-security-group-ingress \
  --group-id $BACKEND_SG \
  --protocol tcp \
  --port 8080 \
  --source-group $ALB_SG
```

### 2.3 RDS用セキュリティグループ

```bash
# RDS用セキュリティグループ（バックエンドからのみアクセス可能）
RDS_SG=$(aws ec2 create-security-group \
  --group-name auratime-rds-sg \
  --description "Security group for AuraTime RDS" \
  --vpc-id <VPC_ID> \
  --tag-specifications 'ResourceType=security-group,Tags=[{Key=Name,Value=auratime-rds-sg},{Key=Project,Value=AuraTime}]' \
  --query 'GroupId' \
  --output text)

# バックエンドからのPostgreSQLアクセスを許可
aws ec2 authorize-security-group-ingress \
  --group-id $RDS_SG \
  --protocol tcp \
  --port 5432 \
  --source-group $BACKEND_SG
```

### 2.4 ElastiCache用セキュリティグループ

```bash
# ElastiCache用セキュリティグループ（バックエンドからのみアクセス可能）
REDIS_SG=$(aws ec2 create-security-group \
  --group-name auratime-redis-sg \
  --description "Security group for AuraTime ElastiCache Redis" \
  --vpc-id <VPC_ID> \
  --tag-specifications 'ResourceType=security-group,Tags=[{Key=Name,Value=auratime-redis-sg},{Key=Project,Value=AuraTime}]' \
  --query 'GroupId' \
  --output text)

# バックエンドからのRedisアクセスを許可
aws ec2 authorize-security-group-ingress \
  --group-id $REDIS_SG \
  --protocol tcp \
  --port 6379 \
  --source-group $BACKEND_SG
```

## 3. Application Load Balancer（ALB）の作成

### 3.1 ALBの作成

```bash
# ALBの作成（パブリックサブネットに配置）
ALB_ARN=$(aws elbv2 create-load-balancer \
  --name auratime-alb \
  --subnets $PUBLIC_SUBNET_1A $PUBLIC_SUBNET_1C \
  --security-groups $ALB_SG \
  --scheme internet-facing \
  --type application \
  --ip-address-type ipv4 \
  --tags Key=Name,Value=auratime-alb Key=Project,Value=AuraTime \
  --query 'LoadBalancers[0].LoadBalancerArn' \
  --output text)

# ALBのDNS名を取得
ALB_DNS=$(aws elbv2 describe-load-balancers \
  --load-balancer-arns $ALB_ARN \
  --query 'LoadBalancers[0].DNSName' \
  --output text)

echo "ALB DNS: $ALB_DNS"
```

### 3.2 ターゲットグループの作成

```bash
# バックエンド用ターゲットグループ（HTTP:8080）
TARGET_GROUP=$(aws elbv2 create-target-group \
  --name auratime-backend-tg \
  --protocol HTTP \
  --port 8080 \
  --vpc-id <VPC_ID> \
  --target-type ip \
  --health-check-path /actuator/health \
  --health-check-interval-seconds 30 \
  --health-check-timeout-seconds 5 \
  --healthy-threshold-count 2 \
  --unhealthy-threshold-count 3 \
  --tags Key=Name,Value=auratime-backend-tg Key=Project,Value=AuraTime \
  --query 'TargetGroups[0].TargetGroupArn' \
  --output text)
```

### 3.3 リスナーの作成

```bash
# HTTPSリスナーの作成（SSL証明書は後で設定）
# まずはHTTPリスナーを作成
HTTP_LISTENER=$(aws elbv2 create-listener \
  --load-balancer-arn $ALB_ARN \
  --protocol HTTP \
  --port 80 \
  --default-actions Type=forward,TargetGroupArn=$TARGET_GROUP \
  --query 'Listeners[0].ListenerArn' \
  --output text)
```

**注意**: HTTPSリスナーの設定は、[`915_セキュリティ設定.md`](./915_セキュリティ設定.md)でSSL証明書を取得した後に行います。

## 4. Route53の設定（オプション：独自ドメインを使用する場合）

### 4.1 ホストゾーンの作成

```bash
# ホストゾーンの作成（例: auratime.example.com）
HOSTED_ZONE_ID=$(aws route53 create-hosted-zone \
  --name auratime.example.com \
  --caller-reference $(date +%s) \
  --query 'HostedZone.Id' \
  --output text | sed 's|/hostedzone/||')
```

### 4.2 Aレコードの作成（ALBへのエイリアス）

```bash
# ALBへのエイリアスレコードを作成
aws route53 change-resource-record-sets \
  --hosted-zone-id $HOSTED_ZONE_ID \
  --change-batch '{
    "Changes": [{
      "Action": "CREATE",
      "ResourceRecordSet": {
        "Name": "auratime.example.com",
        "Type": "A",
        "AliasTarget": {
          "HostedZoneId": "Z14GRHDKWAZQT5",
          "DNSName": "'$ALB_DNS'",
          "EvaluateTargetHealth": true
        }
      }
    }]
  }'
```

**注意**: `HostedZoneId`はリージョンによって異なります。ALBのホストゾーンIDを確認してください。

## 5. S3バケットの作成

### 5.1 メインバケットの作成

```bash
# S3バケットの作成（グローバルで一意な名前が必要）
BUCKET_NAME="auratime-prod-$(date +%s)"
aws s3api create-bucket \
  --bucket $BUCKET_NAME \
  --region ap-northeast-1 \
  --create-bucket-configuration LocationConstraint=ap-northeast-1

# バージョニングの有効化
aws s3api put-bucket-versioning \
  --bucket $BUCKET_NAME \
  --versioning-configuration Status=Enabled

# パブリックアクセスのブロック
aws s3api put-public-access-block \
  --bucket $BUCKET_NAME \
  --public-access-block-configuration \
    "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"

# 暗号化の有効化
aws s3api put-bucket-encryption \
  --bucket $BUCKET_NAME \
  --server-side-encryption-configuration '{
    "Rules": [{
      "ApplyServerSideEncryptionByDefault": {
        "SSEAlgorithm": "AES256"
      }
    }]
  }'

# ライフサイクルポリシーの設定（30日後にGlacierへ移行）
aws s3api put-bucket-lifecycle-configuration \
  --bucket $BUCKET_NAME \
  --lifecycle-configuration '{
    "Rules": [{
      "Id": "MoveToGlacier",
      "Status": "Enabled",
      "Prefix": "",
      "Transitions": [{
        "Days": 30,
        "StorageClass": "GLACIER"
      }]
    }]
  }'
```

### 5.2 フォルダ構造の作成

```bash
# 給与明細PDF用フォルダ
aws s3api put-object \
  --bucket $BUCKET_NAME \
  --key payslips/

# アップロードファイル用フォルダ
aws s3api put-object \
  --bucket $BUCKET_NAME \
  --key uploads/

# エクスポートファイル用フォルダ
aws s3api put-object \
  --bucket $BUCKET_NAME \
  --key exports/
```

## 6. 環境変数の記録

以下の情報をメモしておきます（後続の手順で使用します）：

```bash
# 環境変数ファイルを作成
cat > aws-env-vars.sh << EOF
export VPC_ID=<VPC_ID>
export PUBLIC_SUBNET_1A=$PUBLIC_SUBNET_1A
export PUBLIC_SUBNET_1C=$PUBLIC_SUBNET_1C
export PRIVATE_SUBNET_1A=$PRIVATE_SUBNET_1A
export PRIVATE_SUBNET_1C=$PRIVATE_SUBNET_1C
export ALB_ARN=$ALB_ARN
export ALB_DNS=$ALB_DNS
export TARGET_GROUP=$TARGET_GROUP
export ALB_SG=$ALB_SG
export BACKEND_SG=$BACKEND_SG
export RDS_SG=$RDS_SG
export REDIS_SG=$REDIS_SG
export BUCKET_NAME=$BUCKET_NAME
EOF

# 環境変数を読み込む
source aws-env-vars.sh
```

## 次のステップ

- [`911_データベース構築.md`](./911_データベース構築.md): RDSとElastiCacheのセットアップ
- [`912_アプリケーションデプロイ.md`](./912_アプリケーションデプロイ.md): アプリケーションのデプロイ
- [`915_セキュリティ設定.md`](./915_セキュリティ設定.md): SSL証明書とセキュリティ設定

## トラブルシューティング

### VPC作成時のエラー

- **エラー**: `You have requested more IP addresses than are available`
  - **解決策**: CIDRブロックを調整するか、既存のVPCを確認してください。

### サブネット作成時のエラー

- **エラー**: `CIDR address overlaps with existing subnet`
  - **解決策**: CIDRブロックが重複していないか確認してください。

### ALB作成時のエラー

- **エラー**: `Subnet does not have sufficient IP addresses`
  - **解決策**: サブネットのサイズを大きくするか、別のサブネットを使用してください。

## 参考資料

- [AWS VPC ユーザーガイド](https://docs.aws.amazon.com/ja_jp/vpc/)
- [AWS Application Load Balancer ユーザーガイド](https://docs.aws.amazon.com/ja_jp/elasticloadbalancing/latest/application/)
- [AWS Route53 ユーザーガイド](https://docs.aws.amazon.com/ja_jp/route53/)
- [AWS S3 ユーザーガイド](https://docs.aws.amazon.com/ja_jp/s3/)
