# データベース構築手順

本ドキュメントでは、AuraTimeシステムで使用するRDS（PostgreSQL）とElastiCache（Redis）のセットアップ手順を説明します。

## 前提条件

- [`910_AWS環境構築.md`](./910_AWS環境構築.md)の手順が完了していること
- VPC、サブネット、セキュリティグループが作成済みであること
- 以下の環境変数が設定されていること：
  - `VPC_ID`
  - `PRIVATE_SUBNET_1A`
  - `PRIVATE_SUBNET_1C`
  - `RDS_SG`
  - `REDIS_SG`

## 1. AWS Secrets Managerでの認証情報管理

### 1.1 RDS認証情報の作成

```bash
# RDSのマスターユーザー名とパスワードをSecrets Managerに保存
aws secretsmanager create-secret \
  --name auratime/rds/master \
  --description "RDS master credentials for AuraTime" \
  --secret-string '{
    "username": "auratime_admin",
    "password": "'$(openssl rand -base64 32)'"
  }' \
  --tags Key=Project,Value=AuraTime Key=Service,Value=RDS

# シークレットのARNを取得
RDS_SECRET_ARN=$(aws secretsmanager describe-secret \
  --secret-id auratime/rds/master \
  --query 'ARN' \
  --output text)
```

### 1.2 アプリケーション用データベース認証情報の作成

```bash
# アプリケーション用のデータベース認証情報
aws secretsmanager create-secret \
  --name auratime/rds/app \
  --description "RDS application credentials for AuraTime" \
  --secret-string '{
    "username": "auratime_app",
    "password": "'$(openssl rand -base64 32)'"
  }' \
  --tags Key=Project,Value=AuraTime Key=Service,Value=RDS

APP_SECRET_ARN=$(aws secretsmanager describe-secret \
  --secret-id auratime/rds/app \
  --query 'ARN' \
  --output text)
```

## 2. RDS（PostgreSQL）の構築

### 2.1 DBサブネットグループの作成

```bash
# DBサブネットグループの作成（プライベートサブネットに配置）
aws rds create-db-subnet-group \
  --db-subnet-group-name auratime-db-subnet-group \
  --db-subnet-group-description "DB subnet group for AuraTime" \
  --subnet-ids $PRIVATE_SUBNET_1A $PRIVATE_SUBNET_1C \
  --tags Key=Name,Value=auratime-db-subnet-group Key=Project,Value=AuraTime
```

### 2.2 RDSパラメータグループの作成（オプション）

```bash
# カスタムパラメータグループの作成（必要に応じて）
aws rds create-db-parameter-group \
  --db-parameter-group-name auratime-postgres16 \
  --db-parameter-group-family postgres16 \
  --description "Custom parameter group for AuraTime PostgreSQL 16" \
  --tags Key=Name,Value=auratime-postgres16 Key=Project,Value=AuraTime
```

### 2.3 RDSインスタンスの作成

```bash
# RDSインスタンスの作成（Multi-AZ構成）
RDS_INSTANCE_ID=$(aws rds create-db-instance \
  --db-instance-identifier auratime-db \
  --db-instance-class db.t3.medium \
  --engine postgres \
  --engine-version 16.4 \
  --master-username auratime_admin \
  --master-user-password $(aws secretsmanager get-secret-value --secret-id auratime/rds/master --query SecretString --output text | jq -r .password) \
  --allocated-storage 100 \
  --storage-type gp3 \
  --storage-encrypted \
  --kms-key-id alias/aws/rds \
  --db-name auratime \
  --db-subnet-group-name auratime-db-subnet-group \
  --vpc-security-group-ids $RDS_SG \
  --backup-retention-period 7 \
  --preferred-backup-window "03:00-04:00" \
  --preferred-maintenance-window "sun:04:00-sun:05:00" \
  --multi-az \
  --publicly-accessible \
  --no-publicly-accessible \
  --auto-minor-version-upgrade \
  --enable-performance-insights \
  --performance-insights-retention-period 7 \
  --deletion-protection \
  --tags Key=Name,Value=auratime-db Key=Project,Value=AuraTime \
  --query 'DBInstance.DBInstanceIdentifier' \
  --output text)

echo "RDS Instance ID: $RDS_INSTANCE_ID"
```

**注意**:
- `--publicly-accessible`を`--no-publicly-accessible`に変更して、パブリックアクセスを無効化してください（セキュリティのため）。
- 本番環境では`--deletion-protection`を有効にしてください。

### 2.4 RDSエンドポイントの取得

```bash
# RDSインスタンスが利用可能になるまで待機（約10-15分）
aws rds wait db-instance-available --db-instance-identifier $RDS_INSTANCE_ID

# RDSエンドポイントを取得
RDS_ENDPOINT=$(aws rds describe-db-instances \
  --db-instance-identifier $RDS_INSTANCE_ID \
  --query 'DBInstances[0].Endpoint.Address' \
  --output text)

RDS_PORT=$(aws rds describe-db-instances \
  --db-instance-identifier $RDS_INSTANCE_ID \
  --query 'DBInstances[0].Endpoint.Port' \
  --output text)

echo "RDS Endpoint: $RDS_ENDPOINT:$RDS_PORT"
```

### 2.5 初期マイグレーションの実行

RDSインスタンスが利用可能になったら、初期マイグレーションを実行します。

```bash
# ローカルマシンからRDSに接続してマイグレーションを実行
# （VPNまたは踏み台サーバー経由で接続する必要があります）

# 1. マイグレーションファイルを実行
psql -h $RDS_ENDPOINT -p $RDS_PORT -U auratime_admin -d auratime -f database/migrations/20260101_init.sql

# 2. アプリケーション用ユーザーの作成
psql -h $RDS_ENDPOINT -p $RDS_PORT -U auratime_admin -d auratime << EOF
-- アプリケーション用ユーザーの作成
CREATE USER auratime_app WITH PASSWORD '$(aws secretsmanager get-secret-value --secret-id auratime/rds/app --query SecretString --output text | jq -r .password)';

-- 権限の付与
GRANT CONNECT ON DATABASE auratime TO auratime_app;
GRANT USAGE ON SCHEMA public TO auratime_app;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO auratime_app;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO auratime_app;

-- 将来作成されるテーブルにも自動的に権限を付与
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO auratime_app;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO auratime_app;
EOF
```

**注意**: 本番環境では、Flywayを使用して自動的にマイグレーションを実行することを推奨します（[`912_アプリケーションデプロイ.md`](./912_アプリケーションデプロイ.md)を参照）。

### 2.6 初期データの投入

```bash
# system-botユーザーの作成（監査ログ用）
psql -h $RDS_ENDPOINT -p $RDS_PORT -U auratime_admin -d auratime << EOF
-- system-botユーザーの作成（UUIDは固定値を使用）
INSERT INTO m_users (id, email, password_hash, created_at, updated_at, created_by, updated_by)
VALUES (
  gen_uuid_v7(),
  'system-bot@auratime.internal',
  '\$2a\$10\$dummy_hash_for_system_bot', -- 実際には使用されない
  NOW(),
  NOW(),
  NULL,
  NULL
) ON CONFLICT DO NOTHING;
EOF
```

## 3. ElastiCache（Redis）の構築

### 3.1 サブネットグループの作成

```bash
# ElastiCache用サブネットグループの作成
aws elasticache create-cache-subnet-group \
  --cache-subnet-group-name auratime-redis-subnet-group \
  --cache-subnet-group-description "Subnet group for AuraTime Redis" \
  --subnet-ids $PRIVATE_SUBNET_1A $PRIVATE_SUBNET_1C \
  --tags Key=Name,Value=auratime-redis-subnet-group Key=Project,Value=AuraTime
```

### 3.2 パラメータグループの作成（オプション）

```bash
# Redisパラメータグループの作成（必要に応じて）
aws elasticache create-cache-parameter-group \
  --cache-parameter-group-name auratime-redis7 \
  --cache-parameter-group-family redis7.x \
  --description "Custom parameter group for AuraTime Redis 7.2" \
  --tags Key=Name,Value=auratime-redis7 Key=Project,Value=AuraTime
```

### 3.3 ElastiCacheクラスターの作成

```bash
# ElastiCacheクラスターの作成（クラスターモード無効、シンプル構成）
REDIS_CLUSTER_ID=$(aws elasticache create-cache-cluster \
  --cache-cluster-id auratime-redis \
  --cache-node-type cache.t3.micro \
  --engine redis \
  --engine-version 7.2 \
  --num-cache-nodes 1 \
  --cache-subnet-group-name auratime-redis-subnet-group \
  --security-group-ids $REDIS_SG \
  --preferred-maintenance-window sun:04:00-sun:05:00 \
  --snapshot-retention-limit 7 \
  --automated-snapshot-window "03:00-04:00" \
  --tags Key=Name,Value=auratime-redis Key=Project,Value=AuraTime \
  --query 'CacheCluster.CacheClusterId' \
  --output text)

echo "Redis Cluster ID: $REDIS_CLUSTER_ID"
```

**注意**: 本番環境では、クラスターモードを有効化して複数ノード構成にすることを推奨します。

### 3.4 ElastiCacheエンドポイントの取得

```bash
# ElastiCacheクラスターが利用可能になるまで待機（約5-10分）
aws elasticache wait cache-cluster-available --cache-cluster-id $REDIS_CLUSTER_ID

# ElastiCacheエンドポイントを取得
REDIS_ENDPOINT=$(aws elasticache describe-cache-clusters \
  --cache-cluster-id $REDIS_CLUSTER_ID \
  --show-cache-node-info \
  --query 'CacheClusters[0].CacheNodes[0].Endpoint.Address' \
  --output text)

REDIS_PORT=$(aws elasticache describe-cache-clusters \
  --cache-cluster-id $REDIS_CLUSTER_ID \
  --show-cache-node-info \
  --query 'CacheClusters[0].CacheNodes[0].Endpoint.Port' \
  --output text)

echo "Redis Endpoint: $REDIS_ENDPOINT:$REDIS_PORT"
```

## 4. 接続テスト

### 4.1 RDS接続テスト

```bash
# RDSへの接続テスト（VPNまたは踏み台サーバー経由）
psql -h $RDS_ENDPOINT -p $RDS_PORT -U auratime_admin -d auratime -c "SELECT version();"
```

### 4.2 Redis接続テスト

```bash
# Redisへの接続テスト（VPNまたは踏み台サーバー経由）
# redis-cliがインストールされている必要があります
redis-cli -h $REDIS_ENDPOINT -p $REDIS_PORT ping
```

## 5. 環境変数の記録

```bash
# 環境変数ファイルに追加
cat >> aws-env-vars.sh << EOF
export RDS_ENDPOINT=$RDS_ENDPOINT
export RDS_PORT=$RDS_PORT
export RDS_SECRET_ARN=$RDS_SECRET_ARN
export APP_SECRET_ARN=$APP_SECRET_ARN
export REDIS_ENDPOINT=$REDIS_ENDPOINT
export REDIS_PORT=$REDIS_PORT
EOF

# 環境変数を読み込む
source aws-env-vars.sh
```

## 6. バックアップ設定の確認

### 6.1 RDSバックアップ設定

RDSインスタンス作成時に以下のバックアップ設定が有効になっています：
- **自動バックアップ**: 7日間保持
- **バックアップウィンドウ**: 03:00-04:00（JST）
- **メンテナンスウィンドウ**: 日曜 04:00-05:00（JST）
- **Point-in-Time Recovery**: 有効

### 6.2 ElastiCacheバックアップ設定

ElastiCacheクラスター作成時に以下のバックアップ設定が有効になっています：
- **自動スナップショット**: 7日間保持
- **スナップショットウィンドウ**: 03:00-04:00（JST）

## 次のステップ

- [`912_アプリケーションデプロイ.md`](./912_アプリケーションデプロイ.md): アプリケーションのデプロイ
- [`914_監視・ログ設定.md`](./914_監視・ログ設定.md): 監視とログ設定

## トラブルシューティング

### RDS接続エラー

- **エラー**: `timeout: connect timed out`
  - **原因**: セキュリティグループの設定が正しくない
  - **解決策**: バックエンドのセキュリティグループからRDSのセキュリティグループへのポート5432のアクセスが許可されているか確認

### ElastiCache接続エラー

- **エラー**: `Connection refused`
  - **原因**: セキュリティグループの設定が正しくない
  - **解決策**: バックエンドのセキュリティグループからElastiCacheのセキュリティグループへのポート6379のアクセスが許可されているか確認

### マイグレーションエラー

- **エラー**: `function gen_uuid_v7() does not exist`
  - **原因**: UUID v7生成関数が作成されていない
  - **解決策**: `database/migrations/20260101_init.sql`を確認し、関数が正しく作成されているか確認

## 参考資料

- [AWS RDS ユーザーガイド](https://docs.aws.amazon.com/ja_jp/AmazonRDS/)
- [AWS ElastiCache ユーザーガイド](https://docs.aws.amazon.com/ja_jp/AmazonElastiCache/)
- [AWS Secrets Manager ユーザーガイド](https://docs.aws.amazon.com/ja_jp/secretsmanager/)
- [PostgreSQL 16 ドキュメント](https://www.postgresql.org/docs/16/)
