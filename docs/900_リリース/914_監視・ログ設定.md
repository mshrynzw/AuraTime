# 監視・ログ設定手順

本ドキュメントでは、AuraTimeシステムの監視とログ設定の手順を説明します。CloudWatchを使用した包括的な監視とアラート設定を行います。

## 前提条件

- [`910_AWS環境構築.md`](./910_AWS環境構築.md)の手順が完了していること
- [`911_データベース構築.md`](./911_データベース構築.md)の手順が完了していること
- [`912_アプリケーションデプロイ.md`](./912_アプリケーションデプロイ.md)の手順が完了していること
- 以下の環境変数が設定されていること：
  - `RDS_INSTANCE_ID`
  - `REDIS_CLUSTER_ID`
  - `ALB_ARN`
  - `ECS_CLUSTER`
  - `ECS_SERVICE`

## 1. CloudWatch Logsの設定

### 1.1 ロググループの作成

```bash
# バックエンド用ロググループ（既に作成済みの場合はスキップ）
aws logs create-log-group \
  --log-group-name /ecs/auratime-backend \
  --tags Key=Name,Value=auratime-backend Key=Project,Value=AuraTime

# ログ保持期間の設定（30日）
aws logs put-retention-policy \
  --log-group-name /ecs/auratime-backend \
  --retention-in-days 30

# ALB用ロググループ
aws logs create-log-group \
  --log-group-name /aws/alb/auratime \
  --tags Key=Name,Value=auratime-alb Key=Project,Value=AuraTime

aws logs put-retention-policy \
  --log-group-name /aws/alb/auratime \
  --retention-in-days 30
```

### 1.2 ALBアクセスログの有効化

```bash
# ALBアクセスログの有効化
aws elbv2 modify-load-balancer-attributes \
  --load-balancer-arn $ALB_ARN \
  --attributes \
    Key=access_logs.s3.enabled,Value=true \
    Key=access_logs.s3.bucket,Value=$BUCKET_NAME \
    Key=access_logs.s3.prefix,Value=alb-logs
```

### 1.3 ログエクスポート設定（S3への長期保存）

```bash
# CloudWatch LogsからS3へのエクスポート用IAMロールの作成
cat > logs-export-role-trust-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "logs.ap-northeast-1.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
EOF

LOGS_EXPORT_ROLE_ARN=$(aws iam create-role \
  --role-name auratime-logs-export-role \
  --assume-role-policy-document file://logs-export-role-trust-policy.json \
  --query 'Role.Arn' \
  --output text)

# S3への書き込み権限を付与
cat > logs-export-role-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject"
      ],
      "Resource": "arn:aws:s3:::$BUCKET_NAME/logs/*"
    }
  ]
}
EOF

aws iam put-role-policy \
  --role-name auratime-logs-export-role \
  --policy-name S3ExportAccess \
  --policy-document file://logs-export-role-policy.json
```

## 2. CloudWatch Metricsとダッシュボードの設定

### 2.1 カスタムメトリクスの設定

```bash
# カスタムメトリクス用のネームスペース
CUSTOM_NAMESPACE="AuraTime/Application"
```

### 2.2 CloudWatchダッシュボードの作成

```bash
# ダッシュボードの作成
aws cloudwatch put-dashboard \
  --dashboard-name auratime-overview \
  --dashboard-body '{
    "widgets": [
      {
        "type": "metric",
        "properties": {
          "metrics": [
            ["AWS/ApplicationELB", "TargetResponseTime", {"stat": "Average"}],
            [".", "RequestCount", {"stat": "Sum"}],
            [".", "HTTPCode_Target_2XX_Count", {"stat": "Sum"}],
            [".", "HTTPCode_Target_4XX_Count", {"stat": "Sum"}],
            [".", "HTTPCode_Target_5XX_Count", {"stat": "Sum"}]
          ],
          "period": 300,
          "stat": "Average",
          "region": "ap-northeast-1",
          "title": "ALB Metrics"
        }
      },
      {
        "type": "metric",
        "properties": {
          "metrics": [
            ["AWS/ECS", "CPUUtilization", {"stat": "Average"}],
            [".", "MemoryUtilization", {"stat": "Average"}]
          ],
          "period": 300,
          "stat": "Average",
          "region": "ap-northeast-1",
          "title": "ECS Metrics"
        }
      },
      {
        "type": "metric",
        "properties": {
          "metrics": [
            ["AWS/RDS", "CPUUtilization", {"stat": "Average"}],
            [".", "DatabaseConnections", {"stat": "Average"}],
            [".", "FreeableMemory", {"stat": "Average"}]
          ],
          "period": 300,
          "stat": "Average",
          "region": "ap-northeast-1",
          "title": "RDS Metrics"
        }
      },
      {
        "type": "metric",
        "properties": {
          "metrics": [
            ["AWS/ElastiCache", "CPUUtilization", {"stat": "Average"}],
            [".", "CacheHits", {"stat": "Sum"}],
            [".", "CacheMisses", {"stat": "Sum"}]
          ],
          "period": 300,
          "stat": "Average",
          "region": "ap-northeast-1",
          "title": "ElastiCache Metrics"
        }
      }
    ]
  }'
```

## 3. CloudWatch Alarmsの設定

### 3.1 SNSトピックの作成

```bash
# アラート通知用SNSトピックの作成
ALERT_TOPIC_ARN=$(aws sns create-topic \
  --name auratime-alerts \
  --tags Key=Name,Value=auratime-alerts Key=Project,Value=AuraTime \
  --query 'TopicArn' \
  --output text)

# メール通知のサブスクリプション（オプション）
aws sns subscribe \
  --topic-arn $ALERT_TOPIC_ARN \
  --protocol email \
  --notification-endpoint admin@auratime.example.com
```

### 3.2 ALBアラームの設定

```bash
# レスポンスタイムアラーム（平均レスポンスタイムが1秒を超える場合）
aws cloudwatch put-metric-alarm \
  --alarm-name auratime-alb-high-response-time \
  --alarm-description "ALB response time is too high" \
  --metric-name TargetResponseTime \
  --namespace AWS/ApplicationELB \
  --statistic Average \
  --period 300 \
  --threshold 1.0 \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 2 \
  --alarm-actions $ALERT_TOPIC_ARN \
  --dimensions Name=LoadBalancer,Value=$ALB_ARN \
  --tags Key=Project,Value=AuraTime

# 5xxエラーアラーム（5分間に10件以上の5xxエラー）
aws cloudwatch put-metric-alarm \
  --alarm-name auratime-alb-5xx-errors \
  --alarm-description "Too many 5xx errors from ALB" \
  --metric-name HTTPCode_Target_5XX_Count \
  --namespace AWS/ApplicationELB \
  --statistic Sum \
  --period 300 \
  --threshold 10 \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 1 \
  --alarm-actions $ALERT_TOPIC_ARN \
  --dimensions Name=LoadBalancer,Value=$ALB_ARN \
  --tags Key=Project,Value=AuraTime
```

### 3.3 ECSアラームの設定

```bash
# CPU使用率アラーム（80%を超える場合）
aws cloudwatch put-metric-alarm \
  --alarm-name auratime-ecs-high-cpu \
  --alarm-description "ECS service CPU utilization is too high" \
  --metric-name CPUUtilization \
  --namespace AWS/ECS \
  --statistic Average \
  --period 300 \
  --threshold 80 \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 2 \
  --alarm-actions $ALERT_TOPIC_ARN \
  --dimensions Name=ClusterName,Value=auratime-cluster Name=ServiceName,Value=auratime-backend \
  --tags Key=Project,Value=AuraTime

# メモリ使用率アラーム（80%を超える場合）
aws cloudwatch put-metric-alarm \
  --alarm-name auratime-ecs-high-memory \
  --alarm-description "ECS service memory utilization is too high" \
  --metric-name MemoryUtilization \
  --namespace AWS/ECS \
  --statistic Average \
  --period 300 \
  --threshold 80 \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 2 \
  --alarm-actions $ALERT_TOPIC_ARN \
  --dimensions Name=ClusterName,Value=auratime-cluster Name=ServiceName,Value=auratime-backend \
  --tags Key=Project,Value=AuraTime
```

### 3.4 RDSアラームの設定

```bash
# CPU使用率アラーム（80%を超える場合）
aws cloudwatch put-metric-alarm \
  --alarm-name auratime-rds-high-cpu \
  --alarm-description "RDS CPU utilization is too high" \
  --metric-name CPUUtilization \
  --namespace AWS/RDS \
  --statistic Average \
  --period 300 \
  --threshold 80 \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 2 \
  --alarm-actions $ALERT_TOPIC_ARN \
  --dimensions Name=DBInstanceIdentifier,Value=$RDS_INSTANCE_ID \
  --tags Key=Project,Value=AuraTime

# データベース接続数アラーム（最大接続数の80%を超える場合）
aws cloudwatch put-metric-alarm \
  --alarm-name auratime-rds-high-connections \
  --alarm-description "RDS database connections are too high" \
  --metric-name DatabaseConnections \
  --namespace AWS/RDS \
  --statistic Average \
  --period 300 \
  --threshold 80 \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 2 \
  --alarm-actions $ALERT_TOPIC_ARN \
  --dimensions Name=DBInstanceIdentifier,Value=$RDS_INSTANCE_ID \
  --tags Key=Project,Value=AuraTime

# ストレージ使用率アラーム（85%を超える場合）
aws cloudwatch put-metric-alarm \
  --alarm-name auratime-rds-high-storage \
  --alarm-description "RDS storage utilization is too high" \
  --metric-name FreeStorageSpace \
  --namespace AWS/RDS \
  --statistic Average \
  --period 300 \
  --threshold 15 \
  --comparison-operator LessThanThreshold \
  --evaluation-periods 1 \
  --alarm-actions $ALERT_TOPIC_ARN \
  --dimensions Name=DBInstanceIdentifier,Value=$RDS_INSTANCE_ID \
  --tags Key=Project,Value=AuraTime
```

### 3.5 ElastiCacheアラームの設定

```bash
# CPU使用率アラーム（80%を超える場合）
aws cloudwatch put-metric-alarm \
  --alarm-name auratime-redis-high-cpu \
  --alarm-description "ElastiCache Redis CPU utilization is too high" \
  --metric-name CPUUtilization \
  --namespace AWS/ElastiCache \
  --statistic Average \
  --period 300 \
  --threshold 80 \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 2 \
  --alarm-actions $ALERT_TOPIC_ARN \
  --dimensions Name=CacheClusterId,Value=$REDIS_CLUSTER_ID \
  --tags Key=Project,Value=AuraTime

# メモリ使用率アラーム（90%を超える場合）
aws cloudwatch put-metric-alarm \
  --alarm-name auratime-redis-high-memory \
  --alarm-description "ElastiCache Redis memory utilization is too high" \
  --metric-name DatabaseMemoryUsagePercentage \
  --namespace AWS/ElastiCache \
  --statistic Average \
  --period 300 \
  --threshold 90 \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 1 \
  --alarm-actions $ALERT_TOPIC_ARN \
  --dimensions Name=CacheClusterId,Value=$REDIS_CLUSTER_ID \
  --tags Key=Project,Value=AuraTime
```

## 4. ログインサイトクエリの設定

### 4.1 よく使用するクエリの保存

```bash
# エラーログの検索クエリ
cat > error-logs-query.txt << 'EOF'
fields @timestamp, @message, request_id, user_id, company_id
| filter @message like /ERROR|Exception/
| sort @timestamp desc
| limit 100
EOF

# レスポンスタイムの分析クエリ
cat > response-time-query.txt << 'EOF'
fields @timestamp, @message, request_id
| parse @message /response_time=(?<response_time>\d+)/
| stats avg(response_time), max(response_time), p95(response_time) by bin(5m)
EOF

# 特定のrequest_idでのログ検索
cat > request-id-query.txt << 'EOF'
fields @timestamp, @message, request_id, user_id, company_id
| filter request_id = "YOUR_REQUEST_ID"
| sort @timestamp asc
EOF
```

これらのクエリは、CloudWatch Logs Insightsで手動で実行するか、Lambda関数で定期実行できます。

## 5. PWA通知連携の設定

### 5.1 Lambda関数の作成（SNS → バックエンドAPI）

```bash
# Lambda関数用のIAMロールの作成
cat > lambda-role-trust-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "lambda.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
EOF

LAMBDA_ROLE_ARN=$(aws iam create-role \
  --role-name auratime-notification-lambda-role \
  --assume-role-policy-document file://lambda-role-trust-policy.json \
  --query 'Role.Arn' \
  --output text)

# Lambda関数用のポリシー
cat > lambda-role-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:*:*:*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "ec2:CreateNetworkInterface",
        "ec2:DescribeNetworkInterfaces",
        "ec2:DeleteNetworkInterface"
      ],
      "Resource": "*"
    }
  ]
}
EOF

aws iam put-role-policy \
  --role-name auratime-notification-lambda-role \
  --policy-name LambdaBasicExecution \
  --policy-document file://lambda-role-policy.json
```

### 5.2 Lambda関数のデプロイ

Lambda関数のコードは、SNSメッセージを受信してバックエンドAPIを呼び出す必要があります。実装例：

```python
# notification-handler.py（参考実装）
import json
import urllib.request
import urllib.parse
import os

def lambda_handler(event, context):
    # SNSメッセージの処理
    for record in event['Records']:
        sns_message = json.loads(record['Sns']['Message'])
        alarm_name = sns_message.get('AlarmName', '')
        alarm_description = sns_message.get('AlarmDescription', '')
        new_state = sns_message.get('NewStateValue', '')

        # バックエンドAPIを呼び出し
        api_url = os.environ.get('BACKEND_API_URL', 'https://api.auratime.example.com')
        notification_endpoint = f"{api_url}/api/v1/notifications/push"

        payload = {
            "title": f"アラート: {alarm_name}",
            "body": alarm_description,
            "data": {
                "alarm_name": alarm_name,
                "state": new_state
            }
        }

        req = urllib.request.Request(
            notification_endpoint,
            data=json.dumps(payload).encode('utf-8'),
            headers={'Content-Type': 'application/json'}
        )

        try:
            urllib.request.urlopen(req)
        except Exception as e:
            print(f"Failed to send notification: {e}")
            raise

    return {'statusCode': 200}
```

```bash
# Lambda関数のパッケージ化とデプロイ（例）
zip notification-handler.zip notification-handler.py

aws lambda create-function \
  --function-name auratime-notification-handler \
  --runtime python3.11 \
  --role $LAMBDA_ROLE_ARN \
  --handler notification-handler.lambda_handler \
  --zip-file fileb://notification-handler.zip \
  --timeout 30 \
  --environment Variables="{BACKEND_API_URL=https://api.auratime.example.com}" \
  --tags Key=Project,Value=AuraTime
```

### 5.3 SNSトピックへのLambdaサブスクリプション

```bash
# Lambda関数をSNSトピックにサブスクライブ
aws sns subscribe \
  --topic-arn $ALERT_TOPIC_ARN \
  --protocol lambda \
  --notification-endpoint $(aws lambda get-function --function-name auratime-notification-handler --query 'Configuration.FunctionArn' --output text)

# Lambda関数にSNSからの呼び出しを許可
aws lambda add-permission \
  --function-name auratime-notification-handler \
  --statement-id sns-invoke \
  --action lambda:InvokeFunction \
  --principal sns.amazonaws.com \
  --source-arn $ALERT_TOPIC_ARN
```

## 6. Route 53 Health Checksの設定

### 6.1 ヘルスチェックの作成

```bash
# ALBエンドポイントのヘルスチェック
HEALTH_CHECK_ID=$(aws route53 create-health-check \
  --caller-reference $(date +%s) \
  --health-check-config '{
    "Type": "HTTPS",
    "ResourcePath": "/actuator/health",
    "FullyQualifiedDomainName": "'$ALB_DNS'",
    "RequestInterval": 30,
    "FailureThreshold": 3,
    "MeasureLatency": true
  }' \
  --query 'HealthCheck.Id' \
  --output text)

# ヘルスチェックアラームの設定
aws cloudwatch put-metric-alarm \
  --alarm-name auratime-health-check-failed \
  --alarm-description "Health check failed" \
  --metric-name HealthCheckStatus \
  --namespace AWS/Route53 \
  --statistic Minimum \
  --period 60 \
  --threshold 1 \
  --comparison-operator LessThanThreshold \
  --evaluation-periods 1 \
  --alarm-actions $ALERT_TOPIC_ARN \
  --dimensions Name=HealthCheckId,Value=$HEALTH_CHECK_ID \
  --tags Key=Project,Value=AuraTime
```

## 7. ログのアーカイブ設定

### 7.1 CloudWatch LogsからS3へのエクスポート

```bash
# ログエクスポート用のサブスクリプションフィルターの作成（例：エラーログのみ）
aws logs put-subscription-filter \
  --log-group-name /ecs/auratime-backend \
  --filter-name error-logs-filter \
  --filter-pattern "[timestamp, request_id, level=ERROR, ...]" \
  --destination-arn arn:aws:s3:::$BUCKET_NAME/logs/errors \
  --role-arn $LOGS_EXPORT_ROLE_ARN
```

### 7.2 S3ライフサイクルポリシーの設定

```bash
# S3バケットのライフサイクルポリシーを更新（ログ用）
aws s3api put-bucket-lifecycle-configuration \
  --bucket $BUCKET_NAME \
  --lifecycle-configuration '{
    "Rules": [
      {
        "Id": "MoveLogsToGlacier",
        "Status": "Enabled",
        "Prefix": "logs/",
        "Transitions": [
          {
            "Days": 30,
            "StorageClass": "GLACIER"
          },
          {
            "Days": 90,
            "StorageClass": "DEEP_ARCHIVE"
          }
        ],
        "Expiration": {
          "Days": 365
        }
      }
    ]
  }'
```

## 8. 環境変数の記録

```bash
# 環境変数ファイルに追加
cat >> aws-env-vars.sh << EOF
export ALERT_TOPIC_ARN=$ALERT_TOPIC_ARN
export HEALTH_CHECK_ID=$HEALTH_CHECK_ID
EOF

# 環境変数を読み込む
source aws-env-vars.sh
```

## 次のステップ

- [`915_セキュリティ設定.md`](./915_セキュリティ設定.md): SSL証明書とセキュリティ設定
- [`900_運用設計.md`](./900_運用設計.md): 運用設計の確認

## トラブルシューティング

### アラームが発火しない

- **原因**: メトリクスの収集間隔や閾値設定が適切でない
- **解決策**: CloudWatch Metricsでメトリクスが正しく収集されているか確認し、閾値を調整

### SNS通知が届かない

- **原因**: メールアドレスの確認が完了していない、またはLambda関数のエラー
- **解決策**: SNSトピックのサブスクリプションステータスを確認し、Lambda関数のログを確認

### ログが表示されない

- **原因**: ロググループの設定が正しくない、またはアプリケーションからのログ出力が正しくない
- **解決策**: ECSタスク定義のログ設定を確認し、アプリケーションのログ出力設定を確認

## 参考資料

- [AWS CloudWatch ユーザーガイド](https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/)
- [AWS CloudWatch Logs ユーザーガイド](https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/logs/)
- [AWS SNS ユーザーガイド](https://docs.aws.amazon.com/ja_jp/sns/)
- [AWS Lambda ユーザーガイド](https://docs.aws.amazon.com/ja_jp/lambda/)
