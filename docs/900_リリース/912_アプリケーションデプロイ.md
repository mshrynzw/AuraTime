# アプリケーションデプロイ手順

本ドキュメントでは、AuraTimeシステムのフロントエンド（Next.js）とバックエンド（Spring Boot）をAWS上にデプロイする手順を説明します。

## 前提条件

- [`910_AWS環境構築.md`](./910_AWS環境構築.md)の手順が完了していること
- [`911_データベース構築.md`](./911_データベース構築.md)の手順が完了していること
- 以下の環境変数が設定されていること：
  - `ALB_ARN`
  - `ALB_DNS`
  - `TARGET_GROUP`
  - `BACKEND_SG`
  - `RDS_ENDPOINT`
  - `RDS_PORT`
  - `REDIS_ENDPOINT`
  - `REDIS_PORT`
  - `BUCKET_NAME`

## 1. フロントエンド（Next.js）のデプロイ（AWS Amplify）

### 1.1 Amplifyアプリの作成

#### AWS Consoleを使用する場合

1. [AWS Amplify Console](https://console.aws.amazon.com/amplify/)にアクセス
2. 「新しいアプリ」→「ホスト」を選択
3. GitHub、GitLab、Bitbucket、またはAWS CodeCommitからリポジトリを選択
4. ブランチを選択（例: `main`、`production`）
5. ビルド設定を確認・調整

#### AWS CLIを使用する場合

```bash
# Amplifyアプリの作成
AMPLIFY_APP_ID=$(aws amplify create-app \
  --name auratime-frontend \
  --repository https://github.com/your-org/auratime \
  --platform WEB \
  --environment-variables \
    NEXT_PUBLIC_API_URL=https://api.auratime.example.com \
  --tags Key=Name,Value=auratime-frontend Key=Project,Value=AuraTime \
  --query 'app.appId' \
  --output text)

echo "Amplify App ID: $AMPLIFY_APP_ID"
```

### 1.2 ビルド設定（amplify.yml）

プロジェクトルートに`amplify.yml`を作成します：

```yaml
version: 1
frontend:
  phases:
    preBuild:
      commands:
        - corepack enable
        - corepack prepare pnpm@latest --activate
        - pnpm install --frozen-lockfile
    build:
      commands:
        - pnpm build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
```

### 1.3 環境変数の設定

Amplify Consoleで以下の環境変数を設定します：

```bash
# 環境変数の設定
aws amplify update-app \
  --app-id $AMPLIFY_APP_ID \
  --environment-variables \
    NEXT_PUBLIC_API_URL=https://api.auratime.example.com \
    NODE_ENV=production
```

### 1.4 カスタムドメインの設定（オプション）

```bash
# カスタムドメインの追加
aws amplify create-domain-association \
  --app-id $AMPLIFY_APP_ID \
  --domain-name auratime.example.com \
  --sub-domain-settings \
    prefix=www,branchName=main \
    prefix=,branchName=main
```

### 1.5 デプロイの実行

```bash
# ブランチの作成とデプロイ
aws amplify create-branch \
  --app-id $AMPLIFY_APP_ID \
  --branch-name production \
  --enable-auto-build

# デプロイの開始
aws amplify start-job \
  --app-id $AMPLIFY_APP_ID \
  --branch-name production \
  --job-type RELEASE
```

## 2. バックエンド（Spring Boot）のデプロイ（AWS ECS Fargate）

### 2.1 ECR（Elastic Container Registry）リポジトリの作成

```bash
# ECRリポジトリの作成
aws ecr create-repository \
  --repository-name auratime-backend \
  --image-scanning-configuration scanOnPush=true \
  --encryption-configuration encryptionType=AES256 \
  --tags Key=Name,Value=auratime-backend Key=Project,Value=AuraTime

# リポジトリURIを取得
ECR_REPO_URI=$(aws ecr describe-repositories \
  --repository-names auratime-backend \
  --query 'repositories[0].repositoryUri' \
  --output text)

echo "ECR Repository URI: $ECR_REPO_URI"
```

### 2.2 Dockerイメージのビルドとプッシュ

```bash
# ECRへのログイン
aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin $ECR_REPO_URI

# Dockerイメージのビルド
cd backend
docker build -t auratime-backend:latest .

# イメージにタグを付与
docker tag auratime-backend:latest $ECR_REPO_URI:latest
docker tag auratime-backend:latest $ECR_REPO_URI:$(date +%Y%m%d-%H%M%S)

# ECRにプッシュ
docker push $ECR_REPO_URI:latest
docker push $ECR_REPO_URI:$(date +%Y%m%d-%H%M%S)
```

### 2.3 ECSクラスターの作成

```bash
# ECSクラスターの作成（Fargate）
aws ecs create-cluster \
  --cluster-name auratime-cluster \
  --capacity-providers FARGATE FARGATE_SPOT \
  --default-capacity-provider-strategy \
    capacityProvider=FARGATE,weight=1 \
    capacityProvider=FARGATE_SPOT,weight=0 \
  --tags Key=Name,Value=auratime-cluster Key=Project,Value=AuraTime
```

### 2.4 IAMロールの作成

#### タスク実行ロールの作成

```bash
# タスク実行ロールの信頼ポリシー
cat > task-execution-role-trust-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ecs-tasks.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
EOF

# タスク実行ロールの作成
TASK_EXECUTION_ROLE_ARN=$(aws iam create-role \
  --role-name auratime-ecs-task-execution-role \
  --assume-role-policy-document file://task-execution-role-trust-policy.json \
  --query 'Role.Arn' \
  --output text)

# 必要なポリシーをアタッチ
aws iam attach-role-policy \
  --role-name auratime-ecs-task-execution-role \
  --policy-arn arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy

# Secrets ManagerとSSM Parameter Storeへのアクセス権限を追加
cat > task-execution-role-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue",
        "ssm:GetParameters",
        "ssm:GetParameter"
      ],
      "Resource": [
        "arn:aws:secretsmanager:*:*:secret:auratime/*",
        "arn:aws:ssm:*:*:parameter/auratime/*"
      ]
    }
  ]
}
EOF

aws iam put-role-policy \
  --role-name auratime-ecs-task-execution-role \
  --policy-name SecretsManagerAccess \
  --policy-document file://task-execution-role-policy.json
```

#### タスクロールの作成

```bash
# タスクロールの信頼ポリシー
cat > task-role-trust-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ecs-tasks.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
EOF

# タスクロールの作成
TASK_ROLE_ARN=$(aws iam create-role \
  --role-name auratime-ecs-task-role \
  --assume-role-policy-document file://task-role-trust-policy.json \
  --query 'Role.Arn' \
  --output text)

# S3へのアクセス権限を追加
cat > task-role-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::$BUCKET_NAME",
        "arn:aws:s3:::$BUCKET_NAME/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:*:*:log-group:/ecs/auratime-backend:*"
    }
  ]
}
EOF

aws iam put-role-policy \
  --role-name auratime-ecs-task-role \
  --policy-name S3AndCloudWatchAccess \
  --policy-document file://task-role-policy.json
```

### 2.5 CloudWatch Logsグループの作成

```bash
# CloudWatch Logsグループの作成
aws logs create-log-group \
  --log-group-name /ecs/auratime-backend \
  --tags Key=Name,Value=auratime-backend Key=Project,Value=AuraTime
```

### 2.6 タスク定義の作成

```bash
# タスク定義の作成
cat > task-definition.json << EOF
{
  "family": "auratime-backend",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "512",
  "memory": "1024",
  "executionRoleArn": "$TASK_EXECUTION_ROLE_ARN",
  "taskRoleArn": "$TASK_ROLE_ARN",
  "containerDefinitions": [
    {
      "name": "auratime-backend",
      "image": "$ECR_REPO_URI:latest",
      "essential": true,
      "portMappings": [
        {
          "containerPort": 8080,
          "protocol": "tcp"
        }
      ],
      "environment": [
        {
          "name": "SPRING_PROFILES_ACTIVE",
          "value": "production"
        },
        {
          "name": "SERVER_PORT",
          "value": "8080"
        }
      ],
      "secrets": [
        {
          "name": "SPRING_DATASOURCE_URL",
          "valueFrom": "arn:aws:secretsmanager:ap-northeast-1:ACCOUNT_ID:secret:auratime/rds/app:url::"
        },
        {
          "name": "SPRING_DATASOURCE_USERNAME",
          "valueFrom": "arn:aws:secretsmanager:ap-northeast-1:ACCOUNT_ID:secret:auratime/rds/app:username::"
        },
        {
          "name": "SPRING_DATASOURCE_PASSWORD",
          "valueFrom": "arn:aws:secretsmanager:ap-northeast-1:ACCOUNT_ID:secret:auratime/rds/app:password::"
        },
        {
          "name": "SPRING_DATA_REDIS_HOST",
          "valueFrom": "arn:aws:ssm:ap-northeast-1:ACCOUNT_ID:parameter/auratime/redis/endpoint"
        },
        {
          "name": "SPRING_DATA_REDIS_PORT",
          "valueFrom": "arn:aws:ssm:ap-northeast-1:ACCOUNT_ID:parameter/auratime/redis/port"
        },
        {
          "name": "AWS_S3_BUCKET_NAME",
          "valueFrom": "arn:aws:ssm:ap-northeast-1:ACCOUNT_ID:parameter/auratime/s3/bucket-name"
        },
        {
          "name": "JWT_SECRET",
          "valueFrom": "arn:aws:secretsmanager:ap-northeast-1:ACCOUNT_ID:secret:auratime/jwt/secret::"
        }
      ],
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/auratime-backend",
          "awslogs-region": "ap-northeast-1",
          "awslogs-stream-prefix": "ecs"
        }
      },
      "healthCheck": {
        "command": ["CMD-SHELL", "curl -f http://localhost:8080/actuator/health || exit 1"],
        "interval": 30,
        "timeout": 5,
        "retries": 3,
        "startPeriod": 60
      }
    }
  ]
}
EOF

# タスク定義の登録
aws ecs register-task-definition \
  --cli-input-json file://task-definition.json
```

**注意**: `ACCOUNT_ID`を実際のAWSアカウントIDに置き換えてください。また、Secrets Managerのシークレットキー名は実際の構造に合わせて調整してください。

### 2.7 ECSサービスの作成

```bash
# ECSサービスの作成
aws ecs create-service \
  --cluster auratime-cluster \
  --service-name auratime-backend \
  --task-definition auratime-backend \
  --desired-count 2 \
  --launch-type FARGATE \
  --network-configuration "awsvpcConfiguration={subnets=[$PRIVATE_SUBNET_1A,$PRIVATE_SUBNET_1C],securityGroups=[$BACKEND_SG],assignPublicIp=DISABLED}" \
  --load-balancers "targetGroupArn=$TARGET_GROUP,containerName=auratime-backend,containerPort=8080" \
  --health-check-grace-period-seconds 60 \
  --enable-execute-command \
  --tags Key=Name,Value=auratime-backend Key=Project,Value=AuraTime
```

### 2.8 オートスケーリングの設定

```bash
# オートスケーリングターゲットの登録
aws application-autoscaling register-scalable-target \
  --service-namespace ecs \
  --scalable-dimension ecs:service:DesiredCount \
  --resource-id service/auratime-cluster/auratime-backend \
  --min-capacity 2 \
  --max-capacity 10

# スケーリングポリシーの作成（CPU使用率ベース）
aws application-autoscaling put-scaling-policy \
  --service-namespace ecs \
  --scalable-dimension ecs:service:DesiredCount \
  --resource-id service/auratime-cluster/auratime-backend \
  --policy-name auratime-backend-cpu-scaling \
  --policy-type TargetTrackingScaling \
  --target-tracking-scaling-policy-configuration '{
    "TargetValue": 70.0,
    "PredefinedMetricSpecification": {
      "PredefinedMetricType": "ECSServiceAverageCPUUtilization"
    },
    "ScaleInCooldown": 300,
    "ScaleOutCooldown": 60
  }'
```

## 3. 環境変数の設定（SSM Parameter Store）

### 3.1 Redisエンドポイントの設定

```bash
# RedisエンドポイントをSSM Parameter Storeに保存
aws ssm put-parameter \
  --name /auratime/redis/endpoint \
  --value $REDIS_ENDPOINT \
  --type String \
  --description "Redis endpoint for AuraTime" \
  --tags Key=Project,Value=AuraTime

aws ssm put-parameter \
  --name /auratime/redis/port \
  --value $REDIS_PORT \
  --type String \
  --description "Redis port for AuraTime" \
  --tags Key=Project,Value=AuraTime
```

### 3.2 S3バケット名の設定

```bash
# S3バケット名をSSM Parameter Storeに保存
aws ssm put-parameter \
  --name /auratime/s3/bucket-name \
  --value $BUCKET_NAME \
  --type String \
  --description "S3 bucket name for AuraTime" \
  --tags Key=Project,Value=AuraTime
```

### 3.3 JWTシークレットの設定

```bash
# JWTシークレットをSecrets Managerに保存
aws secretsmanager create-secret \
  --name auratime/jwt/secret \
  --description "JWT secret for AuraTime" \
  --secret-string "$(openssl rand -base64 64)" \
  --tags Key=Project,Value=AuraTime Key=Service,Value=Backend
```

## 4. デプロイの確認

### 4.1 フロントエンドの確認

```bash
# Amplifyアプリのステータス確認
aws amplify get-app --app-id $AMPLIFY_APP_ID

# デプロイのステータス確認
aws amplify list-jobs --app-id $AMPLIFY_APP_ID --branch-name production
```

### 4.2 バックエンドの確認

```bash
# ECSサービスのステータス確認
aws ecs describe-services \
  --cluster auratime-cluster \
  --services auratime-backend

# タスクのステータス確認
aws ecs list-tasks \
  --cluster auratime-cluster \
  --service-name auratime-backend

# ヘルスチェックの確認
curl https://$ALB_DNS/actuator/health
```

## 5. 次のステップ

- [`913_CI_CD設定.md`](./913_CI_CD設定.md): CI/CDパイプラインの設定
- [`914_監視・ログ設定.md`](./914_監視・ログ設定.md): 監視とログ設定
- [`915_セキュリティ設定.md`](./915_セキュリティ設定.md): SSL証明書とセキュリティ設定

## トラブルシューティング

### ECSタスクが起動しない

- **エラー**: `CannotPullContainerError`
  - **原因**: ECRへのアクセス権限がない、またはイメージが存在しない
  - **解決策**: タスク実行ロールにECRへのアクセス権限があるか確認

### アプリケーションがデータベースに接続できない

- **エラー**: `Connection refused` または `timeout`
  - **原因**: セキュリティグループの設定が正しくない、またはSecrets Managerの設定が間違っている
  - **解決策**: セキュリティグループとSecrets Managerの設定を確認

### ヘルスチェックが失敗する

- **エラー**: `Health check failed`
  - **原因**: アプリケーションが正常に起動していない、またはヘルスチェックエンドポイントが応答していない
  - **解決策**: CloudWatch Logsでアプリケーションのログを確認

## 参考資料

- [AWS Amplify ユーザーガイド](https://docs.aws.amazon.com/ja_jp/amplify/)
- [AWS ECS ユーザーガイド](https://docs.aws.amazon.com/ja_jp/ecs/)
- [AWS ECR ユーザーガイド](https://docs.aws.amazon.com/ja_jp/ecr/)
- [Spring Boot ドキュメント](https://spring.io/projects/spring-boot)
- [Next.js ドキュメント](https://nextjs.org/docs)
