# 運用設計

## 1. 監視・アラート

### AWS CloudWatch設定
- **死活監視**: 
  - Route 53 Health Checks（HTTPエンドポイント）
  - RDSインスタンスのステータス監視
- **パフォーマンス監視**: 
  - CloudWatch Metrics: レスポンスタイム、CPU/メモリ使用率
  - RDS Performance Insights: DBコネクション数、クエリパフォーマンス
  - ElastiCache Metrics: キャッシュヒット率
- **業務監視**: 
  - CloudWatch Alarms: 失敗した `job_runs` の検知
  - CloudWatch Logs Insights: 監査ログでの不審な操作の検知
- **Amplify監視**: 
  - ビルドステータス（成功/失敗）
  - デプロイステータス
  - CloudFront配信状況（CDN）
  - ビルド時間の監視

### アラート通知
- **Slack連携**: CloudWatch Alarms → SNS → Lambda → Slack
- **PagerDuty連携**: 重大な障害時の自動エスカレーション

## 2. 障害対応フロー
1.  **検知**: CloudWatch Alarms、Slack、PagerDuty、またはユーザーからの申告
2.  **初期調査**: 
   - `request_id` を元に CloudWatch Logs Insights で検索
   - RDS Performance Insights でDBパフォーマンス確認
   - `job_runs` / `audit_logs` テーブルを直接確認
3.  **応急処置**: 
   - ECSタスクの再起動（AWS Console / CLI）
   - Amplifyアプリの再デプロイ（ビルド失敗時）
   - CloudFrontキャッシュの無効化（必要に応じて）
   - オートスケーリングによるスケールアウト
   - RDS Read Replicaへの読み込み分散
   - データの不備修正（RDSへの直接接続）
4.  **恒久対策**: 
   - バグ修正・デプロイ
   - CloudFormation / Terraform でのインフラ設定変更

## 3. 保守作業

### DBメンテナンス
- **RDS自動メンテナンス**: 
  - メンテナンスウィンドウの設定（低トラフィック時間帯）
  - 自動マイナーバージョンアップデート
- **手動メンテナンス**: 
  - 定期的な VACUUM（RDSでは自動実行されるが、必要に応じて手動実行）
  - インデックスの再構築（`REINDEX`）

### パッチ適用
- **ECS**: イメージの更新とデプロイ
- **Amplify**: 
  - Next.jsのバージョンアップデート
  - 環境変数の更新
  - ビルド設定の更新
- **RDS**: メンテナンスウィンドウでの自動パッチ適用
- **ElastiCache**: メンテナンスウィンドウでの更新
- **OS・ランタイム**: ECSタスク定義の更新

### データクレンジング
- **ログデータ**: 
  - CloudWatch Logs → S3 へのエクスポート（ライフサイクルポリシー）
  - S3 → Glacier へのアーカイブ（長期保存）
- **RDSデータ**: 
  - 古い監査ログ・ジョブログの削除（保存期間を過ぎたもの）
  - S3へのエクスポート後、RDSから削除

### バックアップ・リストア
- **RDS**: 
  - 自動バックアップ（毎日、7日間保持）
  - 手動スナップショット（重要更新前）
  - Point-in-Time Recovery（任意の時点への復元）
- **S3**: 
  - バージョニング有効化
  - クロスリージョンレプリケーション（災害対策）

## 4. ユーザーサポート連携
- ユーザーからの問い合わせに対し、管理画面からジョブの実行状況や監査ログを参照して回答する手順の整備
- CloudWatch Logs Insights でのログ検索手順書
- RDS Performance Insights でのパフォーマンス調査手順書

## 5. コスト最適化
- **Amplify**: 
  - ビルド時間の最適化（不要なビルドの削減）
  - CloudFrontキャッシュの効率化
  - 不要なブランチ環境の削除
- **RDS**: 
  - インスタンスタイプの見直し（CPU/メモリ使用率に基づく）
  - 不要なRead Replicaの削除
- **ElastiCache**: 
  - ノードタイプの見直し
  - キャッシュヒット率の監視
- **S3**: 
  - ライフサイクルポリシーでGlacierへの移行
  - 不要なオブジェクトの削除
- **ECS**: 
  - 適切なタスク数の維持（オートスケーリング設定）
  - Spotインスタンスの活用（開発環境）
