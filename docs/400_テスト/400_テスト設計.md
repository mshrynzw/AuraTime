# テスト設計

## 1. テストレベル
- **単体テスト**: ビジネスロジック（労働時間計算、給与算出ロジック）を網羅する。
- **結合テスト**: APIエンドポイント、DB制約、非同期ジョブの連携を確認する。
- **総合テスト**: 主要な業務シナリオ（打刻〜承認〜締め〜給与確定）を通しで確認する。

## 2. 重点テスト項目
- **マルチテナント境界**: 別テナントの `company_id` を指定した際にデータが取得・変更できないことの徹底検証。
- **給与計算の正確性**: 端数処理、社会保険料計算、残業代係数の適用が法律・規程通りであること。
- **締め・ロック**: 確定後のデータが不正に書き換えられないこと。
- **差分計算**: 過去の勤怠を修正した際の影響範囲と、再計算結果の整合性。

## 3. テストデータ方針
- 本番データの利用は原則禁止。個人情報を伏字にした匿名化データ、またはツールで生成した疑似データを使用する。
- 境界値テスト（月末、閏年、退職日当日など）のパターンをテストスイートに含める。

## 4. 負荷テスト
- 給与計算ジョブ実行中に、他のユーザーの打刻処理が遅延しないことを確認する。

---

## 5. テスト仕様書テンプレート

### 使用方法

このテンプレートはマークダウンテーブル形式で記述されています。以下のテーブルをコピーしてExcelに貼り付けると、自動的にセルに分割されます。

**コピー方法:**
1. テーブル部分（ヘッダー行と区切り行を含む）を選択
2. コピー（Ctrl+C）
3. Excelのセルに貼り付け（Ctrl+V）

### 単体テスト仕様書テンプレート

#### 労働時間計算ロジック

| テストケースID | テスト項目 | 前提条件 | 入力データ | 期待結果 | 実装状況 | 実行結果 | 備考 |
|---|---|---|---|---|---|---|---|
| TC-UT-001 | 正常系：通常勤務（8時間） | - | 出勤: 09:00, 退勤: 18:00, 休憩: 60分 | 労働時間: 8時間、法定内: 8時間、残業: 0時間 | 未実装 | 未実行 | |
| TC-UT-002 | 正常系：残業（10時間） | - | 出勤: 09:00, 退勤: 20:00, 休憩: 60分 | 労働時間: 10時間、法定内: 8時間、残業: 2時間 | 未実装 | 未実行 | |
| TC-UT-003 | 正常系：深夜労働 | - | 出勤: 22:00, 退勤: 06:00（翌日）, 休憩: 60分 | 労働時間: 7時間、深夜: 6時間 | 未実装 | 未実行 | |
| TC-UT-004 | 境界値：月末（2月28日） | - | 出勤: 2025-02-28 09:00, 退勤: 2025-02-28 18:00 | 労働時間が正しく計算される | 未実装 | 未実行 | 境界値テスト |
| TC-UT-005 | 境界値：閏年（2月29日） | - | 出勤: 2024-02-29 09:00, 退勤: 2024-02-29 18:00 | 労働時間が正しく計算される | 未実装 | 未実行 | 境界値テスト |

#### 給与算出ロジック

| テストケースID | テスト項目 | 前提条件 | 入力データ | 期待結果 | 実装状況 | 実行結果 | 備考 |
|---|---|---|---|---|---|---|---|
| TC-UT-006 | 正常系：基本給のみ | - | 基本給: 250,000円、労働時間: 160時間 | 支給額: 250,000円 | 未実装 | 未実行 | |
| TC-UT-007 | 正常系：残業代計算 | - | 基本給: 250,000円、残業時間: 20時間、残業単価: 1,563円 | 残業代: 31,260円、支給額: 281,260円 | 未実装 | 未実行 | |
| TC-UT-008 | 正常系：端数処理（切り上げ） | - | 基本給: 250,000円、残業時間: 20.5時間、残業単価: 1,563円 | 残業代が正しく端数処理される | 未実装 | 未実行 | **重点テスト項目** |
| TC-UT-009 | 正常系：社会保険料計算 | - | 標準報酬月額: 250,000円 | 健康保険料、厚生年金保険料が正しく計算される | 未実装 | 未実行 | **重点テスト項目** |

### 結合テスト（APIテスト）仕様書テンプレート

#### POST `/api/v1/time-clock/events` - 打刻イベント登録

| テストケースID | テスト項目 | 前提条件 | 入力データ | 期待結果 | 実装状況 | 実行結果 | 備考 |
|---|---|---|---|---|---|---|---|
| TC-API-001 | 正常系：出勤打刻 | ログイン済み（Employee権限） | `{"happened_at": "2025-12-18T09:00:00+09:00", "type": "in", "source": "web", "note": "自宅よりリモート"}` | HTTP 200 OK、打刻イベントが登録される | 未実装 | 未実行 | |
| TC-API-002 | 正常系：退勤打刻 | ログイン済み（Employee権限）、出勤打刻済み | `{"happened_at": "2025-12-18T18:00:00+09:00", "type": "out", "source": "web"}` | HTTP 200 OK、退勤打刻が登録される | 未実装 | 未実行 | |
| TC-API-003 | 正常系：休憩入り打刻 | ログイン済み（Employee権限）、出勤打刻済み | `{"happened_at": "2025-12-18T12:00:00+09:00", "type": "break_in", "source": "web"}` | HTTP 200 OK、休憩入り打刻が登録される | 未実装 | 未実行 | |
| TC-API-004 | 正常系：休憩戻り打刻 | ログイン済み（Employee権限）、出勤打刻済み、休憩入り打刻済み | `{"happened_at": "2025-12-18T13:00:00+09:00", "type": "break_out", "source": "web"}` | HTTP 200 OK、休憩戻り打刻が登録される | 未実装 | 未実行 | |
| TC-API-005 | 異常系：未来時刻の打刻 | ログイン済み（Employee権限） | `{"happened_at": "2026-12-18T09:00:00+09:00", "type": "in", "source": "web"}` | HTTP 400 Bad Request、エラーメッセージが返却される | 未実装 | 未実行 | 境界値テスト |
| TC-API-006 | 異常系：無効なtype値 | ログイン済み（Employee権限） | `{"happened_at": "2025-12-18T09:00:00+09:00", "type": "invalid", "source": "web"}` | HTTP 400 Bad Request、バリデーションエラー | 未実装 | 未実行 | |
| TC-API-007 | 異常系：type未指定 | ログイン済み（Employee権限） | `{"happened_at": "2025-12-18T09:00:00+09:00", "source": "web"}` | HTTP 400 Bad Request、必須項目エラー | 未実装 | 未実行 | |
| TC-API-008 | 認証エラー：未ログイン | 未ログイン | `{"happened_at": "2025-12-18T09:00:00+09:00", "type": "in", "source": "web"}` | HTTP 401 Unauthorized | 未実装 | 未実行 | |
| TC-API-009 | 正常系：mobileソース | ログイン済み（Employee権限） | `{"happened_at": "2025-12-18T09:00:00+09:00", "type": "in", "source": "mobile"}` | HTTP 200 OK、打刻イベントが登録される | 未実装 | 未実行 | |
| TC-API-010 | 正常系：note付き打刻 | ログイン済み（Employee権限） | `{"happened_at": "2025-12-18T09:00:00+09:00", "type": "in", "source": "web", "note": "テスト用のメモです"}` | HTTP 200 OK、noteが保存される | 未実装 | 未実行 | |

#### GET `/api/v1/time-records` - 勤怠レコード一覧取得

| テストケースID | テスト項目 | 前提条件 | 入力データ | 期待結果 | 実装状況 | 実行結果 | 備考 |
|---|---|---|---|---|---|---|---|
| TC-API-011 | 正常系：Employee自身の勤怠取得 | ログイン済み（Employee権限） | `?start_date=2025-12-01&end_date=2025-12-31` | HTTP 200 OK、自身の勤怠レコード一覧が返却される | 未実装 | 未実行 | |
| TC-API-012 | 正常系：Managerが部下の勤怠取得 | ログイン済み（Manager権限） | `?start_date=2025-12-01&end_date=2025-12-31` | HTTP 200 OK、部下の勤怠レコード一覧が返却される | 未実装 | 未実行 | |
| TC-API-013 | 正常系：Adminが全員の勤怠取得 | ログイン済み（Admin権限） | `?start_date=2025-12-01&end_date=2025-12-31` | HTTP 200 OK、全員の勤怠レコード一覧が返却される | 未実装 | 未実行 | |
| TC-API-014 | 正常系：日付範囲指定 | ログイン済み（Employee権限） | `?start_date=2025-12-01&end_date=2025-12-07` | HTTP 200 OK、指定期間の勤怠レコードが返却される | 未実装 | 未実行 | |
| TC-API-015 | マルチテナント境界：他社データ取得不可 | ログイン済み（Company AのEmployee）、Company Bのデータが存在 | `?start_date=2025-12-01&end_date=2025-12-31` | HTTP 200 OK、自社データのみ返却される（他社データは含まれない） | 未実装 | 未実行 | **重点テスト項目** |

#### PATCH `/api/v1/time-records/{id}` - 勤怠レコード修正

| テストケースID | テスト項目 | 前提条件 | 入力データ | 期待結果 | 実装状況 | 実行結果 | 備考 |
|---|---|---|---|---|---|---|---|
| TC-API-016 | 正常系：勤怠レコード修正 | ログイン済み（Employee権限）、未承認の勤怠レコードが存在 | `{"start_at": "2025-12-18T09:15:00+09:00", "end_at": "2025-12-18T18:15:00+09:00", "break_minutes": 60}` | HTTP 200 OK、勤怠レコードが更新される | 未実装 | 未実行 | |
| TC-API-017 | 異常系：承認済みレコードの修正不可 | ログイン済み（Employee権限）、承認済みの勤怠レコードが存在 | `{"start_at": "2025-12-18T09:15:00+09:00"}` | HTTP 409 Conflict、エラーメッセージが返却される | 未実装 | 未実行 | **重点テスト項目** |
| TC-API-018 | 異常系：締め済みレコードの修正不可 | ログイン済み（Employee権限）、期間締め済みの勤怠レコードが存在 | `{"start_at": "2025-12-18T09:15:00+09:00"}` | HTTP 409 Conflict、エラーメッセージが返却される | 未実装 | 未実行 | **重点テスト項目** |
| TC-API-019 | マルチテナント境界：他社レコードの修正不可 | ログイン済み（Company AのEmployee）、Company BのレコードIDを指定 | `{"start_at": "2025-12-18T09:15:00+09:00"}` | HTTP 403 Forbidden または 404 Not Found | 未実装 | 未実行 | **重点テスト項目** |

#### POST `/api/v1/leave-requests` - 休暇申請

| テストケースID | テスト項目 | 前提条件 | 入力データ | 期待結果 | 実装状況 | 実行結果 | 備考 |
|---|---|---|---|---|---|---|---|
| TC-API-020 | 正常系：休暇申請（承認不要） | ログイン済み（Employee権限）、承認不要の休暇タイプが存在 | `{"leave_type_id": "uuid", "start_date": "2026-01-05", "end_date": "2026-01-05", "days": 1.0, "reason": "私用のため"}` | HTTP 200 OK、休暇申請が登録される、ステータスがapproved | 未実装 | 未実行 | |
| TC-API-021 | 正常系：休暇申請（承認必要） | ログイン済み（Employee権限）、承認必要な休暇タイプが存在 | `{"leave_type_id": "uuid", "start_date": "2026-01-05", "end_date": "2026-01-06", "days": 2.0, "reason": "私用のため"}` | HTTP 200 OK、休暇申請が登録される、ステータスがsubmitted、承認リクエストが生成される | 未実装 | 未実行 | |
| TC-API-022 | 異常系：残数不足 | ログイン済み（Employee権限）、残数が0の休暇タイプ | `{"leave_type_id": "uuid", "start_date": "2026-01-05", "end_date": "2026-01-05", "days": 1.0}` | HTTP 400 Bad Request、残数不足エラー | 未実装 | 未実行 | |

### 総合テスト（E2Eテスト）仕様書テンプレート

| テストケースID | テスト項目 | 前提条件 | テスト手順 | 期待結果 | 実装状況 | 実行結果 | 備考 |
|---|---|---|---|---|---|---|---|
| TC-E2E-001 | 打刻〜承認〜締め〜給与確定の一連フロー | テストユーザー（Employee、Manager）が作成済み | 1. 出勤打刻 2. 退勤打刻 3. 勤怠修正申請 4. 承認 5. 期間締め 6. 給与計算実行 7. 給与確定 | 全てのステップが正常に完了する | 未実装 | 未実行 | **重点テスト項目** |
| TC-E2E-002 | マルチテナント境界：他社データへのアクセス不可 | Company A、Company Bのユーザーが作成済み | 1. Company Aのユーザーでログイン 2. Company BのデータIDを指定してAPI呼び出し | 全てのAPI呼び出しで403 Forbiddenまたは404 Not Foundが返却される | 未実装 | 未実行 | **重点テスト項目** |
| TC-E2E-003 | 給与計算の正確性確認 | テストデータ（勤怠、単価設定）が作成済み | 1. 給与期間を作成 2. 給与計算実行 3. 計算結果を確認 | 端数処理、社会保険料計算、残業代係数が正しく適用される | 未実装 | 未実行 | **重点テスト項目** |
| TC-E2E-004 | 締め・ロック確認 | 承認済みの勤怠レコードが存在 | 1. 期間締めを実行 2. 締め済みレコードの修正を試行 | 修正が拒否される（409 Conflict） | 未実装 | 未実行 | **重点テスト項目** |
| TC-E2E-005 | 差分計算確認 | 過去の勤怠レコードが存在、給与計算済み | 1. 過去の勤怠レコードを修正 2. 再計算を実行 3. 差分が正しく反映されることを確認 | 差分が正しく計算され、影響範囲が正しく更新される | 未実装 | 未実行 | **重点テスト項目** |

### テスト実行結果サマリー

| テストレベル | 総テストケース数 | 実装済み | 実行済み | 合格 | 不合格 | 未実行 | 合格率 |
|---|---|---|---|---|---|---|---|
| 結合テスト（API） | 22 | 0 | 0 | 0 | 0 | 22 | - |
| 総合テスト（E2E） | 5 | 0 | 0 | 0 | 0 | 5 | - |
| 単体テスト | 9 | 0 | 0 | 0 | 0 | 9 | - |
| **合計** | **36** | **0** | **0** | **0** | **0** | **36** | **-** |

### 注意事項

1. **Excelへのコピー方法**: テーブル全体（ヘッダー行と区切り行を含む）を選択してコピーし、Excelに貼り付けてください。
2. **マークダウン記法**: テーブル内の改行や特殊文字は、Excelに貼り付けた後に適宜調整してください。
3. **テストケースID**: 各テストケースには一意のIDを付与してください。
4. **重点テスト項目**: マルチテナント境界、給与計算の正確性、締め・ロック、差分計算は特に重点的にテストしてください。
