# Git運用

## 1. 概要

本ドキュメントは、AuraTimeプロジェクトにおけるGitブランチ戦略、コミットメッセージ規約、CI/CD、テスト実行フローを定義します。

## 2. ブランチ戦略

### 2.1 ブランチ構成

```
main (本番環境用)
  ├── develop (開発統合ブランチ)
  │   ├── feature/phase-0-auth (Phase 0: 認証基盤)
  │   ├── feature/phase-1-core (Phase 1: コア機能)
  │   ├── feature/phase-2-advanced (Phase 2: 高度な機能)
  │   ├── feature/phase-3-payroll (Phase 3: 給与機能)
  │   └── feature/phase-4-admin (Phase 4: 管理機能)
  └── release/phase-X (リリース準備ブランチ)
```

### 2.2 ブランチの役割

| ブランチ | 役割 | 説明 |
| :--- | :--- | :--- |
| **main** | 本番環境用 | 常にデプロイ可能な状態を保つ。タグでバージョン管理 |
| **develop** | 開発統合ブランチ | 各フェーズの機能を統合するブランチ。常に動作する状態を保つ |
| **feature/phase-X** | 機能開発ブランチ | 各フェーズの実装を行うブランチ |
| **release/phase-X** | リリース準備ブランチ | フェーズ完了時のリリース準備用（必要に応じて） |
| **hotfix/** | 緊急修正ブランチ | 本番環境の緊急修正用（mainから分岐、mainとdevelopにマージ） |

### 2.3 ブランチ運用フロー

#### 2.3.1 機能開発の開始

```bash
# developブランチからfeatureブランチを作成
git checkout develop
git pull origin develop
git checkout -b feature/phase-0-auth
```

#### 2.3.2 開発中のコミット

```bash
# 機能を実装し、コミット
git add .
git commit -m "feat: ユーザー登録APIの実装"
git push origin feature/phase-0-auth
```

#### 2.3.3 フェーズ完了時のマージ

```bash
# developブランチにマージ
git checkout develop
git pull origin develop
git merge feature/phase-0-auth
git push origin develop

# featureブランチを削除（オプション）
git branch -d feature/phase-0-auth
git push origin --delete feature/phase-0-auth
```

#### 2.3.4 リリース準備（必要に応じて）

```bash
# releaseブランチを作成
git checkout -b release/phase-0 develop
# バグ修正、ドキュメント更新等
git checkout main
git merge release/phase-0
git tag -a v0.1.0 -m "Phase 0: 認証基盤完成"
git push origin main --tags

# developにもマージ
git checkout develop
git merge release/phase-0
git push origin develop
```

#### 2.3.5 緊急修正（hotfix）

```bash
# mainブランチからhotfixブランチを作成
git checkout main
git pull origin main
git checkout -b hotfix/critical-security-fix

# 修正を実装
git add .
git commit -m "fix: セキュリティ脆弱性の修正"
git push origin hotfix/critical-security-fix

# mainにマージ
git checkout main
git merge hotfix/critical-security-fix
git tag -a v0.1.1 -m "Hotfix: セキュリティ修正"
git push origin main --tags

# developにもマージ
git checkout develop
git merge hotfix/critical-security-fix
git push origin develop

# hotfixブランチを削除
git branch -d hotfix/critical-security-fix
git push origin --delete hotfix/critical-security-fix
```

### 2.4 ブランチ命名規則

- **featureブランチ**: `feature/phase-{0-4}-{機能名}`
  - 例: `feature/phase-0-auth`, `feature/phase-1-time-clock`
- **releaseブランチ**: `release/phase-{0-4}`
  - 例: `release/phase-0`
- **hotfixブランチ**: `hotfix/{修正内容}`
  - 例: `hotfix/critical-security-fix`

## 3. コミットメッセージ規約

### 3.1 Conventional Commits形式

Conventional Commits形式を使用します：

```
<type>(<scope>): <subject>

<body>

<footer>
```

### 3.2 Type（必須）

- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメントのみの変更
- `style`: コードの動作に影響しない変更（フォーマット等）
- `refactor`: リファクタリング
- `test`: テストの追加・修正
- `chore`: ビルドプロセスやツールの変更

### 3.3 Scope（任意）

機能やモジュール名を指定します。

- `auth`: 認証・認可
- `time-clock`: 打刻機能
- `time-records`: 勤怠管理
- `leave`: 休暇管理
- `payroll`: 給与機能
- `api`: API全般
- `frontend`: フロントエンド
- `backend`: バックエンド

### 3.4 Subject（必須）

- 50文字以内で簡潔に記述
- 命令形で記述（例: "追加する" ではなく "追加"）
- 文末にピリオドを付けない

### 3.5 Body（任意）

- 変更の理由や詳細を記述
- 72文字で折り返す

### 3.6 Footer（任意）

- 関連するIssue番号を記述
- `Closes #123`, `Fixes #456` など

### 3.7 コミットメッセージの例

```
feat(auth): ユーザー登録APIの実装

- POST /api/v1/auth/register エンドポイントを追加
- パスワードハッシュ化（bcrypt）を実装
- バリデーションを追加

Closes #123
```

```
fix(time-records): 日次集計の計算ロジック修正

労働時間の計算で休憩時間が正しく反映されていなかった問題を修正。

Fixes #456
```

```
docs: テーブル命名規則の統一

- テーブル名をプレフィックス付き命名規則に統一（m_, t_, h_, r_）
- ドキュメント全体で整合性を確保
```

## 4. Pull Request（PR）運用

### 4.1 PR作成のタイミング

- featureブランチからdevelopブランチへのマージ時
- releaseブランチからmainブランチへのマージ時
- hotfixブランチからmainブランチへのマージ時

### 4.2 PRテンプレート（推奨）

```markdown
## 概要
<!-- 変更内容の概要を記述 -->

## 変更内容
- [ ] 変更1
- [ ] 変更2

## テスト
- [ ] 単体テストを追加・更新
- [ ] 結合テストを追加・更新
- [ ] 手動テストを実施

## チェックリスト
- [ ] コードレビューを依頼
- [ ] ドキュメントを更新
- [ ] コミットメッセージが規約に準拠している
- [ ] マルチテナント分離のテストを実施
```

### 4.3 コードレビュー

- **必須**: mainブランチへのマージ時はコードレビュー必須
- **推奨**: developブランチへのマージ時もコードレビュー推奨
- **重点確認項目**:
  - マルチテナント分離の実装
  - セキュリティ（認証・認可、入力検証）
  - テストの実装状況

## 5. テスト実行のタイミングとブランチ

| テストレベル | 実行ブランチ | 実行タイミング | 説明 |
| :--- | :--- | :--- | :--- |
| **単体テスト** | `feature/phase-X` | 開発中（コミット時） | 機能実装と同時にテストを実装・実行。CI/CDで自動実行 |
| **結合テスト** | `feature/phase-X` | マージ前（Pull Request時） | featureブランチのマージ前に実行。CI/CDで自動実行 |
| **結合テスト** | `develop` | マージ後（定期的） | developブランチにマージ後、統合テストを実行 |
| **総合テスト** | `develop` | フェーズ完了時 | 各フェーズ完了時に、主要な業務シナリオを通しで確認 |
| **総合テスト** | `release/phase-X` | リリース準備時 | リリース準備ブランチで最終確認 |
| **負荷テスト** | `develop` または `release/phase-X` | フェーズ完了時 | パフォーマンス要件を満たしているか確認 |

## 6. テスト実行フロー

### 6.1 featureブランチでの開発中

```bash
# 単体テストを実行（開発中）
./gradlew test  # バックエンド
pnpm test       # フロントエンド

# コミット前に必ずテストを実行
git add .
git commit -m "feat: 機能実装とテスト追加"
```

### 6.2 Pull Request作成時（feature → develop）

CI/CDで自動実行されるテスト：

- 単体テスト（全テストスイート）
- 結合テスト（APIエンドポイント）
- コードカバレッジチェック
- リンター・フォーマッター

### 6.3 developブランチへのマージ後

developブランチで統合テストを実行：

- 結合テスト（全APIエンドポイント）
- マルチテナント分離のテスト
- データベース統合テスト

### 6.4 フェーズ完了時（developブランチ）

総合テストを実行：

- 主要な業務シナリオのE2Eテスト
- 打刻〜承認〜締め〜給与確定の一連の流れ
- 負荷テスト（必要に応じて）

### 6.5 リリース準備時（releaseブランチ）

最終確認のテスト：

- 総合テスト（全シナリオ）
- 回帰テスト（既存機能の動作確認）
- パフォーマンステスト

## 7. CI/CDパイプライン

### 7.1 GitHub Actions例

```yaml
# .github/workflows/ci.yml
name: CI

on:
  pull_request:
    branches: [develop, main]
  push:
    branches: [develop, main]

jobs:
  test-backend:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: auratime_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: 単体テスト
        run: ./gradlew test
      - name: 結合テスト
        run: ./gradlew integrationTest
      - name: コードカバレッジ
        run: ./gradlew jacocoTestReport

  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: インストール
        run: pnpm install
      - name: 単体テスト
        run: pnpm test
      - name: E2Eテスト
        run: pnpm test:e2e
      - name: リンター
        run: pnpm lint
```

### 7.2 保護ルール（推奨）

#### mainブランチ

- 直接プッシュ禁止（Pull Request必須）
- コードレビュー必須（最低1名）
- 全テストがパスしていること
- 総合テストがパスしていること
- ステータスチェックが全て成功していること

#### developブランチ

- 直接プッシュ可能（チーム内で合意した場合）
- またはPull Request推奨
- 結合テストがパスしていること
- ステータスチェックが全て成功していること

#### featureブランチ

- 単体テストがパスしていること（コミット前）
- Pull Request作成時は結合テストもパスしていること

## 8. タグ管理

### 8.1 バージョン番号

セマンティックバージョニング（Semantic Versioning）を使用：

```
v{MAJOR}.{MINOR}.{PATCH}
```

- **MAJOR**: 互換性のない変更
- **MINOR**: 後方互換性のある新機能追加
- **PATCH**: 後方互換性のあるバグ修正

### 8.2 タグ付けのタイミング

- フェーズ完了時: `v0.1.0`, `v0.2.0` など
- 緊急修正時: `v0.1.1`, `v0.1.2` など
- 本番リリース時: `v1.0.0` など

### 8.3 タグ付けの例

```bash
# フェーズ完了時のタグ付け
git tag -a v0.1.0 -m "Phase 0: 認証基盤完成"
git push origin v0.1.0

# 緊急修正時のタグ付け
git tag -a v0.1.1 -m "Hotfix: セキュリティ修正"
git push origin v0.1.1
```

## 9. 参考ドキュメント

- [開発順序](./300_概要.md): 開発フェーズの概要
- [開発ガイドライン](./311_開発ガイドライン.md): 進捗管理、リスク管理
- [.cursor/rules](../../.cursor/rules): コーディングルールとアーキテクチャ原則
