# Phase 0: 基盤構築（必須）

## 1. 目的

- 認証・認可の基盤を構築し、全ての機能の前提条件を整える
- マルチテナント分離の仕組みを確立
- 監査ログの自動記録機能を実装

## 2. 実装内容

### 2.1 データベースセットアップ

- [ ] マイグレーション実行（`database/migrations/20260101_init.sql`）
- [ ] UUID v7生成関数の確認
- [ ] 初期データ投入（`system-bot`ユーザーの作成）
- [ ] テスト用データの投入（開発環境）

### 2.2 認証・認可基盤（最優先）

#### バックエンド（Spring Boot）

- [ ] データベーステーブル作成
  - `t_user_invitations`テーブル（招待トークン管理）
  - `t_password_reset_tokens`テーブル（パスワードリセットトークン管理）
  - `m_companies.max_users`カラム追加（簡易ライセンス数管理）

- [ ] 招待トークン方式のユーザー登録
  - `POST /api/v1/invitations`（単一招待発行、Admin権限）
  - `GET /api/v1/auth/invitations/{token}`（招待情報取得、公開）
  - `POST /api/v1/auth/register`（招待トークン必須に変更）
  - 既存ユーザーと新規ユーザーの分岐処理
  - ライセンス数チェック（簡易版：`m_companies.max_users`を使用）
  - パスワードハッシュ化（bcrypt/Argon2）
  - バリデーション

- [ ] ログインAPI
  - `POST /api/v1/auth/login`
  - JWT発行（user_id, company_id, roleを含む）
  - トークン有効期限の設定

- [ ] パスワードリセット機能
  - `POST /api/v1/auth/password-reset/request`（リセット要求）
  - `POST /api/v1/auth/password-reset/confirm`（リセット実行）
  - パスワードリセットメール送信

- [ ] JWT検証ミドルウェア
  - トークンの検証
  - `company_id`の取得
  - ロールの取得

- [ ] 認可チェック
  - `@PreAuthorize`アノテーション（Spring Security）
  - ロールベースアクセス制御（RBAC）

- [ ] マルチテナント分離
  - グローバルフィルターで`company_id`を自動設定
  - 他社データへのアクセスを防止（403 Forbidden）

#### フロントエンド（Next.js）

- [ ] ログイン画面
  - メールアドレス・パスワード入力
  - 「パスワードを忘れた場合」リンク追加
  - エラーハンドリング

- [ ] パスワードリセット画面
  - メールアドレス入力フォーム
  - リセットトークン入力フォーム
  - 新パスワード設定フォーム

- [ ] ユーザー登録画面
  - 招待トークン入力欄
  - 既存ユーザーと新規ユーザーの分岐表示
  - 既存ユーザー：社員番号のみ入力
  - 新規ユーザー：氏名、カナ、パスワード入力

- [ ] 認証状態管理
  - JWTの保存（httpOnly cookie推奨）
  - 認証状態の確認
  - ログアウト機能

- [ ] 認証ガード
  - 未認証ユーザーのリダイレクト
  - 認証済みユーザーのみアクセス可能なページ

- [ ] PWA実装
  - Next.js公式のPWAサポートを活用
  - Service Workerの実装
  - 通知機能の実装（Push API）
  - オフライン対応（IndexedDB）

### 2.3 監査ログ基盤

- [ ] 監査ログの自動記録
  - Spring AOP（Spring Boot）
  - データ変更時の自動記録
  - `created_by`, `updated_by`の自動設定
  - `h_audit_logs`テーブルへの記録
- [ ] 監査ログAPI（参照用、後で実装でも可）
  - `GET /api/v1/audit-logs`
  - フィルタリング・検索機能

## 3. APIエンドポイント

| メソッド | エンドポイント | 権限 | 説明 |
| :--- | :--- | :--- | :--- |
| POST | `/api/v1/invitations` | Admin | 招待トークン発行（単一） |
| GET | `/api/v1/auth/invitations/{token}` | なし | 招待情報取得（公開） |
| POST | `/api/v1/auth/register` | なし | ユーザー登録（招待トークン必須） |
| POST | `/api/v1/auth/login` | なし | ログイン |
| POST | `/api/v1/auth/logout` | 認証済み | ログアウト |
| GET | `/api/v1/auth/me` | 認証済み | 現在のユーザー情報取得 |
| POST | `/api/v1/auth/password-reset/request` | なし | パスワードリセット要求 |
| POST | `/api/v1/auth/password-reset/confirm` | なし | パスワードリセット実行 |

## 4. テスト項目

- [ ] 招待トークン発行のテスト
  - 正常系：有効な招待トークン発行
  - 異常系：ライセンス数超過、無効なパラメータ
- [ ] ユーザー登録のテスト
  - 正常系：新規ユーザー登録（招待トークン使用）
  - 正常系：既存ユーザーの追加登録（招待トークン使用）
  - 異常系：無効な招待トークン、期限切れトークン
  - 異常系：重複メールアドレス、バリデーションエラー
  - 異常系：ライセンス数超過
- [ ] パスワードリセットのテスト
  - 正常系：パスワードリセット要求
  - 正常系：パスワードリセット実行
  - 異常系：無効なトークン、期限切れトークン
- [ ] ログインのテスト
  - 正常系：正しい認証情報でログイン
  - 異常系：間違った認証情報、存在しないユーザー
- [ ] JWT検証のテスト
  - 正常系：有効なトークンでアクセス
  - 異常系：無効なトークン、期限切れトークン
- [ ] マルチテナント分離のテスト
  - 正常系：自社データへのアクセス
  - 異常系：他社データへのアクセス拒否（403 Forbidden）
- [ ] 認可のテスト
  - 正常系：適切なロールでアクセス
  - 異常系：不適切なロールでアクセス拒否（403 Forbidden）

## 5. 完了基準

- [ ] 招待トークン方式のユーザー登録が正常に動作する
- [ ] 既存ユーザーと新規ユーザーの分岐処理が正しく動作する
- [ ] ライセンス数チェック（簡易版）が正しく動作する
- [ ] パスワードリセット機能が正常に動作する
- [ ] ユーザー登録・ログインが正常に動作する
- [ ] JWTが正しく発行・検証される
- [ ] マルチテナント分離が正しく動作する（他社データにアクセスできない）
- [ ] ロールベースアクセス制御が正しく動作する
- [ ] 監査ログが自動的に記録される
- [ ] 全てのテストがパスする

## 6. 依存関係

- データベースセットアップが完了していること
- UUID v7生成関数が動作していること

## 7. 参考ドキュメント

- [開発順序](./300_概要.md): 開発フェーズの概要
- [Git運用](./310_Git運用.md): ブランチ戦略、コミットメッセージ規約
- [API基本方針](../200_詳細設計/240_API.md): REST方針、認証、エラーハンドリング
- [セキュリティ設計](../200_詳細設計/260_セキュリティー.md): 認証認可、個人情報保護
