# 開発順序

## 1. 概要

本ドキュメントは、AuraTimeシステムの実装における推奨開発順序を定義します。
段階的な実装により、リスクを最小化し、早期に価値を提供することを目指します。

### 開発の原則

1. **認証機能を最初に実装**: 全ての機能の前提条件となるため、最初に実装する
2. **段階的な実装**: 各フェーズで動作するシステムを維持し、継続的に価値を提供
3. **マルチテナント分離の徹底**: 各機能で`company_id`の分離を確認し、セキュリティを確保
4. **テスト駆動開発**: 各機能でテストを実装し、品質を保証
5. **早期のフィードバック**: 各フェーズで動作確認を行い、問題を早期に発見

### Gitブランチ戦略

#### ブランチ構成

```
main (本番環境用)
  ├── develop (開発統合ブランチ)
  │   ├── feature/phase-0-auth (Phase 0: 認証基盤)
  │   ├── feature/phase-1-core (Phase 1: コア機能)
  │   ├── feature/phase-2-advanced (Phase 2: 高度な機能)
  │   ├── feature/phase-3-payroll (Phase 3: 給与機能)
  │   └── feature/phase-4-admin (Phase 4: 管理機能)
  └── release/phase-X (リリース準備ブランチ)
```

#### ブランチの役割

| ブランチ | 役割 | 説明 |
| :--- | :--- | :--- |
| **main** | 本番環境用 | 常にデプロイ可能な状態を保つ。タグでバージョン管理 |
| **develop** | 開発統合ブランチ | 各フェーズの機能を統合するブランチ。常に動作する状態を保つ |
| **feature/phase-X** | 機能開発ブランチ | 各フェーズの実装を行うブランチ |
| **release/phase-X** | リリース準備ブランチ | フェーズ完了時のリリース準備用（必要に応じて） |
| **hotfix/** | 緊急修正ブランチ | 本番環境の緊急修正用（mainから分岐、mainとdevelopにマージ） |

#### ブランチ運用フロー

1. **機能開発の開始**
   ```bash
   # developブランチからfeatureブランチを作成
   git checkout develop
   git pull origin develop
   git checkout -b feature/phase-0-auth
   ```

2. **開発中のコミット**
   ```bash
   # 機能を実装し、コミット
   git add .
   git commit -m "feat: ユーザー登録APIの実装"
   git push origin feature/phase-0-auth
   ```

3. **フェーズ完了時のマージ**
   ```bash
   # developブランチにマージ
   git checkout develop
   git pull origin develop
   git merge feature/phase-0-auth
   git push origin develop
   
   # featureブランチを削除（オプション）
   git branch -d feature/phase-0-auth
   git push origin --delete feature/phase-0-auth
   ```

4. **リリース準備（必要に応じて）**
   ```bash
   # releaseブランチを作成
   git checkout -b release/phase-0 develop
   # バグ修正、ドキュメント更新等
   git checkout main
   git merge release/phase-0
   git tag -a v0.1.0 -m "Phase 0: 認証基盤完成"
   git push origin main --tags
   
   # developにもマージ
   git checkout develop
   git merge release/phase-0
   git push origin develop
   ```

#### コミットメッセージ規約

Conventional Commits形式を使用：

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type**:
- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメントのみの変更
- `style`: コードの動作に影響しない変更（フォーマット等）
- `refactor`: リファクタリング
- `test`: テストの追加・修正
- `chore`: ビルドプロセスやツールの変更

**例**:
```
feat(auth): ユーザー登録APIの実装

- POST /api/v1/auth/register エンドポイントを追加
- パスワードハッシュ化（bcrypt）を実装
- バリデーションを追加

Closes #123
```

#### ブランチ命名規則

- **featureブランチ**: `feature/phase-{0-4}-{機能名}`
  - 例: `feature/phase-0-auth`, `feature/phase-1-time-clock`
- **releaseブランチ**: `release/phase-{0-4}`
  - 例: `release/phase-0`
- **hotfixブランチ**: `hotfix/{修正内容}`
  - 例: `hotfix/critical-security-fix`

#### テスト実行のタイミングとブランチ

| テストレベル | 実行ブランチ | 実行タイミング | 説明 |
| :--- | :--- | :--- | :--- |
| **単体テスト** | `feature/phase-X` | 開発中（コミット時） | 機能実装と同時にテストを実装・実行。CI/CDで自動実行 |
| **結合テスト** | `feature/phase-X` | マージ前（Pull Request時） | featureブランチのマージ前に実行。CI/CDで自動実行 |
| **結合テスト** | `develop` | マージ後（定期的） | developブランチにマージ後、統合テストを実行 |
| **総合テスト** | `develop` | フェーズ完了時 | 各フェーズ完了時に、主要な業務シナリオを通しで確認 |
| **総合テスト** | `release/phase-X` | リリース準備時 | リリース準備ブランチで最終確認 |
| **負荷テスト** | `develop` または `release/phase-X` | フェーズ完了時 | パフォーマンス要件を満たしているか確認 |

#### テスト実行フロー

1. **featureブランチでの開発中**
   ```bash
   # 単体テストを実行（開発中）
   ./gradlew test  # バックエンド
   pnpm test       # フロントエンド
   
   # コミット前に必ずテストを実行
   git add .
   git commit -m "feat: 機能実装とテスト追加"
   ```

2. **Pull Request作成時（feature → develop）**
   ```bash
   # CI/CDで自動実行されるテスト
   - 単体テスト（全テストスイート）
   - 結合テスト（APIエンドポイント）
   - コードカバレッジチェック
   - リンター・フォーマッター
   ```

3. **developブランチへのマージ後**
   ```bash
   # developブランチで統合テストを実行
   - 結合テスト（全APIエンドポイント）
   - マルチテナント分離のテスト
   - データベース統合テスト
   ```

4. **フェーズ完了時（developブランチ）**
   ```bash
   # 総合テストを実行
   - 主要な業務シナリオのE2Eテスト
   - 打刻〜承認〜締め〜給与確定の一連の流れ
   - 負荷テスト（必要に応じて）
   ```

5. **リリース準備時（releaseブランチ）**
   ```bash
   # 最終確認のテスト
   - 総合テスト（全シナリオ）
   - 回帰テスト（既存機能の動作確認）
   - パフォーマンステスト
   ```

#### CI/CDパイプライン例

```yaml
# .github/workflows/ci.yml の例
on:
  pull_request:
    branches: [develop, main]
  push:
    branches: [develop, main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: 単体テスト（バックエンド）
        run: ./gradlew test
      
      - name: 単体テスト（フロントエンド）
        run: pnpm test
      
      - name: 結合テスト
        run: ./gradlew integrationTest
      
      - name: E2Eテスト
        run: pnpm test:e2e
```

#### 保護ルール（推奨）

- **mainブランチ**: 
  - 直接プッシュ禁止（Pull Request必須）
  - コードレビュー必須
  - 全テストがパスしていること
  - 総合テストがパスしていること
- **developブランチ**:
  - 直接プッシュ可能（チーム内で合意した場合）
  - またはPull Request推奨
  - 結合テストがパスしていること
- **featureブランチ**:
  - 単体テストがパスしていること（コミット前）
  - Pull Request作成時は結合テストもパスしていること

## 2. 開発フェーズ概要

| フェーズ | 名称 | 期間目安 | 主要機能 |
| :--- | :--- | :--- | :--- |
| **Phase 0** | 基盤構築 | 2-3週間 | 認証・認可、監査ログ基盤 |
| **Phase 1** | コア機能（MVP） | 4-6週間 | 打刻、勤怠管理、マスタ管理 |
| **Phase 2** | 高度な機能 | 3-4週間 | 休暇管理、シフト管理、承認フロー |
| **Phase 3** | 給与機能 | 4-6週間 | 給与計算、明細管理、支払管理 |
| **Phase 4** | 管理・監査機能 | 2-3週間 | 監査ログ参照、ジョブ管理、システム管理 |

## 3. Phase 0: 基盤構築（必須）

### 3.1 目的
- 認証・認可の基盤を構築し、全ての機能の前提条件を整える
- マルチテナント分離の仕組みを確立
- 監査ログの自動記録機能を実装

### 3.2 実装内容

#### 3.2.1 データベースセットアップ
- [ ] マイグレーション実行（`database/migrations/20260101_init.sql`）
- [ ] UUID v7生成関数の確認
- [ ] 初期データ投入（`system-bot`ユーザーの作成）
- [ ] テスト用データの投入（開発環境）

#### 3.2.2 認証・認可基盤（最優先）

**バックエンド（Spring Boot）**
- [ ] ユーザー登録API
  - `POST /api/v1/auth/register`
  - パスワードハッシュ化（bcrypt/Argon2）
  - バリデーション
- [ ] ログインAPI
  - `POST /api/v1/auth/login`
  - JWT発行（user_id, company_id, roleを含む）
  - トークン有効期限の設定
- [ ] JWT検証ミドルウェア
  - トークンの検証
  - `company_id`の取得
  - ロールの取得
- [ ] 認可チェック
  - `@PreAuthorize`アノテーション（Spring Security）
  - ロールベースアクセス制御（RBAC）
- [ ] マルチテナント分離
  - グローバルフィルターで`company_id`を自動設定
  - 他社データへのアクセスを防止（403 Forbidden）

**フロントエンド（Next.js）**
- [ ] ログイン画面
  - メールアドレス・パスワード入力
  - エラーハンドリング
- [ ] 認証状態管理
  - JWTの保存（httpOnly cookie推奨）
  - 認証状態の確認
  - ログアウト機能
- [ ] 認証ガード
  - 未認証ユーザーのリダイレクト
  - 認証済みユーザーのみアクセス可能なページ

#### 3.2.3 監査ログ基盤
- [ ] 監査ログの自動記録
  - Spring AOP（Spring Boot）またはEvents/Listeners（Laravel）
  - データ変更時の自動記録
  - `created_by`, `updated_by`の自動設定
- [ ] 監査ログAPI（参照用、後で実装でも可）
  - `GET /api/v1/audit-logs`
  - フィルタリング・検索機能

### 3.3 APIエンドポイント

| メソッド | エンドポイント | 権限 | 説明 |
| :--- | :--- | :--- | :--- |
| POST | `/api/v1/auth/register` | なし | ユーザー登録 |
| POST | `/api/v1/auth/login` | なし | ログイン |
| POST | `/api/v1/auth/logout` | 認証済み | ログアウト |
| GET | `/api/v1/auth/me` | 認証済み | 現在のユーザー情報取得 |

### 3.4 テスト項目

- [ ] ユーザー登録のテスト
  - 正常系：新規ユーザー登録
  - 異常系：重複メールアドレス、バリデーションエラー
- [ ] ログインのテスト
  - 正常系：正しい認証情報でログイン
  - 異常系：間違った認証情報、存在しないユーザー
- [ ] JWT検証のテスト
  - 正常系：有効なトークンでアクセス
  - 異常系：無効なトークン、期限切れトークン
- [ ] マルチテナント分離のテスト
  - 正常系：自社データへのアクセス
  - 異常系：他社データへのアクセス拒否（403 Forbidden）
- [ ] 認可のテスト
  - 正常系：適切なロールでアクセス
  - 異常系：不適切なロールでアクセス拒否（403 Forbidden）

### 3.5 完了基準

- [ ] ユーザー登録・ログインが正常に動作する
- [ ] JWTが正しく発行・検証される
- [ ] マルチテナント分離が正しく動作する（他社データにアクセスできない）
- [ ] ロールベースアクセス制御が正しく動作する
- [ ] 監査ログが自動的に記録される
- [ ] 全てのテストがパスする

### 3.6 依存関係

- データベースセットアップが完了していること
- UUID v7生成関数が動作していること

## 4. Phase 1: コア機能（MVP）

### 4.1 目的
- 基本的な勤怠管理機能を実装し、MVP（Minimum Viable Product）を完成させる
- 従業員が打刻し、勤怠を確認できる機能を提供

### 4.2 実装内容

#### 4.2.1 マスタ管理（Admin）

**バックエンド**
- [ ] 会社設定管理
  - `GET /api/v1/companies/{id}`
  - `PATCH /api/v1/companies/{id}`
- [ ] グループ（組織）管理
  - `GET /api/v1/groups`
  - `POST /api/v1/groups`
  - `PATCH /api/v1/groups/{id}`
  - `DELETE /api/v1/groups/{id}`（ソフト削除）
- [ ] 従業員マスタ
  - `GET /api/v1/employees`
  - `POST /api/v1/employees`
  - `PATCH /api/v1/employees/{id}`
  - 従業員とユーザーの紐付け
- [ ] シフトテンプレート管理
  - `GET /api/v1/shift-templates`
  - `POST /api/v1/shift-templates`
  - `PATCH /api/v1/shift-templates/{id}`

**フロントエンド**
- [ ] 会社設定画面（System Admin）
- [ ] グループ管理画面（Admin）
- [ ] 従業員マスタ画面（Admin）
- [ ] シフトテンプレート管理画面（Admin）

#### 4.2.2 打刻機能（Employee）

**バックエンド**
- [ ] 打刻API
  - `POST /api/v1/time-clock/events`
  - `type`: `in`, `out`, `break_in`, `break_out`
  - `source`: `web`, `mobile`, `ic_card`, `admin`（注: `ic_card`は将来対応、初期実装では`web`と`mobile`のみ）
  - `company_id`, `employee_id`は自動設定
- [ ] 打刻履歴取得API
  - `GET /api/v1/time-clock/events`
  - クエリパラメータ：`start_date`, `end_date`, `type`
  - ページング対応

**フロントエンド**
- [ ] 打刻画面
  - 現在時刻の表示
  - 出勤・退勤・休憩入り・休憩戻りボタン
  - 打刻履歴の表示
- [ ] 打刻履歴一覧画面

#### 4.2.3 日次集計（自動計算）

**バックエンド**
- [ ] 日次集計ロジック
  - 打刻イベントから`t_time_records`を自動生成/更新
  - 労働時間の計算（法定内、残業、深夜、休憩）
  - シフトテンプレートとの照合
- [ ] 日次集計API
  - `GET /api/v1/time-records`
  - クエリパラメータ：`start_date`, `end_date`
  - ページング対応

**フロントエンド**
- [ ] 日次勤怠一覧画面
  - カレンダー表示
  - 日別の労働時間表示
  - 残業時間の表示

### 4.3 APIエンドポイント

| メソッド | エンドポイント | 権限 | 説明 |
| :--- | :--- | :--- | :--- |
| GET | `/api/v1/companies/{id}` | System Admin | 会社設定取得 |
| PATCH | `/api/v1/companies/{id}` | System Admin | 会社設定更新 |
| GET | `/api/v1/groups` | Admin | グループ一覧取得 |
| POST | `/api/v1/groups` | Admin | グループ作成 |
| PATCH | `/api/v1/groups/{id}` | Admin | グループ更新 |
| DELETE | `/api/v1/groups/{id}` | Admin | グループ削除 |
| GET | `/api/v1/employees` | Admin | 従業員一覧取得 |
| POST | `/api/v1/employees` | Admin | 従業員作成 |
| PATCH | `/api/v1/employees/{id}` | Admin | 従業員更新 |
| GET | `/api/v1/shift-templates` | Admin | シフトテンプレート一覧 |
| POST | `/api/v1/shift-templates` | Admin | シフトテンプレート作成 |
| POST | `/api/v1/time-clock/events` | Employee | 打刻イベント作成 |
| GET | `/api/v1/time-clock/events` | Employee | 打刻履歴取得 |
| GET | `/api/v1/time-records` | Employee | 日次勤怠一覧取得 |

### 4.4 テスト項目

- [ ] マスタ管理のテスト
  - グループの作成・更新・削除
  - 従業員の作成・更新
  - シフトテンプレートの作成
- [ ] 打刻機能のテスト
  - 出勤・退勤・休憩の打刻
  - 打刻履歴の取得
  - マルチテナント分離の確認
- [ ] 日次集計のテスト
  - 打刻イベントからの自動集計
  - 労働時間の計算（法定内、残業、深夜）
  - シフトテンプレートとの照合

### 4.5 完了基準

- [ ] 管理者がマスタデータを管理できる
- [ ] 従業員が打刻できる
- [ ] 打刻履歴を確認できる
- [ ] 日次集計が自動的に実行される
- [ ] 日次勤怠を確認できる
- [ ] 全てのテストがパスする

### 4.6 依存関係

- Phase 0が完了していること（認証・認可基盤）
- マスタデータが投入されていること（テスト用）

## 5. Phase 2: 高度な機能

### 5.1 目的
- 勤怠修正申請、休暇管理、シフト管理などの高度な機能を実装
- 承認フローを実装し、業務プロセスを完成させる

### 5.2 実装内容

#### 5.2.1 勤怠管理（修正申請・承認）

**バックエンド**
- [ ] 勤怠修正申請API
  - `PATCH /api/v1/time-records/{id}`
  - ステータス管理（`draft`, `submitted`, `approved`, `rejected`）
  - 承認済み・締め済みの場合は409 Conflict
- [ ] 承認API
  - `POST /api/v1/approval-requests/{id}/approve`
  - `POST /api/v1/approval-requests/{id}/reject`
  - 承認ルートの管理

**フロントエンド**
- [ ] 勤怠修正申請画面
- [ ] 承認待ち一覧画面（Manager）
- [ ] 承認画面

#### 5.2.2 休暇管理

**バックエンド**
- [ ] 休暇申請API
  - `POST /api/v1/leave-requests`
  - `GET /api/v1/leave-requests`
  - `PATCH /api/v1/leave-requests/{id}`
  - 残数管理
- [ ] 休暇タイプ管理
  - `GET /api/v1/leave-types`
  - `POST /api/v1/leave-types`

**フロントエンド**
- [ ] 休暇申請画面
- [ ] 休暇履歴画面
- [ ] 残数確認画面

#### 5.2.3 シフト管理

**バックエンド**
- [ ] シフト割当API
  - `GET /api/v1/shift-assignments`
  - `PUT /api/v1/shift-assignments/bulk`
  - 個人別・日別シフト割当
- [ ] シフト一覧API
  - `GET /api/v1/shifts`
  - カレンダー表示用

**フロントエンド**
- [ ] シフト作成・割当画面（Manager）
- [ ] シフト一覧画面（カレンダー表示）

#### 5.2.4 承認フロー（汎用化）

**バックエンド**
- [ ] 承認ルート設定
  - `GET /api/v1/approval-routes`
  - `POST /api/v1/approval-routes`
  - 多段承認の管理
- [ ] 承認ステップ管理
  - `GET /api/v1/approval-steps`
  - 承認ステップの進行状況管理

**フロントエンド**
- [ ] 承認ルート設定画面（Admin）
- [ ] 承認ステップ表示

### 5.3 APIエンドポイント

| メソッド | エンドポイント | 権限 | 説明 |
| :--- | :--- | :--- | :--- |
| PATCH | `/api/v1/time-records/{id}` | Employee | 勤怠修正申請 |
| GET | `/api/v1/approval-requests` | Manager | 承認待ち一覧取得 |
| POST | `/api/v1/approval-requests/{id}/approve` | Manager | 承認 |
| POST | `/api/v1/approval-requests/{id}/reject` | Manager | 却下 |
| POST | `/api/v1/leave-requests` | Employee | 休暇申請 |
| GET | `/api/v1/leave-requests` | Employee | 休暇履歴取得 |
| GET | `/api/v1/leave-types` | Employee | 休暇タイプ一覧 |
| GET | `/api/v1/shift-assignments` | Manager | シフト割当取得 |
| PUT | `/api/v1/shift-assignments/bulk` | Manager | シフト一括割当 |
| GET | `/api/v1/shifts` | Employee | シフト一覧取得 |
| GET | `/api/v1/approval-routes` | Admin | 承認ルート一覧 |
| POST | `/api/v1/approval-routes` | Admin | 承認ルート作成 |

### 5.4 テスト項目

- [ ] 勤怠修正申請のテスト
  - 修正申請の作成
  - 承認・却下の処理
  - 承認済み・締め済みの場合は409 Conflict
- [ ] 休暇管理のテスト
  - 休暇申請の作成
  - 残数の減算
  - 承認フローの動作
- [ ] シフト管理のテスト
  - シフト割当の作成
  - 一括割当の処理
  - シフト一覧の取得
- [ ] 承認フローのテスト
  - 多段承認の動作
  - 承認ステップの進行
  - 承認ルートの設定

### 5.5 完了基準

- [ ] 勤怠修正申請が正常に動作する
- [ ] 承認フローが正常に動作する
- [ ] 休暇申請が正常に動作する
- [ ] シフト管理が正常に動作する
- [ ] 全てのテストがパスする

### 5.6 依存関係

- Phase 1が完了していること（打刻機能、マスタ管理）
- 承認フローは休暇管理と勤怠管理の両方で使用される

## 6. Phase 3: 給与機能

### 6.1 目的
- 給与計算機能を実装し、給与明細の作成・確定・公開を行う
- 支払管理機能を実装し、振込データの出力を行う

### 6.2 実装内容

#### 6.2.1 給与計算基盤

**バックエンド**
- [ ] 給与期間管理
  - `GET /api/v1/payroll-periods`
  - `POST /api/v1/payroll-periods`
  - `PATCH /api/v1/payroll-periods/{id}`
  - ステータス管理（`open`, `closed`, `calculated`, `finalized`）
- [ ] 単価設定（h_compensation_plans）
  - `GET /api/v1/compensation-plans`
  - `POST /api/v1/compensation-plans`
  - `PATCH /api/v1/compensation-plans/{id}`
- [ ] 給与計算ロジック
  - 勤怠集計結果と単価設定に基づく計算
  - 支給項目・控除項目の計算
  - 社会保険料の計算（簡易版）

#### 6.2.2 給与計算・明細

**バックエンド**
- [ ] 給与計算ジョブ
  - `POST /api/v1/payroll-periods/{id}/calculate`
  - 非同期バッチ処理（Spring Batch）
  - ジョブ実行状況の管理（`t_job_runs`）
- [ ] 明細管理API
  - `GET /api/v1/payslips`
  - `PATCH /api/v1/payslips/{id}`
  - ステータス管理（`draft`, `confirmed`, `paid`）
- [ ] 明細確定・公開
  - `POST /api/v1/payslips/{id}/finalize`
  - 従業員への公開

**フロントエンド**
- [ ] 給与期間管理画面（Admin）
- [ ] 給与計算実行画面（Admin）
- [ ] 明細一覧画面（Admin）
- [ ] 明細確定画面（Admin）
- [ ] 給与明細確認画面（Employee）

#### 6.2.3 支払管理

**バックエンド**
- [ ] 支払バッチ作成API
  - `POST /api/v1/payments`
  - `GET /api/v1/payments`
  - FBデータ（振込データ）の生成
- [ ] 支払ステータス管理
  - `PATCH /api/v1/payments/{id}`
  - ステータス管理（`scheduled`, `processing`, `done`, `failed`）

**フロントエンド**
- [ ] 支払バッチ作成画面（Admin）
- [ ] 支払状況確認画面（Admin）
- [ ] FBデータ出力画面（Admin）

### 6.3 APIエンドポイント

| メソッド | エンドポイント | 権限 | 説明 |
| :--- | :--- | :--- | :--- |
| GET | `/api/v1/payroll-periods` | Admin | 給与期間一覧取得 |
| POST | `/api/v1/payroll-periods` | Admin | 給与期間作成 |
| PATCH | `/api/v1/payroll-periods/{id}` | Admin | 給与期間更新 |
| POST | `/api/v1/payroll-periods/{id}/calculate` | Admin | 給与計算実行 |
| GET | `/api/v1/compensation-plans` | Admin | 単価設定一覧 |
| POST | `/api/v1/compensation-plans` | Admin | 単価設定作成 |
| GET | `/api/v1/payslips` | Employee/Admin | 明細一覧取得 |
| PATCH | `/api/v1/payslips/{id}` | Admin | 明細更新 |
| POST | `/api/v1/payslips/{id}/finalize` | Admin | 明細確定 |
| POST | `/api/v1/payments` | Admin | 支払バッチ作成 |
| GET | `/api/v1/payments` | Admin | 支払一覧取得 |
| PATCH | `/api/v1/payments/{id}` | Admin | 支払ステータス更新 |

### 6.4 テスト項目

- [ ] 給与期間管理のテスト
  - 給与期間の作成・更新
  - 締め処理（`closed`）
  - 締め後のデータロック確認
- [ ] 給与計算のテスト
  - 給与計算ジョブの実行
  - 明細の生成
  - 計算結果の正確性
- [ ] 明細管理のテスト
  - 明細の作成・更新
  - 明細の確定・公開
  - 従業員への公開確認
- [ ] 支払管理のテスト
  - 支払バッチの作成
  - FBデータの生成
  - 支払ステータスの更新

### 6.5 完了基準

- [ ] 給与期間を管理できる
- [ ] 給与計算が正常に実行される
- [ ] 明細が正しく生成される
- [ ] 明細を確定・公開できる
- [ ] 支払バッチを作成できる
- [ ] FBデータを出力できる
- [ ] 全てのテストがパスする

### 6.6 依存関係

- Phase 1が完了していること（勤怠集計）
- Phase 2が完了していること（承認フロー）
- バッチ処理基盤（Spring Batch）が動作していること

## 7. Phase 4: 管理・監査機能

### 7.1 目的
- 監査ログ参照機能を実装し、データ変更履歴を確認できるようにする
- ジョブ管理機能を実装し、バッチ処理の状況を確認できるようにする
- システム管理機能を実装し、System Adminがシステム全体を管理できるようにする

### 7.2 実装内容

#### 7.2.1 監査ログ参照

**バックエンド**
- [ ] 監査ログ参照API
  - `GET /api/v1/audit-logs`
  - フィルタリング（`target_type`, `action`, `actor_user_id`）
  - 検索機能
  - ページング対応

**フロントエンド**
- [ ] 監査ログ一覧画面（Admin）
- [ ] 監査ログ詳細画面
- [ ] フィルタリング・検索機能

#### 7.2.2 ジョブ管理

**バックエンド**
- [ ] ジョブ実行状況取得API
  - `GET /api/v1/job-runs`
  - `GET /api/v1/job-runs/{id}`
  - ジョブ実行状況の取得
- [ ] ジョブ再実行API
  - `POST /api/v1/job-runs/{id}/retry`
  - 失敗したジョブの再実行

**フロントエンド**
- [ ] ジョブ実行状況一覧画面（Admin）
- [ ] ジョブ詳細画面
- [ ] ジョブ再実行画面

#### 7.2.3 システム管理（System Admin）

**バックエンド**
- [ ] 会社設定管理API
  - `GET /api/v1/companies`
  - `POST /api/v1/companies`
  - `PATCH /api/v1/companies/{id}`
- [ ] 契約・プラン管理API
  - `GET /api/v1/contracts`
  - `POST /api/v1/contracts`
  - `PATCH /api/v1/contracts/{id}`
- [ ] 全ユーザー・権限管理API
  - `GET /api/v1/users`
  - `PATCH /api/v1/users/{id}`
  - `PATCH /api/v1/company-memberships/{id}`

**フロントエンド**
- [ ] 会社設定管理画面（System Admin）
- [ ] 契約・プラン管理画面（System Admin）
- [ ] 全ユーザー・権限管理画面（System Admin）

### 7.3 APIエンドポイント

| メソッド | エンドポイント | 権限 | 説明 |
| :--- | :--- | :--- | :--- |
| GET | `/api/v1/audit-logs` | Admin | 監査ログ一覧取得 |
| GET | `/api/v1/job-runs` | Admin | ジョブ実行状況一覧取得 |
| GET | `/api/v1/job-runs/{id}` | Admin | ジョブ詳細取得 |
| POST | `/api/v1/job-runs/{id}/retry` | Admin | ジョブ再実行 |
| GET | `/api/v1/companies` | System Admin | 全会社一覧取得 |
| POST | `/api/v1/companies` | System Admin | 会社作成 |
| GET | `/api/v1/contracts` | System Admin | 契約一覧取得 |
| POST | `/api/v1/contracts` | System Admin | 契約作成 |
| GET | `/api/v1/users` | System Admin | 全ユーザー一覧取得 |
| PATCH | `/api/v1/users/{id}` | System Admin | ユーザー更新 |
| PATCH | `/api/v1/company-memberships/{id}` | System Admin | 権限更新 |

### 7.4 テスト項目

- [ ] 監査ログ参照のテスト
  - 監査ログ一覧の取得
  - フィルタリング・検索機能
  - ページング機能
- [ ] ジョブ管理のテスト
  - ジョブ実行状況の取得
  - ジョブ再実行の処理
- [ ] システム管理のテスト
  - 会社設定の管理
  - 契約・プランの管理
  - 全ユーザー・権限の管理

### 7.5 完了基準

- [ ] 監査ログを参照できる
- [ ] ジョブ実行状況を確認できる
- [ ] ジョブを再実行できる
- [ ] システム管理機能が正常に動作する
- [ ] 全てのテストがパスする

### 7.6 依存関係

- Phase 0が完了していること（監査ログ基盤）
- Phase 3が完了していること（ジョブ管理）
- システム管理機能は独立して実装可能

## 8. 進捗管理

### 8.1 マイルストーン

| マイルストーン | フェーズ | 完了基準 |
| :--- | :--- | :--- |
| **M1: 認証基盤完成** | Phase 0 | 認証・認可が正常に動作し、マルチテナント分離が確認できる |
| **M2: MVP完成** | Phase 1 | 従業員が打刻し、勤怠を確認できる |
| **M3: 業務プロセス完成** | Phase 2 | 勤怠修正申請、休暇申請、シフト管理が正常に動作する |
| **M4: 給与機能完成** | Phase 3 | 給与計算、明細管理、支払管理が正常に動作する |
| **M5: システム完成** | Phase 4 | 全ての機能が正常に動作し、システム管理機能が利用可能 |

### 8.2 各フェーズの完了基準

各フェーズは以下の条件を満たした時点で完了とします：

1. **機能要件**: そのフェーズで定義された全ての機能が実装されている
2. **テスト**: 全てのテストがパスしている
3. **ドキュメント**: API仕様書が更新されている
4. **コードレビュー**: コードレビューが完了している
5. **動作確認**: 動作確認が完了している

### 8.3 リスク管理

各フェーズで以下のリスクを想定し、対策を講じます：

| リスク | 影響度 | 対策 |
| :--- | :--- | :--- |
| 認証・認可の不備 | 高 | Phase 0で徹底的にテストし、セキュリティレビューを実施 |
| マルチテナント分離の不備 | 高 | 各フェーズでマルチテナント分離のテストを実施 |
| パフォーマンス問題 | 中 | 各フェーズでパフォーマンステストを実施 |
| データ整合性の問題 | 中 | トランザクション管理を徹底し、整合性チェックを実施 |

## 9. 開発時の注意事項

### 9.1 マルチテナント分離の徹底

- **常に確認**: 各APIエンドポイントで`company_id`が正しく設定されているか確認
- **テスト**: 他社データにアクセスできないことを必ずテストする
- **コードレビュー**: コードレビューでマルチテナント分離を重点的に確認

### 9.2 セキュリティ

- **認証・認可**: 全てのAPIエンドポイントで認証・認可を実装
- **入力検証**: 全ての入力値を検証する
- **SQLインジェクション対策**: プリペアドステートメントを使用
- **XSS対策**: フレームワーク標準の保護機能を有効化

### 9.3 パフォーマンス

- **インデックス**: クエリパフォーマンスを考慮したインデックス設計
- **N+1問題**: ORM利用時はEager Loadingを徹底
- **キャッシュ**: 頻繁に参照されるマスタデータはキャッシュを検討

### 9.4 テスト

- **単体テスト**: 各機能で単体テストを実装
- **統合テスト**: APIエンドポイントの統合テストを実装
- **E2Eテスト**: 主要なフローでE2Eテストを実装

## 10. 参考ドキュメント

- [基本設計](../100_基本設計/110_基本設計.md): 機能一覧、画面一覧、権限モデル
- [業務フロー](../100_基本設計/150_業務フロー.md): 勤怠から支払までのプロセス
- [API基本方針](../200_詳細設計/240_API.md): REST方針、認証、エラーハンドリング
- [API仕様_勤怠](../200_詳細設計/241_API_勤怠.md): 勤怠管理APIの詳細仕様
- [API仕様_休暇](../200_詳細設計/242_API_休暇.md): 休暇管理APIの詳細仕様
- [API仕様_承認](../200_詳細設計/243_API_承認.md): 承認フローAPIの詳細仕様
- [API仕様_給与](../200_詳細設計/244_API_給与.md): 給与管理APIの詳細仕様
- [DB設計方針](../200_詳細設計/221_DB設計.md): マルチテナント、ソフト削除、監査列
- [セキュリティ設計](../200_詳細設計/260_セキュリティー.md): 認証認可、個人情報保護
- [テスト設計](../400_テスト/400_テスト設計.md): テスト方針、重点テスト項目
