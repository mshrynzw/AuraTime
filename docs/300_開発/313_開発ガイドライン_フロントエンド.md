# 開発ガイドライン - フロントエンド（Next.js）

## 1. 概要

本ドキュメントは、AuraTimeシステムのフロントエンド開発（Next.js）における開発ガイドラインを定義します。

詳細な開発ガイドラインについては、[開発ガイドライン](./311_開発ガイドライン.md)を参照してください。

## 2. ハイドレーションエラーの防止

Next.jsのハイドレーションエラーを防ぐため、以下の原則を遵守してください：

### 2.1 原則1: サーバーとクライアントで同じHTMLを生成する

- サーバーサイドレンダリング（SSR）とクライアントサイドレンダリングで生成されるHTMLが一致する必要があります
- 条件分岐でサーバーとクライアントで異なる結果になるコードを避ける

### 2.2 原則2: ブラウザ専用APIの使用に注意

```typescript
// ❌ 悪い例：直接ブラウザAPIを使用
export default function Component() {
  const [mounted, setMounted] = useState(false);
  const userAgent = typeof window !== 'undefined' ? window.navigator.userAgent : '';

  return <div>{userAgent}</div>;
}

// ✅ 良い例：useEffectでクライアント側のみで処理
'use client';
export default function Component() {
  const [userAgent, setUserAgent] = useState('');

  useEffect(() => {
    setUserAgent(window.navigator.userAgent);
  }, []);

  return <div>{userAgent}</div>;
}
```

### 2.3 原則3: 日付・時刻の表示

```typescript
// ❌ 悪い例：サーバーとクライアントで異なる時刻が表示される
export default function Component() {
  return <div>{new Date().toLocaleString()}</div>;
}

// ✅ 良い例：useEffectでクライアント側のみで表示
'use client';
export default function Component() {
  const [currentTime, setCurrentTime] = useState<string>('');

  useEffect(() => {
    setCurrentTime(new Date().toLocaleString());
    const timer = setInterval(() => {
      setCurrentTime(new Date().toLocaleString());
    }, 1000);
    return () => clearInterval(timer);
  }, []);

  return <div>{currentTime || '--:--:--'}</div>;
}
```

### 2.4 原則4: ランダム値や動的な値の使用

```typescript
// ❌ 悪い例：サーバーとクライアントで異なる値が生成される
export default function Component() {
  const id = Math.random().toString(36);
  return <div id={id}>Content</div>;
}

// ✅ 良い例：useEffectでクライアント側のみで生成
'use client';
export default function Component() {
  const [id, setId] = useState<string>('');

  useEffect(() => {
    setId(Math.random().toString(36));
  }, []);

  return <div id={id || 'placeholder'}>Content</div>;
}
```

### 2.5 原則5: localStorage/sessionStorageの使用

```typescript
// ❌ 悪い例：直接localStorageにアクセス
export default function Component() {
  const theme = localStorage.getItem('theme') || 'light';
  return <div className={theme}>Content</div>;
}

// ✅ 良い例：useEffectでクライアント側のみでアクセス
'use client';
export default function Component() {
  const [theme, setTheme] = useState<string>('light');

  useEffect(() => {
    setTheme(localStorage.getItem('theme') || 'light');
  }, []);

  return <div className={theme}>Content</div>;
}
```

### 2.6 原則6: suppressHydrationWarningの使用

- `suppressHydrationWarning`は最後の手段として使用
- 使用する場合は、なぜ必要なのかコメントで説明する
- 日付・時刻表示など、サーバーとクライアントで意図的に異なる値を表示する場合のみ使用

```typescript
// ✅ 適切な使用例：時刻表示でサーバーとクライアントで異なる値が意図的
export default function Component() {
  // サーバー側では初期値、クライアント側ではリアルタイム更新
  return (
    <div suppressHydrationWarning>
      {new Date().toLocaleTimeString()}
    </div>
  );
}
```

### 2.7 原則7: クライアントコンポーネントの適切な使用

- ブラウザ専用APIを使用する場合は、必ず`'use client'`ディレクティブを使用
- サーバーコンポーネントとクライアントコンポーネントを適切に分離

```typescript
// ✅ 良い例：クライアントコンポーネントとして分離
'use client';
import { useEffect, useState } from 'react';

export default function ClientOnlyComponent() {
  const [data, setData] = useState<string>('');

  useEffect(() => {
    // ブラウザ専用APIを使用
    setData(window.location.href);
  }, []);

  return <div>{data}</div>;
}
```

### 2.8 原則8: 条件付きレンダリング

```typescript
// ❌ 悪い例：サーバーとクライアントで異なる条件になる可能性
export default function Component() {
  const isClient = typeof window !== 'undefined';
  return isClient ? <ClientComponent /> : <ServerComponent />;
}

// ✅ 良い例：useState + useEffectでクライアント側のみで条件分岐
'use client';
export default function Component() {
  const [isClient, setIsClient] = useState(false);

  useEffect(() => {
    setIsClient(true);
  }, []);

  if (!isClient) {
    return <div>Loading...</div>; // または null
  }

  return <ClientComponent />;
}
```

## 3. チェックリスト

コンポーネント実装時は以下を確認してください：

- [ ] サーバーとクライアントで同じHTMLが生成されるか
- [ ] ブラウザ専用API（window, localStorage等）は`useEffect`内で使用しているか
- [ ] 日付・時刻表示はクライアント側のみで更新しているか
- [ ] ランダム値や動的な値はクライアント側のみで生成しているか
- [ ] `'use client'`ディレクティブが適切に使用されているか
- [ ] `suppressHydrationWarning`を使用する場合は理由をコメントで説明しているか

## 4. よくある問題と対処法

| 問題 | 原因 | 対処法 |
| :--- | :--- | :--- |
| ハイドレーションエラー | サーバーとクライアントで異なるHTML | `useEffect`でクライアント側のみで処理 |
| 時刻がずれる | サーバーとクライアントで異なる時刻 | クライアント側のみで時刻を表示 |
| localStorageエラー | サーバー側でlocalStorageにアクセス | `useEffect`内でアクセス |
| ランダム値が異なる | サーバーとクライアントで異なる値 | クライアント側のみで生成 |

## 5. 参考ドキュメント

- [開発ガイドライン](./311_開発ガイドライン.md): 全般的な開発ガイドライン
- [開発順序](./300_概要.md): 開発フェーズの概要
- [Git運用](./310_Git運用.md): ブランチ戦略、コミットメッセージ規約
